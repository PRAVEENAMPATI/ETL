{% macro MART_CUSTOMER_HIST_FULLREFRESH() -%}
 {################# Step 1 DECLARE SCRIPTS/DDL NEED TO EXECUTED #################}
{%- set v_scripts -%} 
-- create temp table 
CREATE or REPLACE TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST_TEMP (
	CUSTOMER_KEY VARCHAR(32),
	CUSTOMER_CODE VARCHAR(16777216),
	ERP_SITE_USE_ID NUMBER(22,0),
	ERP_STATUS VARCHAR(1024),
	CRM_CUSTOMER_OID NUMBER(38,0),
	CRM_STATUS VARCHAR(255),
	CUSTOMER_NAME VARCHAR(16777216),
	CUSTOMER_TYPE_CODE VARCHAR(150),
	CUSTOMER_TYPE_DESCRIPTION VARCHAR(480),
	CUSTOMER_SOURCE VARCHAR(16777216),
	BUSINESS_CLASS_CODE VARCHAR(1024),
	CORPORATION_CODE VARCHAR(80),
	CORPORATION_DESCRIPTION VARCHAR(500),
	END_CORPORATION_CODE VARCHAR(1024),
	END_CORPORATION_DESCRIPTION VARCHAR(360),
	SALES_ORGANIZATION_CODE VARCHAR(16777216),
	END_USE_CODE VARCHAR(1024),
	END_USE_DESCRIPTION VARCHAR(1024),
	CURRENCY_CODE VARCHAR(16777216),
	ISO_CURRENCY_CODE VARCHAR(16777216),
	HAS_CREDIT_HOLD BOOLEAN,
	HAS_SERVICE_HOLD BOOLEAN,
	HAS_APPROVAL BOOLEAN,
	ORDER_PROCESSING_REGION_CODE VARCHAR(16777216),
	CRD_SHIP_EARLY_DAYS_QUANTITY NUMBER(22,0),
	HAS_CRD_PARTIAL BOOLEAN,
	SHIP_VIA_CODE VARCHAR(12),
	HAS_SHIP_TO_CRD BOOLEAN,
	SHIP_LATE_DAYS_QUANTITY NUMBER(22,0),
	BILL_CUSTOMER_CODE VARCHAR(40),
	HANDLING_METHOD_CODE VARCHAR(4000),
	HANDLING_METHOD_CODE_DESCRIPTION VARCHAR(500),
	IS_EDI_CUSTOMER BOOLEAN,
	FINAL_DESTINATION_DESCRIPTION VARCHAR(56),
	BILL_COUNTRY_SOURCE_CODE VARCHAR(150),
	FOB_OPTION_CODE VARCHAR(4000),
	PAYMENT_TERM_CODE VARCHAR(150),
	FINANCIAL_BANK_ID VARCHAR(150),
	TRANSIT_DAYS_QUANTITY VARCHAR(150),
	DELIVERY_TYPE_CODE VARCHAR(20),
	DATE_CODE_MAXIMUM_AGE_QUANTITY NUMBER(22,0),
	IS_CPN_REQUIRED BOOLEAN,
	VAT_TAX_CODE VARCHAR(4000),
	MINIMUM_DOLLAR_VALUE_AMOUNT VARCHAR(4000),
	IS_MINIMUM_DOLLAR_VALUE_VALID BOOLEAN,
	CORPORATION_CATEGORY_CODE VARCHAR(16777216),
	CORPORATION_CATEGORY_DESCRIPTION VARCHAR(16777216),
	CUSTOMER_ENTITY_CODE VARCHAR(360),
	FORECAST_TYPE_CODE VARCHAR(300),
	IS_FORECAST_CUSTOMER BOOLEAN,
	FORECAST_CUSTOMER_STATUS_CODE VARCHAR(105),
	REPLENISHMENT_CODE VARCHAR(5),
	SERVICE_TYPE_CODE VARCHAR(150),
	CHANGE_ORDER_APROVAL_REQUIRED_CODE VARCHAR(4000),
	UDC_GENERIC_PROG_DESCRIPTION VARCHAR(100),
	CREATE_BY_ID VARCHAR(100),
	CREATE_DTTM TIMESTAMP_NTZ(9),
	LAST_UPDATE_BY_ID VARCHAR(100),
	LAST_UPDATE_DTTM TIMESTAMP_NTZ(9),
	IS_DELETED BOOLEAN,
	QUALITY_CODE VARCHAR(150),
	FISCAL_ACCOUNT_NUMBER VARCHAR(50),
	CREDIT_LIMIT_AMOUNT NUMBER(22,0),
	DIVISION VARCHAR(16777216),
	SALES_STRUCTURE VARCHAR(1024),
	MARKET_SEGMENT_CODE VARCHAR(80),
	IS_ASSEMBLY_LOCATION BOOLEAN,
	OPERATING_UNIT VARCHAR(240),
	COF_CODE VARCHAR(90),
	COG_CODE VARCHAR(80),
	CUSTOMER_SHUT_DOWN_FROM_DATE DATE,
	CUSTOMER_SHUT_DOWN_TO_DATE DATE,
	FOB_OPTION_DESCRIPTION VARCHAR(4000),
	TAX_CODE VARCHAR(50),
	ORACLE_ORDER_TYPE VARCHAR(30),
	ORACLE_PAYMENT_TERM VARCHAR(15),
	ORACLE_SITE_STATUS VARCHAR(40),
	ORACLE_SITE_NUMBER VARCHAR(30),
	ORACLE_SHIP_METHOD VARCHAR(30),
	FREE_TRADE_ZONE VARCHAR(150),
	COLLECTOR_NAME VARCHAR(100),
	IS_SHUTDOWN BOOLEAN,
	CSR_USER_ID VARCHAR(85),
	CSR_FIRST_NAME VARCHAR(960),
	CSR_LAST_NAME VARCHAR(960),
	CSR_EMAIL VARCHAR(2000),
	CSR_PHONE VARCHAR(50),
	CSR_CONTACT_LAST_UPDATE_BY VARCHAR(100),
	CSR_CONTACT_CREATED_BY VARCHAR(100),
	FQA_USER_ID VARCHAR(30),
	FQA_FIRST_NAME VARCHAR(960),
	FQA_LAST_NAME VARCHAR(960),
	FQA_EMAIL VARCHAR(2000),
	FQA_PHONE VARCHAR(50),
	FQA_CONTACT_LAST_UPDATE_BY VARCHAR(100),
	FQA_CONTACT_CREATED_BY VARCHAR(100),
	BUYER_USER_ID VARCHAR(30),
	BUYER_FIRST_NAME VARCHAR(960),
	BUYER_LAST_NAME VARCHAR(960),
	BUYER_EMAIL VARCHAR(2000),
	BUYER_PHONE VARCHAR(50),
	BUYER_CONTACT_LAST_UPDATE_BY VARCHAR(100),
	BUYER_CONTACT_CREATED_BY VARCHAR(100),
	FSE_USER_ID VARCHAR(85),
	FSE_FIRST_NAME VARCHAR(150),
	FSE_LAST_NAME VARCHAR(150),
	FSE_EMAIL VARCHAR(2000),
	FSE_PHONE VARCHAR(80),
	FSE_CONTACT_LAST_UPDATE_BY VARCHAR(100),
	FSE_CONTACT_CREATED_BY VARCHAR(100),
    SHIP_ADDRESS_LINE1 VARCHAR(16777216),
	SHIP_ADDRESS_LINE2 VARCHAR(16777216),
	SHIP_ADDRESS_LINE3 VARCHAR(16777216),
	SHIP_ADDRESS_LINE4 VARCHAR(16777216),
	SHIP_ADDRESS_POSTAL_CODE VARCHAR(16777216),
	SHIP_ADDRESS_COUNTRY_CODE VARCHAR(16777216),
	SHIP_ADDRESS_COUNTRY_NAME VARCHAR(16777216),
	SHIP_ADDRESS_STATE VARCHAR(16777216),
	SHIP_ADDRESS_CITY VARCHAR(16777216),
	BILL_ADDRESS_LINE1 VARCHAR(16777216),
	BILL_ADDRESS_LINE2 VARCHAR(16777216),
	BILL_ADDRESS_LINE3 VARCHAR(16777216),
	BILL_ADDRESS_LINE4 VARCHAR(16777216),
	BILL_ADDRESS_POSTAL_CODE VARCHAR(16777216),
	BILL_ADDRESS_COUNTRY_CODE VARCHAR(16777216),
	BILL_ADDRESS_COUNTRY_NAME VARCHAR(16777216),
	BILL_ADDRESS_STATE VARCHAR(16777216),
	BILL_ADDRESS_CITY VARCHAR(16777216),
	BIW_INS_DTTM TIMESTAMP_NTZ(9),
	BIW_UPD_DTTM TIMESTAMP_NTZ(9),
	BIW_BATCH_ID NUMBER(38,0),
	BIW_MD5_KEY BINARY(8388608),
	DBT_SCD_ID VARCHAR(32),
	DBT_UPDATED_AT DATE,
	DBT_VALID_FROM DATE,
	DBT_VALID_TO DATE
);
-- load history data into temp table 
INSERT INTO {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST_TEMP
SELECT
CUSTOMER_KEY,
CUSTOMER_CODE,
ERP_SITE_USE_ID,
ERP_STATUS,
CRM_CUSTOMER_OID,
CRM_STATUS,
CUSTOMER_NAME,
CUSTOMER_TYPE_CODE,
CUSTOMER_TYPE_DESCRIPTION,
CUSTOMER_SOURCE,
BUSINESS_CLASS_CODE,
CORPORATION_CODE,
CORPORATION_DESCRIPTION,
END_CORPORATION_CODE,
END_CORPORATION_DESCRIPTION,
SALES_ORGANIZATION_CODE,
END_USE_CODE,
END_USE_DESCRIPTION,
CURRENCY_CODE,
ISO_CURRENCY_CODE,
HAS_CREDIT_HOLD,
HAS_SERVICE_HOLD,
HAS_APPROVAL,
ORDER_PROCESSING_REGION_CODE,
CRD_SHIP_EARLY_DAYS_QUANTITY,
HAS_CRD_PARTIAL,
SHIP_VIA_CODE,
HAS_SHIP_TO_CRD,
SHIP_LATE_DAYS_QUANTITY,
BILL_CUSTOMER_CODE,
HANDLING_METHOD_CODE,
HANDLING_METHOD_CODE_DESCRIPTION,
IS_EDI_CUSTOMER,
FINAL_DESTINATION_DESCRIPTION,
BILL_COUNTRY_SOURCE_CODE,
FOB_OPTION_CODE,
PAYMENT_TERM_CODE,
FINANCIAL_BANK_ID,
TRANSIT_DAYS_QUANTITY,
DELIVERY_TYPE_CODE,
DATE_CODE_MAXIMUM_AGE_QUANTITY,
IS_CPN_REQUIRED,
VAT_TAX_CODE,
MINIMUM_DOLLAR_VALUE_AMOUNT,
IS_MINIMUM_DOLLAR_VALUE_VALID,
CORPORATION_CATEGORY_CODE,
CORPORATION_CATEGORY_DESCRIPTION,
CUSTOMER_ENTITY_CODE,
FORECAST_TYPE_CODE,
IS_FORECAST_CUSTOMER,
FORECAST_CUSTOMER_STATUS_CODE,
REPLENISHMENT_CODE,
SERVICE_TYPE_CODE,
CHANGE_ORDER_APROVAL_REQUIRED_CODE,
UDC_GENERIC_PROG_DESCRIPTION,
CREATE_BY_ID,
CREATE_DTTM,
LAST_UPDATE_BY_ID,
LAST_UPDATE_DTTM,
IS_DELETED,
QUALITY_CODE,
FISCAL_ACCOUNT_NUMBER,
CREDIT_LIMIT_AMOUNT,
DIVISION,
SALES_STRUCTURE,
MARKET_SEGMENT_CODE,
IS_ASSEMBLY_LOCATION,
OPERATING_UNIT,
COF_CODE,
COG_CODE,
CUSTOMER_SHUT_DOWN_FROM_DATE,
CUSTOMER_SHUT_DOWN_TO_DATE,
FOB_OPTION_DESCRIPTION,
TAX_CODE,
ORACLE_ORDER_TYPE,
ORACLE_PAYMENT_TERM,
ORACLE_SITE_STATUS,
ORACLE_SITE_NUMBER,
ORACLE_SHIP_METHOD,
FREE_TRADE_ZONE,
COLLECTOR_NAME,
IS_SHUTDOWN,
CSR_USER_ID,
CSR_FIRST_NAME,
CSR_LAST_NAME,
CSR_EMAIL,
CSR_PHONE,
CSR_CONTACT_LAST_UPDATE_BY,
CSR_CONTACT_CREATED_BY,
FQA_USER_ID,
FQA_FIRST_NAME,
FQA_LAST_NAME,
FQA_EMAIL,
FQA_PHONE,
FQA_CONTACT_LAST_UPDATE_BY,
FQA_CONTACT_CREATED_BY,
BUYER_USER_ID,
BUYER_FIRST_NAME,
BUYER_LAST_NAME,
BUYER_EMAIL,
BUYER_PHONE,
BUYER_CONTACT_LAST_UPDATE_BY,
BUYER_CONTACT_CREATED_BY,
FSE_USER_ID,
FSE_FIRST_NAME,
FSE_LAST_NAME,
FSE_EMAIL,
FSE_PHONE,
FSE_CONTACT_LAST_UPDATE_BY,
FSE_CONTACT_CREATED_BY,
NULL AS SHIP_ADDRESS_LINE1,
NULL AS SHIP_ADDRESS_LINE2,
NULL AS SHIP_ADDRESS_LINE3,
NULL AS SHIP_ADDRESS_LINE4,
NULL AS SHIP_ADDRESS_POSTAL_CODE,
NULL AS SHIP_ADDRESS_COUNTRY_CODE,
NULL AS SHIP_ADDRESS_COUNTRY_NAME,
NULL AS SHIP_ADDRESS_STATE,
NULL AS SHIP_ADDRESS_CITY,
NULL AS BILL_ADDRESS_LINE1,
NULL AS BILL_ADDRESS_LINE2,
NULL AS BILL_ADDRESS_LINE3,
NULL AS BILL_ADDRESS_LINE4,
NULL AS BILL_ADDRESS_POSTAL_CODE,
NULL AS BILL_ADDRESS_COUNTRY_CODE,
NULL AS BILL_ADDRESS_COUNTRY_NAME,
NULL AS BILL_ADDRESS_STATE,
NULL AS BILL_ADDRESS_CITY,
BIW_INS_DTTM,
BIW_UPD_DTTM,
BIW_BATCH_ID,
BIW_MD5_KEY,
DBT_SCD_ID,
DBT_UPDATED_AT,
DBT_VALID_FROM,
DBT_VALID_TO
FROM 
{{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST;


-- rename temp table to current
ALTER TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST_TEMP
SWAP WITH {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST;

{%endset%}

{################# Step 2 EXECUTE SCRIPTS #################}
{% do run_query(v_scripts) %}

{################# Step 3 CAPTURE INTO DBT TABLE #################}
Insert into var('V_EDL_DEFAULT_DB')+env_var('DBT_DEP_ENV').UTILITY_DBT.DBT_SNOWFLAKE_DDL_EXECUTION
SELECT 
    684835 AS PCCT_NUMBER  ,
    '{{v_scripts|replace("'","''")}}' AS DDL_EXECUTED ,
    'VINAY.SUBRAMANIAN' AS BIW_CREATED_BY,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_CREATED_DTTM,
    'VINAY.SUBRAMANIAN' AS BIW_UPD_BY ,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_UPD_DTTM
{% endmacro %}