{% macro PCCT_656650() -%}
 {################# Step 1 DECLARE SCRIPTS/DDL NEED TO EXECUTED #################}
{%- set v_scripts -%} 

CREATE OR REPLACE TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT_PV20230209 CLONE 
 {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT;

DROP TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT;

CREATE TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT AS
SELECT 
FUNNEL_KEY,
SNAPSHOT_DATE_KEY,
DIRECT_CUSTOMER_KEY,
INDIRECT_CUSTOMER_KEY,
END_CUSTOMER_KEY,
DIRECT_CORPORATION_KEY,
INDIRECT_CORPORATION_KEY,
END_CORPORATION_KEY,
MARKET_PRODUCT_NUMBER_KEY,
INTERNAL_PART_NUMBER_KEY,
PRODUCTION_DATE_KEY,
DESIGN_REGISTRATION_KEY,
DESIGN_PART_MAPPING_KEY,
DECISION_DAY_KEY,
DESIGN_IN_DAY_KEY,
ACTION_DAY_KEY,
DIRECT_CUSTOMER_CODE,
INDIRECT_CUSTOMER_CODE,
END_CUSTOMER_CODE,
DIRECT_CORPORATION_CODE,
INDIRECT_CORPORATION_CODE,
END_CORPORATION_CODE,
MARKET_PRODUCT_NUMBER,
INTERNAL_PART_NUMBER,
TRANSACTION_DATE,
DECISION_DATE,
ACTION_DATE,
DESIGN_IN_DATE,
QUANTITY_PER_SYSTEM,
EXCHANGE_RATE,
TARGET_PRICE_USD,
NRE_USD,
DESIGN_REVENUE,
DESIGN_REVENUE_SHARE,
CONFIDENCE,
ONSHARE,
COMMISSIONABLE_NRE_USD,
COMMISSIONABLE_THREE_YEAR_REVENUE_USD,
THREE_YEAR_REVENUE,
LIFETIME_REVENUE,
NEW_BUSINESS_COMMIT_PCT,
COST_TO_DEV_USD,
ITEM_NUMBER,
OPERATIONAL_ASP,
REF_PRICE,
SIP_MULTIPLIER,
REGISTRATION_COST_ESTIMATE,
BU_PRICE,
TRANSACTION_CURRENCY_ISO_CODE,
PROJECT_VALUE_OVER_LIFETIME,
ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE,
CREATED_DATE,
MODIFIED_DATE,
PROTOTYPE_DATE,
SOCKET_STATUS_CHANGE_DATE,
REGISTRATION_ITEM_REQUEST_DATE,
REGISTRATION_ITEM_REVIEW_DATE,
REGISTRATION_ITEM_EXPIRE,
VALIDATED_DATE,
COMMISSION_WIN_DATE,
BLUESHEET_FIRST_ADD_DATE,
BLUESHEET_UPDATED_DATE,
SAMPLES_REQUIRED_DATE,
SEGMENT_MUSTWIN_SET_DATE,
EXEC_MUSTWIN_SET_DATE,
VP_MUSTWIN_SET_DATE,
CLAIM_WIN_DATE,
NEXT_MILESTONE_DATE,
OPPORTUNITY_DECISION_DATE,
BU_START_DATE,
BU_END_DATE,
ORIGINAL_APPROVAL_DATE,
ORIGINAL_DISPOSITION_DATE,
PROJECT_MODIFIED_DATE,
BU_DESIGN_IN_REQUEST_DATE,
IS_PART_ACTIVE,
IS_PRIMARY_OPN,
IS_OPPORTUNITY,
IS_REFERENCE_DESIGN,
IS_MUSTWIN,
IS_SEGMENT_MUSTWIN,
IS_EXECMUSTWIN,
IS_VPNMUSTWIN,
IS_DSM_REVIEW,
IS_BOM_EXPANSION,
IS_SUNSET,
IS_NPI,
CREATED_BY,
MODIFIED_BY,
OPPORTUNITY_NUMBER,
OPPORTUNITY_LIFECYCLE_STATUS,
DESIGN_TYPE,
CHANNEL_TYPE,
CHANNEL,
FSE,
FAE,
PRODUCT_MARKETER,
SEC_INVOLVEMENT,
PROGRAM_STATUS,
PROGRAM_NAME,
BOARD_NAME,
ESTIMATED_ANNUAL_BOARDS,
PART_TYPE,
LINE_DESCRIPTION,
SALES_SOCKET_STATUS,
CORPORATION_SOCKET_STATUS,
SEGMENT,
APPLICATION,
REGISTRATION_NUMBER,
ACTION_NOTES,
OPPORTUNITY_COMMENTS,
DISTRIBUTOR_NAME,
DISTRIBUTOR_BRANCH_NAME,
REGISTRATION_ITEM_REVIEWBY,
REGISTRATION_ITEM_STATUS,
REGISTRATION_ITEM_CANCEL_REJECT_REASON,
DISTRIBUTOR_FSE,
DISTRIBUTOR_FAE,
COMMISSION_UPDATED_BY,
COMMISSION_NOTES,
BLUE_SHEET_REQUIRED,
BLUE_SHEET_URL,
BU_STATUS,
BU_COMMENT,
CROSS_SELL_TYPE,
COMPETITION,
RYG_STATUS,
SWAT_TEAM,
REGISTRATION_ITEM_NUMBER,
DESIGN_STATUS,
BU_ACTION_NOTES,
BU_DESIGN_IN_REQUEST,
POS50K_2M_REGOWNER,
POS2MPLUS_REGOWNER,
POS50K_2M_NON_REGOWNER,
POS2MPLUS_NON_REGOWNER,
REBATE_NOTES,
REFERENCE_OPPORTUNITY_NUMBER,
DESIGN_IN_APPROVER,
BU_MARKETER_APPROVAL,
BU_MARKETER_APPROVER_ID,
BU_MARKETER_APPROVER_NAME,
DISTRIBUTOR_PROJECT_REF,
DISTRIBUTOR_DEVICE_REF,
BLOCK_DIAGRAM_COMPLETE,
OPPORTUNITY_REGISTRATION_TYPE,
TRANSFER_STATUS,
DISTRIBUTOR_NOTES,
SPLIT_REVIEW_STATUS,
LOW_MARGIN_EXCEPTION,
MARGIN_BUCKET,
NPI_STATUS,
NPI_NUMBER,
NPD_PROJECT_NUMBER,
OPPORTUNITY_LINE_CONTACT,
SIP_REASON,
DESIGNWIN_REQUEST_STATUS,
CATCHUP_REG,
EFFORT_TIER,
PRODUCT_TIER,
DESIGNIN_DESIGNWIN_APPROVER,
SOURCE_SYSTEM,
CREATED_ESTIMATED_ANNUAL_BOARDS,
CREATED_QUANTITY_PER_SYSTEM,
CREATED_TARGET_PRICE_USD,
CREATED_DESIGN_REVENUE_SHARE,
CREATED_ONSHARE,
CREATED_PROJECT_VALUE_OVER_LIFETIME,
DIN_ESTIMATED_ANNUAL_BOARDS,
DIN_QUANTITY_PER_SYSTEM,
DIN_TARGET_PRICE_USD,
DIN_DESIGN_REVENUE_SHARE,
DIN_ONSHARE,
CASE WHEN DIN_PROJECT_VALUE_OVER_LIFETIME IS NOT NULL 
    THEN PROJECT_VALUE_OVER_LIFETIME/EXCHANGE_RATE
END AS DIN_PROJECT_VALUE_OVER_LIFETIME,
DWIN_ESTIMATED_ANNUAL_BOARDS,
DWIN_QUANTITY_PER_SYSTEM,
DWIN_TARGET_PRICE_USD,
DWIN_DESIGN_REVENUE_SHARE,
DWIN_ONSHARE,
CASE WHEN DWIN_PROJECT_VALUE_OVER_LIFETIME IS NOT NULL 
    THEN PROJECT_VALUE_OVER_LIFETIME/EXCHANGE_RATE
END AS DWIN_PROJECT_VALUE_OVER_LIFETIME,
BIW_INS_DTTM,
BIW_UPD_DTTM,
BIW_BATCH_ID,
'N'::BOOLEAN AS BIW_LOGICAL_DELETE_FLAG,
BIW_MD5_KEY
FROM {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT_PV20230209;

{%endset%}

{################# Step 2 EXECUTE SCRIPTS #################}
{% do run_query(v_scripts) %}

{################# Step 3 CAPTURE INTO DBT TABLE #################}
Insert into var('V_EDL_DEFAULT_DB')+env_var('DBT_DEP_ENV').UTILITY_DBT.DBT_SNOWFLAKE_DDL_EXECUTION
SELECT 
    656650 AS PCCT_NUMBER  ,
    '{{v_scripts|replace("'","''")}}' AS DDL_EXECUTED ,
    'VINAY.SUBRAMANIAN' AS BIW_CREATED_BY,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_CREATED_DTTM,
    'VINAY.SUBRAMANIAN' AS BIW_UPD_BY ,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_UPD_DTTM
{% endmacro %}