{% macro MART_CORPORATION_HIST_FULLREFRESH() -%}
 {################# Step 1 DECLARE SCRIPTS/DDL NEED TO EXECUTED #################}
{%- set v_scripts -%} 
-- create temp table 
create or replace TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST_TEMP (
	CORPORATION_KEY VARCHAR(32),
	CORPORATION_CODE VARCHAR(16),
	CORPORATION_DESCRIPTION VARCHAR(360),
	ERP_CUST_ACCOUNT_ID NUMBER(15,0),
	CORPORATION_CATEGORY_CODE VARCHAR(150),
	CORPORATION_CATEGORY_DESCRIPTION VARCHAR(80),
	ERP_STATUS_CODE VARCHAR(1),
	HOME_REGION VARCHAR(10),
	IS_MARKET_MAKER BOOLEAN,
	CLASS VARCHAR(30),
	URL VARCHAR(2000),
	ACCOUNT_TYPE VARCHAR(30),
	IS_CUSTOMER_ITEM_CONTROL_REQUIRED BOOLEAN,
	BARCODE_LABEL_CODE VARCHAR(150),
	VENDOR_CODE VARCHAR(150),
	COLLECTOR_NAME VARCHAR(30),
	TAX_PRINTING_DESCRIPTION VARCHAR(30),
	GROUPING_RULE_CODE VARCHAR(40),
	HAS_CREDIT_CHECK BOOLEAN,
	HAS_CREDIT_HOLD BOOLEAN,
	CONTRACT_NAME VARCHAR(240),
	GAM_USER_ID VARCHAR(80),
	GAM_FIRST_NAME VARCHAR(80),
	GAM_LAST_NAME VARCHAR(80),
	GAM_EMAIL VARCHAR(80),
	GAM_PHONE VARCHAR(80),
	GAM_CONTACT_LAST_UPDATE_BY VARCHAR(80),
	GAM_CONTACT_CREATED_BY VARCHAR(80),
	GSM_USER_ID VARCHAR(80),
	GSM_FIRST_NAME VARCHAR(80),
	GSM_LAST_NAME VARCHAR(80),
	GSM_EMAIL VARCHAR(80),
	GSM_PHONE VARCHAR(80),
	GSM_CONTACT_LAST_UPDATE_BY VARCHAR(80),
	GSM_CONTACT_CREATED_BY VARCHAR(80),
	ADDRESS1 VARCHAR(140),
	ADDRESS2 VARCHAR(140),
	ADDRESS3 VARCHAR(140),
	ADDRESS4 VARCHAR(140),
	CITY VARCHAR(60),
	STATE VARCHAR(8),
	ZIPCODE VARCHAR(60),
	COUNTRY_CODE VARCHAR(3),
	BIW_INS_DTTM TIMESTAMP_NTZ(9),
	BIW_UPD_DTTM TIMESTAMP_NTZ(9),
	BIW_BATCH_ID NUMBER(38,0),
	BIW_MD5_KEY BINARY,
	DBT_SCD_ID VARCHAR(32),
	DBT_UPDATED_AT DATE,
	DBT_VALID_FROM DATE,
	DBT_VALID_TO DATE
);
-- load history data into temp table 
INSERT INTO {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST_TEMP
SELECT 
CORPORATION_KEY,
CORPORATION_CODE,
CORPORATION_DESCRIPTION,
ERP_CUST_ACCOUNT_ID,
CORPORATION_CATEGORY_CODE,
CORPORATION_CATEGORY_DESCRIPTION,
ERP_STATUS_CODE,
HOME_REGION,
IS_MARKET_MAKER,
CLASS,
URL,
ACCOUNT_TYPE,
IS_CUSTOMER_ITEM_CONTROL_REQUIRED,
BARCODE_LABEL_CODE,
VENDOR_CODE,
COLLECTOR_NAME,
TAX_PRINTING_DESCRIPTION,
GROUPING_RULE_CODE,
HAS_CREDIT_CHECK,
HAS_CREDIT_HOLD,
CONTRACT_NAME,
GAM_USER_ID,
GAM_FIRST_NAME,
GAM_LAST_NAME,
GAM_EMAIL,
GAM_PHONE,
GAM_CONTACT_LAST_UPDATE_BY,
GAM_CONTACT_CREATED_BY,
GSM_USER_ID,
GSM_FIRST_NAME,
GSM_LAST_NAME,
GSM_EMAIL,
GSM_PHONE,
GSM_CONTACT_LAST_UPDATE_BY,
GSM_CONTACT_CREATED_BY,
null as ADDRESS1,
null as ADDRESS2,
null as ADDRESS3,
null as ADDRESS4,
null as CITY,
null as STATE,
null as ZIPCODE,
null as COUNTRY_CODE,
BIW_INS_DTTM,
BIW_UPD_DTTM,
BIW_BATCH_ID,
BIW_MD5_KEY::BINARY,
DBT_SCD_ID,
DBT_UPDATED_AT,
DBT_VALID_FROM,
DBT_VALID_TO
FROM 
{{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST;


-- rename temp table to current
ALTER TABLE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST_TEMP
SWAP WITH {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST;

{%endset%}

{################# Step 2 EXECUTE SCRIPTS #################}
{% do run_query(v_scripts) %}

{################# Step 3 CAPTURE INTO DBT TABLE #################}
Insert into var('V_EDL_DEFAULT_DB')+env_var('DBT_DEP_ENV').UTILITY_DBT.DBT_SNOWFLAKE_DDL_EXECUTION
SELECT 
    684835 AS PCCT_NUMBER  ,
    '{{v_scripts|replace("'","''")}}' AS DDL_EXECUTED ,
    'VINAY.SUBRAMANIAN' AS BIW_CREATED_BY,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_CREATED_DTTM,
    'VINAY.SUBRAMANIAN' AS BIW_UPD_BY ,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_UPD_DTTM
{% endmacro %}