 {################# Step 1 DECLARE SCRIPTS/DDL NEED TO EXECUTED #################}
{%- set v_scripts -%} 

ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_ARCHIVE;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_ARCHIVE;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY_ARCHIVE;

ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_SCD1 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_SCD1 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY_SCD1 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY;

ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_SCD2 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_SCD2 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION_HIST;
ALTER TABLE EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY_SCD2 RENAME TO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY_HIST;

UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_CORPORATION_ARCHIVE' WHERE PROCESS_NAME='DBT_MART_SALES_CORPORATION';
UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_CUSTOMER_ARCHIVE' WHERE PROCESS_NAME='DBT_MART_SALES_CUSTOMER';
UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_SALES_TERRITORY_ARCHIVE' WHERE PROCESS_NAME='DBT_MART_SALES_SALES_TERRITORY';

UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_CORPORATION' WHERE PROCESS_NAME='DBT_MART_SALES_CORPORATION_SCD1';
UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_CUSTOMER' WHERE PROCESS_NAME='DBT_MART_SALES_CUSTOMER_SCD1';
UPDATE EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO SET PROCESS_NAME='DBT_MART_SALES_SALES_TERRITORY' WHERE PROCESS_NAME='DBT_MART_SALES_SALES_TERRITORY_SCD1';

INSERT INTO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CORPORATION
(
CORPORATION_KEY, CORPORATION_CODE, BIW_INS_DTTM, BIW_UPD_DTTM, BIW_BATCH_ID 
)
SELECT MD5('-1'), '-1', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT (MIN(BATCH_ID)-1) 
    FROM EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_BATCH_CTL CTL  
    JOIN EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO INFO 	
    ON CTL.PROCESS_ID = INFO.PROCESS_ID             
    AND INFO.PROCESS_NAME ='DBT_MART_SALES_CORPORATION'          
    AND CTL.BATCH_STATUS='S');

INSERT INTO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER
(
CUSTOMER_KEY, CUSTOMER_CODE, BIW_INS_DTTM , BIW_UPD_DTTM , BIW_BATCH_ID
)
SELECT MD5('-1'), '-1', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT (MIN(BATCH_ID)-1) 
    FROM EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_BATCH_CTL CTL  
    JOIN EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO INFO 	
    ON CTL.PROCESS_ID = INFO.PROCESS_ID             
    AND INFO.PROCESS_NAME ='DBT_MART_SALES_CUSTOMER'          
    AND CTL.BATCH_STATUS='S');

INSERT INTO EDWNEW{{env_var('DBT_DEP_ENV')}}.MART_SALES.SALES_TERRITORY
(
SALES_TERRITORY_KEY, SALES_ORGANIZATION_CODE, BIW_INS_DTTM , BIW_UPD_DTTM , BIW_BATCH_ID
)
SELECT MD5('-1'), '-1', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, (SELECT (MIN(BATCH_ID)-1) 
    FROM EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_BATCH_CTL CTL  
    JOIN EDL{{env_var('DBT_DEP_ENV')}}.UTILITY.EDW_PROCESS_INFO INFO 	
    ON CTL.PROCESS_ID = INFO.PROCESS_ID             
    AND INFO.PROCESS_NAME ='DBT_MART_SALES_SALES_TERRITORY'          
    AND CTL.BATCH_STATUS='S');

{%endset%}

{################# Step 2 EXECUTE SCRIPTS #################}
{% do run_query(v_scripts) %}

{################# Step 3 CAPTURE INTO DBT TABLE #################}
{{
    config(
         description = 'Capture DBT DDL Execution Scripts'
        ,transient=false
        ,materialized='incremental'
        ,database = var('V_EDL_DEFAULT_DB')+env_var('DBT_DEP_ENV')
        ,schema ='UTILITY_DBT'
        ,alias='DBT_SNOWFLAKE_DDL_EXECUTION'
        ,unique_key= 'PCCT_NUMBER'
        )
}}
SELECT 
    586054 AS PCCT_NUMBER  ,
    '{{v_scripts|replace("'","''")}}' AS DDL_EXECUTED ,
    'SRUTHI.KASBE' AS BIW_CREATED_BY,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_CREATED_DTTM,
    'SRUTHI.KASBE' AS BIW_UPD_BY ,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_UPD_DTTM
