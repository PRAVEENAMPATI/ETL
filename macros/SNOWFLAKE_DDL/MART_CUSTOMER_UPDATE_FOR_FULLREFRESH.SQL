{% macro MART_CUSTOMER_UPDATE_FOR_FULLREFRESH() -%}
 {################# Step 1 DECLARE SCRIPTS/DDL NEED TO EXECUTED #################}
{%- set v_scripts -%} 

UPDATE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER_HIST SET CORPORATION_CATEGORY_DESCRIPTION = CASE WHEN CORPORATION_CATEGORY_CODE ='CAT3' THEN 'Emerging' 
WHEN CORPORATION_CATEGORY_CODE ='CAT4' THEN 'Mass Market' END ,BIW_UPD_DTTM= CURRENT_TIMESTAMP
WHERE DBT_VALID_TO IS NULL AND 
(CASE WHEN CORPORATION_CATEGORY_CODE ='CAT3' AND CORPORATION_CATEGORY_DESCRIPTION <> 'Emerging' THEN 1 WHEN CORPORATION_CATEGORY_CODE = 'CAT4' AND CORPORATION_CATEGORY_DESCRIPTION <> 'Mass Market' THEN 1 END) = 1;

UPDATE {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.CUSTOMER SET CORPORATION_CATEGORY_DESCRIPTION = CASE WHEN CORPORATION_CATEGORY_CODE ='CAT3' THEN 'Emerging' 
WHEN CORPORATION_CATEGORY_CODE ='CAT4' THEN 'Mass Market' END ,BIW_UPD_DTTM= CURRENT_TIMESTAMP
WHERE 
(CASE WHEN CORPORATION_CATEGORY_CODE ='CAT3' AND CORPORATION_CATEGORY_DESCRIPTION <> 'Emerging' THEN 1 WHEN CORPORATION_CATEGORY_CODE = 'CAT4' AND CORPORATION_CATEGORY_DESCRIPTION <> 'Mass Market' THEN 1 END) = 1;

{%endset%}

{################# Step 2 EXECUTE SCRIPTS #################}
{% do run_query(v_scripts) %}

{################# Step 3 CAPTURE INTO DBT TABLE #################}
Insert into var('V_EDL_DEFAULT_DB')+env_var('DBT_DEP_ENV').UTILITY_DBT.DBT_SNOWFLAKE_DDL_EXECUTION
SELECT 
    659689 AS PCCT_NUMBER  ,
    '{{v_scripts|replace("'","''")}}' AS DDL_EXECUTED ,
    'VINAY.SUBRAMANIAN' AS BIW_CREATED_BY,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_CREATED_DTTM,
    'VINAY.SUBRAMANIAN' AS BIW_UPD_BY ,
    CURRENT_TIMESTAMP(0)::TIMESTAMP_NTZ AS BIW_UPD_DTTM
{% endmacro %}