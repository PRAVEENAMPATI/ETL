/*---------------------------------------------------------------------------
Command to run model:
--dbt run --full-refresh --select MART_SALES_FUNNEL_FACT
--dbt run --select MART_SALES_FUNNEL_FACT
--dbt run --select MART_SALES_FUNNEL_FACT --vars 'is_one_time_load: True'

Version     Date            Author               Description
-------     --------        -----------          ----------------------------------
1.0         11/14/2022      Kali Dandapani       Initial Version
2.0         11/14/2022      Vinay Subramanian    Added FUNNEL FACT HISTORICAL ONE TIME LOAD
3.0         12/06/2022      Vinay Subramanian    Added 18 columns for Created, DIN and  DWIN
4.0         02/08/2023      Vinay Subramanian    Added added logical delete flag
5.0         05/04/2023      Vinay Subramanian    Enhanced logical delete flag to include Design_Reg table
---------------------------------------------------------------------------*/

{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['FUNNEL_KEY']-%}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( ref('ETL_MART_SALES_FUNNEL_FACT') ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( ref('ETL_MART_SALES_FUNNEL_FACT') ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_MART_SALES_FUNNEL_FACT'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}

{%- set v_sql_update_tgt -%}
update {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT TGT
set    BIW_LOGICAL_DELETE_FLAG='Y',
BIW_UPD_DTTM = CURRENT_TIMESTAMP()::TIMESTAMP_NTZ  
WHERE SNAPSHOT_DATE_KEY = (SELECT MAX(SNAPSHOT_DATE_KEY) FROM  {{env_var('DBT_EDW_DB')~env_var('DBT_DEP_ENV')}}.MART_SALES.FUNNEL_FACT)
AND BIW_LOGICAL_DELETE_FLAG <> 'Y'
AND DESIGN_PART_MAPPING_KEY NOT IN (
    WITH UPD AS (
        SELECT 
            OID 
        FROM {{env_var('DBT_EDL_DB')~env_var('DBT_DEP_ENV')}}.STG_MODELN_PRICING_OWNER.DESIGN_PART_MAPPING
        WHERE DESIGN_REG_OID  IN (SELECT OID FROM {{env_var('DBT_EDL_DB')~env_var('DBT_DEP_ENV')}}.STG_MODELN_PRICING_OWNER.DESIGN_REG_FULL_KEY)
        UNION
        SELECT 
            OID
        FROM {{env_var('DBT_EDL_DB')~env_var('DBT_DEP_ENV')}}.STG_MODELN_PRICING_OWNER.DESIGN_PART_MAPPING_FULL_KEY
                )        
    SELECT OID FROM UPD);
{%endset%}  

{{
    config(
         description = 'Building table FUNNEL_FACT for sales mart '
        ,transient=false
        ,materialized='incremental'
        ,schema ='MART_SALES'
        ,alias='FUNNEL_FACT'
        ,unique_key= v_pk_list
        ,full_refresh = false
        ,tags ='MART_SALES'
        ,merge_update_columns=['DIRECT_CUSTOMER_KEY', 'INDIRECT_CUSTOMER_KEY', 'END_CUSTOMER_KEY', 'DIRECT_CORPORATION_KEY',
                                'INDIRECT_CORPORATION_KEY', 'END_CORPORATION_KEY', 'MARKET_PRODUCT_NUMBER_KEY', 'INTERNAL_PART_NUMBER_KEY',
                                'PRODUCTION_DATE_KEY', 'DESIGN_REGISTRATION_KEY', 'DESIGN_PART_MAPPING_KEY', 'DECISION_DAY_KEY', 'DESIGN_IN_DAY_KEY',
                                'ACTION_DAY_KEY', 'DIRECT_CUSTOMER_CODE', 'INDIRECT_CUSTOMER_CODE', 'END_CUSTOMER_CODE', 'DIRECT_CORPORATION_CODE',
                                'INDIRECT_CORPORATION_CODE', 'END_CORPORATION_CODE', 'MARKET_PRODUCT_NUMBER', 'INTERNAL_PART_NUMBER', 'TRANSACTION_DATE',
                                'DECISION_DATE', 'ACTION_DATE', 'DESIGN_IN_DATE', 'QUANTITY_PER_SYSTEM', 'EXCHANGE_RATE', 'TARGET_PRICE_USD',
                                'NRE_USD', 'DESIGN_REVENUE', 'DESIGN_REVENUE_SHARE', 'CONFIDENCE', 'ONSHARE', 'COMMISSIONABLE_NRE_USD',
                                'COMMISSIONABLE_THREE_YEAR_REVENUE_USD', 'THREE_YEAR_REVENUE', 'LIFETIME_REVENUE', 'NEW_BUSINESS_COMMIT_PCT', 'COST_TO_DEV_USD',
                                'ITEM_NUMBER', 'OPERATIONAL_ASP', 'REF_PRICE', 'SIP_MULTIPLIER', 'REGISTRATION_COST_ESTIMATE', 'BU_PRICE',
                                'TRANSACTION_CURRENCY_ISO_CODE', 'PROJECT_VALUE_OVER_LIFETIME', 'ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE', 'CREATED_DATE',
                                'MODIFIED_DATE', 'PROTOTYPE_DATE', 'SOCKET_STATUS_CHANGE_DATE', 'REGISTRATION_ITEM_REQUEST_DATE',
                                'REGISTRATION_ITEM_REVIEW_DATE', 'REGISTRATION_ITEM_EXPIRE', 'VALIDATED_DATE', 'COMMISSION_WIN_DATE', 'BLUESHEET_FIRST_ADD_DATE',
                                'BLUESHEET_UPDATED_DATE', 'SAMPLES_REQUIRED_DATE', 'SEGMENT_MUSTWIN_SET_DATE', 'EXEC_MUSTWIN_SET_DATE',
                                'VP_MUSTWIN_SET_DATE', 'CLAIM_WIN_DATE', 'NEXT_MILESTONE_DATE', 'OPPORTUNITY_DECISION_DATE', 'BU_START_DATE',
                                'BU_END_DATE', 'ORIGINAL_APPROVAL_DATE', 'ORIGINAL_DISPOSITION_DATE', 'PROJECT_MODIFIED_DATE',
                                'BU_DESIGN_IN_REQUEST_DATE', 'IS_PART_ACTIVE', 'IS_PRIMARY_OPN', 'IS_OPPORTUNITY', 'IS_REFERENCE_DESIGN', 'IS_MUSTWIN',
                                'IS_SEGMENT_MUSTWIN', 'IS_EXECMUSTWIN', 'IS_VPNMUSTWIN', 'IS_DSM_REVIEW', 'IS_BOM_EXPANSION', 'IS_SUNSET', 'IS_NPI',
                                'CREATED_BY', 'MODIFIED_BY', 'OPPORTUNITY_NUMBER', 'OPPORTUNITY_LIFECYCLE_STATUS', 'DESIGN_TYPE',
                                'CHANNEL_TYPE', 'CHANNEL', 'FSE', 'FAE', 'PRODUCT_MARKETER', 'SEC_INVOLVEMENT', 'PROGRAM_STATUS', 'PROGRAM_NAME',
                                'BOARD_NAME', 'ESTIMATED_ANNUAL_BOARDS', 'PART_TYPE', 'LINE_DESCRIPTION', 'SALES_SOCKET_STATUS',
                                'CORPORATION_SOCKET_STATUS', 'SEGMENT', 'APPLICATION', 'REGISTRATION_NUMBER', 'ACTION_NOTES', 'OPPORTUNITY_COMMENTS',
                                'DISTRIBUTOR_NAME', 'DISTRIBUTOR_BRANCH_NAME', 'REGISTRATION_ITEM_REVIEWBY', 'REGISTRATION_ITEM_STATUS',
                                'REGISTRATION_ITEM_CANCEL_REJECT_REASON', 'DISTRIBUTOR_FSE', 'DISTRIBUTOR_FAE', 'COMMISSION_UPDATED_BY', 'COMMISSION_NOTES',
                                'BLUE_SHEET_REQUIRED', 'BLUE_SHEET_URL', 'BU_STATUS', 'BU_COMMENT', 'CROSS_SELL_TYPE', 'COMPETITION', 'RYG_STATUS',
                                'SWAT_TEAM', 'REGISTRATION_ITEM_NUMBER', 'DESIGN_STATUS', 'BU_ACTION_NOTES', 'BU_DESIGN_IN_REQUEST',
                                'POS50K_2M_REGOWNER', 'POS2MPLUS_REGOWNER', 'POS50K_2M_NON_REGOWNER', 'POS2MPLUS_NON_REGOWNER', 'REBATE_NOTES',
                                'REFERENCE_OPPORTUNITY_NUMBER', 'DESIGN_IN_APPROVER', 'BU_MARKETER_APPROVAL', 'BU_MARKETER_APPROVER_ID',
                                'BU_MARKETER_APPROVER_NAME', 'DISTRIBUTOR_PROJECT_REF', 'DISTRIBUTOR_DEVICE_REF', 'BLOCK_DIAGRAM_COMPLETE',
                                'OPPORTUNITY_REGISTRATION_TYPE', 'TRANSFER_STATUS', 'DISTRIBUTOR_NOTES', 'SPLIT_REVIEW_STATUS', 'LOW_MARGIN_EXCEPTION',
                                'MARGIN_BUCKET', 'NPI_STATUS', 'NPI_NUMBER', 'NPD_PROJECT_NUMBER', 'OPPORTUNITY_LINE_CONTACT', 'SIP_REASON',
                                'DESIGNWIN_REQUEST_STATUS', 'CATCHUP_REG', 'EFFORT_TIER', 'PRODUCT_TIER', 'DESIGNIN_DESIGNWIN_APPROVER', 'SOURCE_SYSTEM',
                                'CREATED_ESTIMATED_ANNUAL_BOARDS', 'CREATED_QUANTITY_PER_SYSTEM', 'CREATED_TARGET_PRICE_USD', 'CREATED_DESIGN_REVENUE_SHARE',
                                'CREATED_ONSHARE', 'CREATED_PROJECT_VALUE_OVER_LIFETIME', 'DIN_ESTIMATED_ANNUAL_BOARDS', 'DIN_QUANTITY_PER_SYSTEM',
                                'DIN_TARGET_PRICE_USD', 'DIN_DESIGN_REVENUE_SHARE', 'DIN_ONSHARE', 'DIN_PROJECT_VALUE_OVER_LIFETIME',
                                'DWIN_ESTIMATED_ANNUAL_BOARDS', 'DWIN_QUANTITY_PER_SYSTEM', 'DWIN_TARGET_PRICE_USD', 'DWIN_DESIGN_REVENUE_SHARE', 'DWIN_ONSHARE',
                                'DWIN_PROJECT_VALUE_OVER_LIFETIME', 'BIW_UPD_DTTM', 'BIW_BATCH_ID', 'BIW_LOGICAL_DELETE_FLAG', 'BIW_MD5_KEY']

        ,post_hook= [ v_sql_update_tgt, v_sql_upd_success_batch]
        )
}}
SELECT 
    STG.FUNNEL_KEY, 
    REPLACE(CURRENT_DATE,'-')::number  as SNAPSHOT_DATE_KEY,
    STG.DIRECT_CUSTOMER_KEY, 
    STG.INDIRECT_CUSTOMER_KEY, 
    STG.END_CUSTOMER_KEY, 
    STG.DIRECT_CORPORATION_KEY, 
    STG.INDIRECT_CORPORATION_KEY, 
    STG.END_CORPORATION_KEY, 
    STG.MARKET_PRODUCT_NUMBER_KEY, 
    STG.INTERNAL_PART_NUMBER_KEY,
    STG.PRODUCTION_DATE_KEY, 
    STG.DESIGN_REGISTRATION_KEY, 
    STG.DESIGN_PART_MAPPING_KEY, 
    STG.DECISION_DAY_KEY, 
    STG.DESIGN_IN_DAY_KEY, 
    STG.ACTION_DAY_KEY, 
    STG.DIRECT_CUSTOMER_CODE, 
    STG.INDIRECT_CUSTOMER_CODE, 
    STG.END_CUSTOMER_CODE, 
    STG.DIRECT_CORPORATION_CODE, 
    STG.INDIRECT_CORPORATION_CODE, 
    STG.END_CORPORATION_CODE, 
    STG.MARKET_PRODUCT_NUMBER, 
    STG.INTERNAL_PART_NUMBER,
    STG.TRANSACTION_DATE, 
    STG.DECISION_DATE, 
    STG.ACTION_DATE, 
    STG.DESIGN_IN_DATE, 
    STG.QUANTITY_PER_SYSTEM, 
    STG.EXCHANGE_RATE, 
    STG.TARGET_PRICE_USD, 
    STG.NRE_USD, 
    STG.DESIGN_REVENUE, 
    STG.DESIGN_REVENUE_SHARE, 
    STG.CONFIDENCE, 
    STG.ONSHARE, 
    STG.COMMISSIONABLE_NRE_USD, 
    STG.COMMISSIONABLE_THREE_YEAR_REVENUE_USD, 
    STG.THREE_YEAR_REVENUE, 
    STG.LIFETIME_REVENUE, 
    STG.NEW_BUSINESS_COMMIT_PCT, 
    STG.COST_TO_DEV_USD, 
    STG.ITEM_NUMBER, 
    STG.OPERATIONAL_ASP, 
    STG.REF_PRICE, 
    STG.SIP_MULTIPLIER, 
    STG.REGISTRATION_COST_ESTIMATE, 
    STG.BU_PRICE, 
    STG.TRANSACTION_CURRENCY_ISO_CODE, 
    STG.PROJECT_VALUE_OVER_LIFETIME, 
    STG.ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE, 
    STG.CREATED_DATE, 
    STG.MODIFIED_DATE, 
    STG.PROTOTYPE_DATE, 
    STG.SOCKET_STATUS_CHANGE_DATE, 
    STG.REGISTRATION_ITEM_REQUEST_DATE, 
    STG.REGISTRATION_ITEM_REVIEW_DATE, 
    STG.REGISTRATION_ITEM_EXPIRE, 
    STG.VALIDATED_DATE, 
    STG.COMMISSION_WIN_DATE, 
    STG.BLUESHEET_FIRST_ADD_DATE, 
    STG.BLUESHEET_UPDATED_DATE, 
    STG.SAMPLES_REQUIRED_DATE, 
    STG.SEGMENT_MUSTWIN_SET_DATE, 
    STG.EXEC_MUSTWIN_SET_DATE, 
    STG.VP_MUSTWIN_SET_DATE, 
    STG.CLAIM_WIN_DATE, 
    STG.NEXT_MILESTONE_DATE, 
    STG.OPPORTUNITY_DECISION_DATE, 
    STG.BU_START_DATE, 
    STG.BU_END_DATE, 
    STG.ORIGINAL_APPROVAL_DATE, 
    STG.ORIGINAL_DISPOSITION_DATE, 
    STG.PROJECT_MODIFIED_DATE, 
    STG.BU_DESIGN_IN_REQUEST_DATE, 
    STG.IS_PART_ACTIVE, 
    STG.IS_PRIMARY_OPN, 
    STG.IS_OPPORTUNITY, 
    STG.IS_REFERENCE_DESIGN, 
    STG.IS_MUSTWIN, 
    STG.IS_SEGMENT_MUSTWIN, 
    STG.IS_EXECMUSTWIN, 
    STG.IS_VPNMUSTWIN, 
    STG.IS_DSM_REVIEW, 
    STG.IS_BOM_EXPANSION, 
    STG.IS_SUNSET, 
    STG.IS_NPI, 
    STG.CREATED_BY, 
    STG.MODIFIED_BY, 
    STG.OPPORTUNITY_NUMBER, 
    STG.OPPORTUNITY_LIFECYCLE_STATUS, 
    STG.DESIGN_TYPE, 
    STG.CHANNEL_TYPE, 
    STG.CHANNEL, 
    STG.FSE, 
    STG.FAE, 
    STG.PRODUCT_MARKETER, 
    STG.SEC_INVOLVEMENT, 
    STG.PROGRAM_STATUS, 
    STG.PROGRAM_NAME, 
    STG.BOARD_NAME, 
    STG.ESTIMATED_ANNUAL_BOARDS, 
    STG.PART_TYPE, 
    STG.LINE_DESCRIPTION, 
    STG.SALES_SOCKET_STATUS, 
    STG.CORPORATION_SOCKET_STATUS, 
    STG.SEGMENT, 
    STG.APPLICATION, 
    STG.REGISTRATION_NUMBER, 
    STG.ACTION_NOTES, 
    STG.OPPORTUNITY_COMMENTS, 
    STG.DISTRIBUTOR_NAME, 
    STG.DISTRIBUTOR_BRANCH_NAME, 
    STG.REGISTRATION_ITEM_REVIEWBY, 
    STG.REGISTRATION_ITEM_STATUS, 
    STG.REGISTRATION_ITEM_CANCEL_REJECT_REASON, 
    STG.DISTRIBUTOR_FSE, 
    STG.DISTRIBUTOR_FAE, 
    STG.COMMISSION_UPDATED_BY, 
    STG.COMMISSION_NOTES, 
    STG.BLUE_SHEET_REQUIRED, 
    STG.BLUE_SHEET_URL, 
    STG.BU_STATUS, 
    STG.BU_COMMENT, 
    STG.CROSS_SELL_TYPE, 
    STG.COMPETITION, 
    STG.RYG_STATUS, 
    STG.SWAT_TEAM, 
    STG.REGISTRATION_ITEM_NUMBER, 
    STG.DESIGN_STATUS, 
    STG.BU_ACTION_NOTES, 
    STG.BU_DESIGN_IN_REQUEST,
    STG.POS50K_2M_REGOWNER,
    STG.POS2MPLUS_REGOWNER,
    STG.POS50K_2M_NON_REGOWNER,
    STG.POS2MPLUS_NON_REGOWNER, 
    STG.REBATE_NOTES, 
    STG.REFERENCE_OPPORTUNITY_NUMBER, 
    STG.DESIGN_IN_APPROVER, 
    STG.BU_MARKETER_APPROVAL, 
    STG.BU_MARKETER_APPROVER_ID, 
    STG.BU_MARKETER_APPROVER_NAME, 
    STG.DISTRIBUTOR_PROJECT_REF, 
    STG.DISTRIBUTOR_DEVICE_REF, 
    STG.BLOCK_DIAGRAM_COMPLETE, 
    STG.OPPORTUNITY_REGISTRATION_TYPE, 
    STG.TRANSFER_STATUS, 
    STG.DISTRIBUTOR_NOTES, 
    STG.SPLIT_REVIEW_STATUS, 
    STG.LOW_MARGIN_EXCEPTION, 
    STG.MARGIN_BUCKET, 
    STG.NPI_STATUS, 
    STG.NPI_NUMBER, 
    STG.NPD_PROJECT_NUMBER, 
    STG.OPPORTUNITY_LINE_CONTACT,
    STG.SIP_REASON,
    STG.DESIGNWIN_REQUEST_STATUS,
    STG.CATCHUP_REG,
    STG.EFFORT_TIER,
    STG.PRODUCT_TIER,
    STG.DESIGNIN_DESIGNWIN_APPROVER,
    STG.SOURCE_SYSTEM,
    {% if is_incremental() %} 
        COALESCE(STG.CREATED_ESTIMATED_ANNUAL_BOARDS ,TGT.CREATED_ESTIMATED_ANNUAL_BOARDS) CREATED_ESTIMATED_ANNUAL_BOARDS,
        COALESCE(STG.CREATED_QUANTITY_PER_SYSTEM ,TGT.CREATED_QUANTITY_PER_SYSTEM) CREATED_QUANTITY_PER_SYSTEM,
        COALESCE(STG.CREATED_TARGET_PRICE_USD ,TGT.CREATED_TARGET_PRICE_USD) CREATED_TARGET_PRICE_USD,
        COALESCE(STG.CREATED_DESIGN_REVENUE_SHARE ,TGT.CREATED_DESIGN_REVENUE_SHARE) CREATED_DESIGN_REVENUE_SHARE,
        COALESCE(STG.CREATED_ONSHARE ,TGT.CREATED_ONSHARE) CREATED_ONSHARE,
        COALESCE(STG.CREATED_PROJECT_VALUE_OVER_LIFETIME ,TGT.CREATED_PROJECT_VALUE_OVER_LIFETIME) CREATED_PROJECT_VALUE_OVER_LIFETIME,
        COALESCE(STG.DIN_ESTIMATED_ANNUAL_BOARDS ,TGT.DIN_ESTIMATED_ANNUAL_BOARDS) DIN_ESTIMATED_ANNUAL_BOARDS,
        COALESCE(STG.DIN_QUANTITY_PER_SYSTEM ,TGT.DIN_QUANTITY_PER_SYSTEM) DIN_QUANTITY_PER_SYSTEM,
        COALESCE(STG.DIN_TARGET_PRICE_USD ,TGT.DIN_TARGET_PRICE_USD) DIN_TARGET_PRICE_USD,
        COALESCE(STG.DIN_DESIGN_REVENUE_SHARE ,TGT.DIN_DESIGN_REVENUE_SHARE) DIN_DESIGN_REVENUE_SHARE,
        COALESCE(STG.DIN_ONSHARE ,TGT.DIN_ONSHARE) DIN_ONSHARE,
        COALESCE(STG.DIN_PROJECT_VALUE_OVER_LIFETIME ,TGT.DIN_PROJECT_VALUE_OVER_LIFETIME) DIN_PROJECT_VALUE_OVER_LIFETIME,
        COALESCE(STG.DWIN_ESTIMATED_ANNUAL_BOARDS ,TGT.DWIN_ESTIMATED_ANNUAL_BOARDS) DWIN_ESTIMATED_ANNUAL_BOARDS,
        COALESCE(STG.DWIN_QUANTITY_PER_SYSTEM ,TGT.DWIN_QUANTITY_PER_SYSTEM) DWIN_QUANTITY_PER_SYSTEM,
        COALESCE(STG.DWIN_TARGET_PRICE_USD ,TGT.DWIN_TARGET_PRICE_USD) DWIN_TARGET_PRICE_USD,
        COALESCE(STG.DWIN_DESIGN_REVENUE_SHARE ,TGT.DWIN_DESIGN_REVENUE_SHARE) DWIN_DESIGN_REVENUE_SHARE,
        COALESCE(STG.DWIN_ONSHARE ,TGT.DWIN_ONSHARE) DWIN_ONSHARE,
        COALESCE(STG.DWIN_PROJECT_VALUE_OVER_LIFETIME ,TGT.DWIN_PROJECT_VALUE_OVER_LIFETIME) DWIN_PROJECT_VALUE_OVER_LIFETIME,
    {% else%}
        STG.CREATED_ESTIMATED_ANNUAL_BOARDS,
        STG.CREATED_QUANTITY_PER_SYSTEM,
        STG.CREATED_TARGET_PRICE_USD,
        STG.CREATED_DESIGN_REVENUE_SHARE,
        STG.CREATED_ONSHARE,
        STG.CREATED_PROJECT_VALUE_OVER_LIFETIME,
        STG.DIN_ESTIMATED_ANNUAL_BOARDS,
        STG.DIN_QUANTITY_PER_SYSTEM,
        STG.DIN_TARGET_PRICE_USD,
        STG.DIN_DESIGN_REVENUE_SHARE,
        STG.DIN_ONSHARE,
        STG.DIN_PROJECT_VALUE_OVER_LIFETIME,
        STG.DWIN_ESTIMATED_ANNUAL_BOARDS,
        STG.DWIN_QUANTITY_PER_SYSTEM,
        STG.DWIN_TARGET_PRICE_USD,
        STG.DWIN_DESIGN_REVENUE_SHARE,
        STG.DWIN_ONSHARE,
        STG.DWIN_PROJECT_VALUE_OVER_LIFETIME,
    {% endif %} 
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
    {{V_BIW_BATCH_ID}}	 as BIW_BATCH_ID,
    STG.BIW_LOGICAL_DELETE_FLAG,
    STG.BIW_MD5_KEY
FROM {{ref('ETL_MART_SALES_FUNNEL_FACT')}} STG
{% if is_incremental() %} 
    LEFT JOIN {{this}} TGT 
        ON STG.DESIGN_PART_MAPPING_KEY = TGT.DESIGN_PART_MAPPING_KEY
        AND STG.SOURCE_SYSTEM = TGT.SOURCE_SYSTEM
        AND TGT.SNAPSHOT_DATE_KEY = (SELECT MAX(SNAPSHOT_DATE_KEY)FROM   {{this}})
{% endif %} 
{% if is_incremental() %} 
UNION ALL 
SELECT 
    MD5(OBJECT_CONSTRUCT ('COL1',DESIGN_PART_MAPPING_KEY::STRING
                    , 'COL2',CURRENT_DATE::STRING
                    , 'COL3',SOURCE_SYSTEM::STRING
                    )::STRING)  AS FUNNEL_KEY, 
    REPLACE(CURRENT_DATE,'-')::number  as SNAPSHOT_DATE_KEY,
    DIRECT_CUSTOMER_KEY, 
    INDIRECT_CUSTOMER_KEY, 
    END_CUSTOMER_KEY, 
    DIRECT_CORPORATION_KEY, 
    INDIRECT_CORPORATION_KEY, 
    END_CORPORATION_KEY, 
    MARKET_PRODUCT_NUMBER_KEY, 
    INTERNAL_PART_NUMBER_KEY,
    PRODUCTION_DATE_KEY, 
    DESIGN_REGISTRATION_KEY, 
    DESIGN_PART_MAPPING_KEY, 
    DECISION_DAY_KEY, 
    DESIGN_IN_DAY_KEY, 
    ACTION_DAY_KEY, 
    DIRECT_CUSTOMER_CODE, 
    INDIRECT_CUSTOMER_CODE, 
    END_CUSTOMER_CODE, 
    DIRECT_CORPORATION_CODE, 
    INDIRECT_CORPORATION_CODE, 
    END_CORPORATION_CODE, 
    MARKET_PRODUCT_NUMBER, 
    INTERNAL_PART_NUMBER,
    TRANSACTION_DATE, 
    DECISION_DATE, 
    ACTION_DATE, 
    DESIGN_IN_DATE, 
    QUANTITY_PER_SYSTEM, 
    EXCHANGE_RATE, 
    TARGET_PRICE_USD, 
    NRE_USD, 
    DESIGN_REVENUE, 
    DESIGN_REVENUE_SHARE, 
    CONFIDENCE, 
    ONSHARE, 
    COMMISSIONABLE_NRE_USD, 
    COMMISSIONABLE_THREE_YEAR_REVENUE_USD, 
    THREE_YEAR_REVENUE, 
    LIFETIME_REVENUE, 
    NEW_BUSINESS_COMMIT_PCT, 
    COST_TO_DEV_USD, 
    ITEM_NUMBER, 
    OPERATIONAL_ASP, 
    REF_PRICE, 
    SIP_MULTIPLIER, 
    REGISTRATION_COST_ESTIMATE, 
    BU_PRICE, 
    TRANSACTION_CURRENCY_ISO_CODE, 
    PROJECT_VALUE_OVER_LIFETIME, 
    ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE, 
    CREATED_DATE, 
    MODIFIED_DATE, 
    PROTOTYPE_DATE, 
    SOCKET_STATUS_CHANGE_DATE, 
    REGISTRATION_ITEM_REQUEST_DATE, 
    REGISTRATION_ITEM_REVIEW_DATE, 
    REGISTRATION_ITEM_EXPIRE, 
    VALIDATED_DATE, 
    COMMISSION_WIN_DATE, 
    BLUESHEET_FIRST_ADD_DATE, 
    BLUESHEET_UPDATED_DATE, 
    SAMPLES_REQUIRED_DATE, 
    SEGMENT_MUSTWIN_SET_DATE, 
    EXEC_MUSTWIN_SET_DATE, 
    VP_MUSTWIN_SET_DATE, 
    CLAIM_WIN_DATE, 
    NEXT_MILESTONE_DATE, 
    OPPORTUNITY_DECISION_DATE, 
    BU_START_DATE, 
    BU_END_DATE, 
    ORIGINAL_APPROVAL_DATE, 
    ORIGINAL_DISPOSITION_DATE, 
    PROJECT_MODIFIED_DATE, 
    BU_DESIGN_IN_REQUEST_DATE, 
    IS_PART_ACTIVE, 
    IS_PRIMARY_OPN, 
    IS_OPPORTUNITY, 
    IS_REFERENCE_DESIGN, 
    IS_MUSTWIN, 
    IS_SEGMENT_MUSTWIN, 
    IS_EXECMUSTWIN, 
    IS_VPNMUSTWIN, 
    IS_DSM_REVIEW, 
    IS_BOM_EXPANSION, 
    IS_SUNSET, 
    IS_NPI, 
    CREATED_BY, 
    MODIFIED_BY, 
    OPPORTUNITY_NUMBER, 
    OPPORTUNITY_LIFECYCLE_STATUS, 
    DESIGN_TYPE, 
    CHANNEL_TYPE, 
    CHANNEL, 
    FSE, 
    FAE, 
    PRODUCT_MARKETER, 
    SEC_INVOLVEMENT, 
    PROGRAM_STATUS, 
    PROGRAM_NAME, 
    BOARD_NAME, 
    ESTIMATED_ANNUAL_BOARDS, 
    PART_TYPE, 
    LINE_DESCRIPTION, 
    SALES_SOCKET_STATUS, 
    CORPORATION_SOCKET_STATUS, 
    SEGMENT, 
    APPLICATION, 
    REGISTRATION_NUMBER, 
    ACTION_NOTES, 
    OPPORTUNITY_COMMENTS, 
    DISTRIBUTOR_NAME, 
    DISTRIBUTOR_BRANCH_NAME, 
    REGISTRATION_ITEM_REVIEWBY, 
    REGISTRATION_ITEM_STATUS, 
    REGISTRATION_ITEM_CANCEL_REJECT_REASON, 
    DISTRIBUTOR_FSE, 
    DISTRIBUTOR_FAE, 
    COMMISSION_UPDATED_BY, 
    COMMISSION_NOTES, 
    BLUE_SHEET_REQUIRED, 
    BLUE_SHEET_URL, 
    BU_STATUS, 
    BU_COMMENT, 
    CROSS_SELL_TYPE, 
    COMPETITION, 
    RYG_STATUS, 
    SWAT_TEAM, 
    REGISTRATION_ITEM_NUMBER, 
    DESIGN_STATUS, 
    BU_ACTION_NOTES, 
    BU_DESIGN_IN_REQUEST,
    POS50K_2M_REGOWNER,
    POS2MPLUS_REGOWNER,
    POS50K_2M_NON_REGOWNER,
    POS2MPLUS_NON_REGOWNER, 
    REBATE_NOTES, 
    REFERENCE_OPPORTUNITY_NUMBER, 
    DESIGN_IN_APPROVER, 
    BU_MARKETER_APPROVAL, 
    BU_MARKETER_APPROVER_ID, 
    BU_MARKETER_APPROVER_NAME, 
    DISTRIBUTOR_PROJECT_REF, 
    DISTRIBUTOR_DEVICE_REF, 
    BLOCK_DIAGRAM_COMPLETE, 
    OPPORTUNITY_REGISTRATION_TYPE, 
    TRANSFER_STATUS, 
    DISTRIBUTOR_NOTES, 
    SPLIT_REVIEW_STATUS, 
    LOW_MARGIN_EXCEPTION, 
    MARGIN_BUCKET, 
    NPI_STATUS, 
    NPI_NUMBER, 
    NPD_PROJECT_NUMBER, 
    OPPORTUNITY_LINE_CONTACT,
    SIP_REASON,
    DESIGNWIN_REQUEST_STATUS,
    CATCHUP_REG,
    EFFORT_TIER,
    PRODUCT_TIER,
    DESIGNIN_DESIGNWIN_APPROVER,
    SOURCE_SYSTEM,
    CREATED_ESTIMATED_ANNUAL_BOARDS,
    CREATED_QUANTITY_PER_SYSTEM,
    CREATED_TARGET_PRICE_USD,
    CREATED_DESIGN_REVENUE_SHARE,
    CREATED_ONSHARE,
    CREATED_PROJECT_VALUE_OVER_LIFETIME,
    DIN_ESTIMATED_ANNUAL_BOARDS,
    DIN_QUANTITY_PER_SYSTEM,
    DIN_TARGET_PRICE_USD,
    DIN_DESIGN_REVENUE_SHARE,
    DIN_ONSHARE,
    DIN_PROJECT_VALUE_OVER_LIFETIME,
    DWIN_ESTIMATED_ANNUAL_BOARDS,
    DWIN_QUANTITY_PER_SYSTEM,
    DWIN_TARGET_PRICE_USD,
    DWIN_DESIGN_REVENUE_SHARE,
    DWIN_ONSHARE,
    DWIN_PROJECT_VALUE_OVER_LIFETIME,    
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
    {{V_BIW_BATCH_ID}}	 as BIW_BATCH_ID,
    BIW_LOGICAL_DELETE_FLAG,
    BIW_MD5_KEY
FROM
{{this}}
WHERE SOURCE_SYSTEM='MODELN'
AND SNAPSHOT_DATE_KEY =   (SELECT MAX(SNAPSHOT_DATE_KEY) 
                        FROM   {{this}}
                        )
AND DESIGN_PART_MAPPING_KEY NOT IN (SELECT DESIGN_PART_MAPPING_KEY 
                        FROM {{ref('ETL_MART_SALES_FUNNEL_FACT')}} )
{%endif%}
{% if not is_incremental() or var('is_one_time_load') %} 
    UNION ALL
    SELECT 
	    FUNNEL_KEY,
        SNAPSHOT_DATE_KEY,
        DIRECT_CUSTOMER_KEY,
        INDIRECT_CUSTOMER_KEY,
        END_CUSTOMER_KEY,
        DIRECT_CORPORATION_KEY,
        INDIRECT_CORPORATION_KEY,
        END_CORPORATION_KEY,
        MARKET_PRODUCT_NUMBER_KEY,
        INTERNAL_PART_NUMBER_KEY,
        PRODUCTION_DATE_KEY,
        DESIGN_REGISTRATION_KEY,
        DESIGN_PART_MAPPING_KEY,
        DECISION_DAY_KEY,
        DESIGN_IN_DAY_KEY,
        ACTION_DAY_KEY,
        DIRECT_CUSTOMER_CODE,
        INDIRECT_CUSTOMER_CODE,
        END_CUSTOMER_CODE,
        DIRECT_CORPORATION_CODE,
        INDIRECT_CORPORATION_CODE,
        END_CORPORATION_CODE,
        MARKET_PRODUCT_NUMBER,
        INTERNAL_PART_NUMBER,
        TRANSACTION_DATE,
        DECISION_DATE,
        ACTION_DATE,
        DESIGN_IN_DATE,
        QUANTITY_PER_SYSTEM,
        EXCHANGE_RATE,
        TARGET_PRICE_USD,
        NRE_USD,
        DESIGN_REVENUE,
        DESIGN_REVENUE_SHARE,
        CONFIDENCE,
        ONSHARE,
        COMMISSIONABLE_NRE_USD,
        COMMISSIONABLE_THREE_YEAR_REVENUE_USD,
        THREE_YEAR_REVENUE,
        LIFETIME_REVENUE,
        NEW_BUSINESS_COMMIT_PCT,
        COST_TO_DEV_USD,
        ITEM_NUMBER,
        OPERATIONAL_ASP,
        REF_PRICE,
        SIP_MULTIPLIER,
        REGISTRATION_COST_ESTIMATE,
        BU_PRICE,
        TRANSACTION_CURRENCY_ISO_CODE,
        PROJECT_VALUE_OVER_LIFETIME,
        ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE,
        CREATED_DATE,
        MODIFIED_DATE,
        PROTOTYPE_DATE,
        SOCKET_STATUS_CHANGE_DATE,
        REGISTRATION_ITEM_REQUEST_DATE,
        REGISTRATION_ITEM_REVIEW_DATE,
        REGISTRATION_ITEM_EXPIRE,
        VALIDATED_DATE,
        COMMISSION_WIN_DATE,
        BLUESHEET_FIRST_ADD_DATE,
        BLUESHEET_UPDATED_DATE,
        SAMPLES_REQUIRED_DATE,
        SEGMENT_MUSTWIN_SET_DATE,
        EXEC_MUSTWIN_SET_DATE,
        VP_MUSTWIN_SET_DATE,
        CLAIM_WIN_DATE,
        NEXT_MILESTONE_DATE,
        OPPORTUNITY_DECISION_DATE,
        BU_START_DATE,
        BU_END_DATE,
        ORIGINAL_APPROVAL_DATE,
        ORIGINAL_DISPOSITION_DATE,
        PROJECT_MODIFIED_DATE,
        BU_DESIGN_IN_REQUEST_DATE,
        IS_PART_ACTIVE,
        IS_PRIMARY_OPN,
        IS_OPPORTUNITY,
        IS_REFERENCE_DESIGN,
        IS_MUSTWIN,
        IS_SEGMENT_MUSTWIN,
        IS_EXECMUSTWIN,
        IS_VPNMUSTWIN,
        IS_DSM_REVIEW,
        IS_BOM_EXPANSION,
        IS_SUNSET,
        IS_NPI,
        CREATED_BY,
        MODIFIED_BY,
        OPPORTUNITY_NUMBER,
        OPPORTUNITY_LIFECYCLE_STATUS,
        DESIGN_TYPE,
        CHANNEL_TYPE,
        CHANNEL,
        FSE,
        FAE,
        PRODUCT_MARKETER,
        SEC_INVOLVEMENT,
        PROGRAM_STATUS,
        PROGRAM_NAME,
        BOARD_NAME,
        ESTIMATED_ANNUAL_BOARDS,
        PART_TYPE,
        LINE_DESCRIPTION,
        SALES_SOCKET_STATUS,
        CORPORATION_SOCKET_STATUS,
        SEGMENT,
        APPLICATION,
        REGISTRATION_NUMBER,
        ACTION_NOTES,
        OPPORTUNITY_COMMENTS,
        DISTRIBUTOR_NAME,
        DISTRIBUTOR_BRANCH_NAME,
        REGISTRATION_ITEM_REVIEWBY,
        REGISTRATION_ITEM_STATUS,
        REGISTRATION_ITEM_CANCEL_REJECT_REASON,
        DISTRIBUTOR_FSE,
        DISTRIBUTOR_FAE,
        COMMISSION_UPDATED_BY,
        COMMISSION_NOTES,
        BLUE_SHEET_REQUIRED,
        BLUE_SHEET_URL,
        BU_STATUS,
        BU_COMMENT,
        CROSS_SELL_TYPE,
        COMPETITION,
        RYG_STATUS,
        SWAT_TEAM,
        REGISTRATION_ITEM_NUMBER,
        DESIGN_STATUS,
        BU_ACTION_NOTES,
        BU_DESIGN_IN_REQUEST,
        POS50K_2M_REGOWNER,
        POS2MPLUS_REGOWNER,
        POS50K_2M_NON_REGOWNER,
        POS2MPLUS_NON_REGOWNER,
        REBATE_NOTES,
        REFERENCE_OPPORTUNITY_NUMBER,
        DESIGN_IN_APPROVER,
        BU_MARKETER_APPROVAL,
        BU_MARKETER_APPROVER_ID,
        BU_MARKETER_APPROVER_NAME,
        DISTRIBUTOR_PROJECT_REF,
        DISTRIBUTOR_DEVICE_REF,
        BLOCK_DIAGRAM_COMPLETE,
        OPPORTUNITY_REGISTRATION_TYPE,
        TRANSFER_STATUS,
        DISTRIBUTOR_NOTES,
        SPLIT_REVIEW_STATUS,
        LOW_MARGIN_EXCEPTION,
        MARGIN_BUCKET,
        NPI_STATUS,
        NPI_NUMBER,
        NPD_PROJECT_NUMBER,
        OPPORTUNITY_LINE_CONTACT,
        SIP_REASON,
        DESIGNWIN_REQUEST_STATUS,
        CATCHUP_REG,
        EFFORT_TIER,
        PRODUCT_TIER,
        DESIGNIN_DESIGNWIN_APPROVER,
        SOURCE_SYSTEM,
        CREATED_ESTIMATED_ANNUAL_BOARDS,
        CREATED_QUANTITY_PER_SYSTEM,
        CREATED_TARGET_PRICE_USD,
        CREATED_DESIGN_REVENUE_SHARE,
        CREATED_ONSHARE,
        CREATED_PROJECT_VALUE_OVER_LIFETIME,
        DIN_ESTIMATED_ANNUAL_BOARDS,
        DIN_QUANTITY_PER_SYSTEM,
        DIN_TARGET_PRICE_USD,
        DIN_DESIGN_REVENUE_SHARE,
        DIN_ONSHARE,
        DIN_PROJECT_VALUE_OVER_LIFETIME,
        DWIN_ESTIMATED_ANNUAL_BOARDS,
        DWIN_QUANTITY_PER_SYSTEM,
        DWIN_TARGET_PRICE_USD,
        DWIN_DESIGN_REVENUE_SHARE,
        DWIN_ONSHARE,
        DWIN_PROJECT_VALUE_OVER_LIFETIME,
        '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
        '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
        {{V_BIW_BATCH_ID}}	 as BIW_BATCH_ID,
        BIW_LOGICAL_DELETE_FLAG,
        BIW_MD5_KEY
    FROM {{ref('ETL_MART_SALES_FUNNEL_FACT_HISTORY_ONE_TIME_LOAD')}}
    {% if is_incremental() %} 
    WHERE SNAPSHOT_DATE_KEY NOT IN
     (SELECT SNAPSHOT_DATE_KEY FROM {{this}} WHERE SOURCE_SYSTEM='MODELN')
    {%endif%}  
{%endif%}    