{{ 
config(
  description = 'ACTIVE AD USER view for Analytics', 
  materialized = 'view', 
  schema = 'ENTERPRISE', 
  tags = ['MART'],
  alias = 'AD_USER_RPT'
) 
}} 

SELECT
    AD_USER_KEY,
    USERID,
    SPLIT_PART(DISPLAYNAME,'|',-1) AS DISPLAY_NAME,
    GIVENNAME AS FIRST_NAME,
    SN AS LAST_NAME,
    EMAILADDRESS,
    AD_GROUP,
    DN,
    TITLE,
    ONCOMPANYDN,
    ONPREFERREDNAME,
    ONACCOUNTTYPE,
    ONMODIFYTIMESTAMP,
    DEPARTMENT,
    ADVS_ONCOMPANYDN,
    MANAGER,
    ADVS_ONLOCATIONDN,
    DBT_VALID_FROM AS EFFECTIVE_FROM_DATE,
    COALESCE(DBT_VALID_TO,'9999-12-31')::DATE AS EFFECTIVE_TO_DATE,
    BIW_INS_DTTM ,
    BIW_UPD_DTTM ,
    BIW_BATCH_ID,
    BIW_MD5_KEY
FROM
	{{ref('MART_AD_USER_HIST')}}
WHERE (AD_USER_KEY, DBT_VALID_FROM) IN (
    SELECT 
        AD_USER_KEY,
        MAX(DBT_VALID_FROM) 
    FROM {{ref('MART_AD_USER_HIST')}}
    GROUP BY 1
)