--dbt run --full-refresh --select ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_CMPLT
-- dbt run --select ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_CMPLT
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['LOT_TRANSACTION_ID','IS_GENERATED']-%}
{% if is_incremental() %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
--SELECT {{v_md5_column_list}}
{% endif %}

{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_CMPLT'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}

{################# Snowflake Object Configuration #################}
{{
    config(
         description = 'Building table E2O_LOT_TXN_DTL_CMPLT for MART_E2OPEN'
        ,transient=true
        ,materialized='incremental'
        ,schema ='ETL_MART_E2OPEN'
        ,alias='E2O_LOT_TXN_DTL_CMPLT'
		,unique_key= v_pk_list
        ,tags =['E2OPEN']
		,merge_update_columns = ['SYSTEM_LOT_NUMBER', 'MES_LOT_NAME', 'LOT_ID', 'LOCATION', 'LOT_TYPE', 'LOT_CATEGORY', 'LOT_STATE', 'STAGE_SET', 'TRANSACTION_SOURCE', 
								'TRANSACTION_PHYSICAL_SOURCE', 'ROW_NUMBER', 'TRANSACTION_POST_UDT', 'SYSTEM_TRANSACTION_UDT', 'TRANSACTION_PROCEDURE_SEGMENT', 'TRANSACTION_TYPE',
								'TRANSACTION_REASON_CODE', 'TRANSACTION_COMMENTS', 'TRANSACTION_ERROR_THRESHOLD_ID', 'IS_TRANSACTION_REVERSED', 'MES_TRANSACTION_TYPE', 
								'MES_TRANSACTION_UDT', 'MES_TRANSACTION_TIME_WW', 'MES_USER_NAME', 'FROM_LOT_ID', 'FROM_MES_LOT_NAME', 'PREVIOUS_MES_LOT_NAME', 
								'NEW_MES_LOT_NAME', 'EXTERNAL_LOT_NAME', 'IMMEDIATE_PARENT_EXTERNAL_LOT', 'BOH_LOT_TYPE', 'EOH_LOT_TYPE', 'BOH_PART_ID', 
								'EOH_PART_ID', 'PART_ID', 'PACKAGE_TYPE', 'ECAT', 'EXTERNAL_PART_ID', 'FROM_LOT_PART_ID', 'BOH_STAGE_SET', 'EOH_STAGE_SET', 
								'BOH_GOOD_WAFER_QUANTITY', 'EOH_GOOD_WAFER_QUANTITY', 'GOOD_WAFER_QUANTITY', 'BOH_REJECT_WAFER_QUANTITY', 'EOH_REJECT_WAFER_QUANTITY', 
								'REJECT_WAFER_QUANTITY', 'BOH_TOTAL_WAFER_QUANTITY', 'EOH_TOTAL_WAFER_QUANTITY', 'BOH_GOOD_DIE_QUANTITY', 'EOH_GOOD_DIE_QUANTITY', 
								'GOOD_DIE_QUANTITY', 'BOH_REJECT_DIE_QUANTITY', 'EOH_REJECT_DIE_QUANTITY', 'REJECT_DIE_QUANTITY', 'BOH_TOTAL_DIE_QUANTITY', 
								'EOH_TOTAL_DIE_QUANTITY', 'BOH_FROM_LOT_GOOD_WAFER_QUANTITY', 'EOH_FROM_GOOD_WAFER_QUANTITY', 'BOH_FROM_REJECT_WAFER_QUANTITY', 
								'EOH_FROM_REJECT_WAFER_QUANTITY', 'BOH_FROM_TOTAL_WAFER_QUANTITY', 'EOH_FROM_TOTAL_WAFER_QUANTITY', 'BOH_FROM_GOOD_DIE_QUANTITY', 
								'EOH_FROM_GOOD_DIE_QUANTITY', 'BOH_FROM_REJECT_DIE_QUANTITY', 'EOH_FROM_REJECT_DIE_QUANTITY', 'BOH_FROM_TOTAL_DIE_QUANTITY', 
								'EOH_FROM_TOTAL_DIE_QUANTITY', 'IS_VALUE', 'RMA_NUMBER', 'MRB_CASE_NUMBERS', 'IS_MAVERICK_LOT', 'HTS_COUNTRY', 'SUPPLIER', 
								'SUPPLIER_NAME', 'SUPPLIER_LOCATION', 'SUPPLIER_PO_NUMBER', 'SALES_ORDER_ID', 'SHIPMENT_INVOICE_NUMBER', 'SHIPMENT_TRANSFER_PRICE_USED', 
								'IS_RETURN_SHIPMENT', 'SHIP_TO_CUSTOMER', 'JIT_LOCATION', 'WIP_START_UDT', 'WIP_END_UDT', 'PROCESS_PATH', 'COUNTRY_OF_SUBSTRATE', 
								'COUNTRY_OF_DIFFUSION', 'FAB_LOCATION', 'FAB_MES_LOT_NAME', 'FAB_START_UDT', 'FAB_END_UDT', 'FAB_DATE_CODE', 'MASK_SET', 
								'MASK_SET_REVISION', 'SHELF_RACK', 'SHELF_ROW', 'SHELF_BIN', 'PDPW', 'SEAL_OPEN_UDT', 'DISPOSITION_UDT', 'SORT_MES_LOT_NAME', 
								'SORT_START_UDT', 'SORT_END_UDT', 'INK_UDT', 'SORT_PROGRAM_NAME', 'SORT_PROGRAM_REVISION', 'SORT_PROGRAM_CHECKSUM', 'SORT_TESTER_ID', 
								'SORT_PROBER_ID', 'SORT_PROBE_CARD', 'SORT_LOADBOARD_ID', 'SORT_DUT_BOARD_ID', 'COUNTRY_OF_BUMP', 'BUMP_LOCATION', 'ASSEMBLY_MES_LOT_NAME', 
								'ASSEMBLY_START_UDT', 'ASSEMBLY_END_UDT', 'TOP_SIDE_MARK', 'BACK_SIDE_MARK', 'IS_MARKED', 'DATE_CODE', 'DATE2_CODE', 'TRACE_CODE', 'TRACE2_CODE', 
								'FINAL_TEST_MES_LOT_NAME', 'FINAL_TEST_START_UDT', 'FINAL_TEST_END_UDT', 'FINAL_TEST_TEMP', 'FINAL_TEST_PROGRAM_NAME', 'FINAL_TEST_PROGRAM_REVISION', 
								'FINAL_TEST_PROGRAM_CHECKSUM', 'FINAL_TEST_TESTER_ID', 'FINAL_TEST_HANDLER_ID', 'FINAL_TEST_LOADBOARD_ID', 'FINAL_TEST_DUT_BOARD_ID', 'DRY_PACK_SEAL_UDT', 
								'SCHEDULED_START_UDT', 'PROJECTED_OUT_UDT', 'PROJECTED_OUT_WW', 'TARGET_PART_ID', 'ASSIGNED_TO', 'GOOD_WAFER_NET_CHANGE', 'GOOD_DIE_NET_CHANGE', 
								'TO_MES_LOT_NAME', 'BIW_UPD_DTTM', 'BIW_BATCH_ID']
		,post_hook= [v_sql_upd_success_batch]	
        )
}}



WITH 
SRC_CHANGES AS
(
SELECT
	LOT_TRANSACTION_ID, 
	SYSTEM_LOT_NUMBER, 
	MES_LOT_NAME, 
	LOT_ID, 
	LOCATION, 
	LOT_TYPE, 
	LOT_CATEGORY, 
	LOT_STATE, 
	STAGE_SET, 
	TRANSACTION_SOURCE, 
	TRANSACTION_PHYSICAL_SOURCE, 
	ROW_NUMBER, 
	TRANSACTION_POST_UDT, 
	SYSTEM_TRANSACTION_UDT, 
	TRANSACTION_PROCEDURE_SEGMENT, 
	TRANSACTION_TYPE, 
	TRANSACTION_REASON_CODE, 
	TRANSACTION_COMMENTS, 
	TRANSACTION_ERROR_THRESHOLD_ID, 
	IS_TRANSACTION_REVERSED, 
	MES_TRANSACTION_TYPE, 
	MES_TRANSACTION_UDT, 
	MES_TRANSACTION_TIME_WW, 
	MES_USER_NAME, 
	FROM_LOT_ID, 
	FROM_MES_LOT_NAME, 
	PREVIOUS_MES_LOT_NAME, 
	NEW_MES_LOT_NAME, 
	EXTERNAL_LOT_NAME, 
	IMMEDIATE_PARENT_EXTERNAL_LOT, 
	BOH_LOT_TYPE, 
	EOH_LOT_TYPE, 
	BOH_PART_ID, 
	EOH_PART_ID, 
	PART_ID, 
	PACKAGE_TYPE, 
	ECAT, 
	EXTERNAL_PART_ID, 
	FROM_LOT_PART_ID, 
	BOH_STAGE_SET, 
	EOH_STAGE_SET, 
	BOH_GOOD_WAFER_QUANTITY, 
	EOH_GOOD_WAFER_QUANTITY, 
	GOOD_WAFER_QUANTITY, 
	BOH_REJECT_WAFER_QUANTITY, 
	EOH_REJECT_WAFER_QUANTITY, 
	REJECT_WAFER_QUANTITY, 
	BOH_TOTAL_WAFER_QUANTITY, 
	EOH_TOTAL_WAFER_QUANTITY, 
	BOH_GOOD_DIE_QUANTITY, 
	EOH_GOOD_DIE_QUANTITY, 
	GOOD_DIE_QUANTITY, 
	BOH_REJECT_DIE_QUANTITY, 
	EOH_REJECT_DIE_QUANTITY, 
	REJECT_DIE_QUANTITY, 
	BOH_TOTAL_DIE_QUANTITY, 
	EOH_TOTAL_DIE_QUANTITY, 
	BOH_FROM_LOT_GOOD_WAFER_QUANTITY, 
	EOH_FROM_GOOD_WAFER_QUANTITY, 
	BOH_FROM_REJECT_WAFER_QUANTITY, 
	EOH_FROM_REJECT_WAFER_QUANTITY, 
	BOH_FROM_TOTAL_WAFER_QUANTITY, 
	EOH_FROM_TOTAL_WAFER_QUANTITY, 
	BOH_FROM_GOOD_DIE_QUANTITY, 
	EOH_FROM_GOOD_DIE_QUANTITY, 
	BOH_FROM_REJECT_DIE_QUANTITY, 
	EOH_FROM_REJECT_DIE_QUANTITY, 
	BOH_FROM_TOTAL_DIE_QUANTITY, 
	EOH_FROM_TOTAL_DIE_QUANTITY, 
	IS_VALUE, 
	RMA_NUMBER, 
	MRB_CASE_NUMBERS, 
	IS_MAVERICK_LOT, 
	HTS_COUNTRY, 
	SUPPLIER, 
	SUPPLIER_NAME, 
	SUPPLIER_LOCATION, 
	SUPPLIER_PO_NUMBER, 
	SALES_ORDER_ID, 
	SHIPMENT_INVOICE_NUMBER, 
	SHIPMENT_TRANSFER_PRICE_USED, 
	IS_RETURN_SHIPMENT, 
	SHIP_TO_CUSTOMER, 
	JIT_LOCATION, 
	WIP_START_UDT, 
	WIP_END_UDT, 
	PROCESS_PATH, 
	COUNTRY_OF_SUBSTRATE, 
	COUNTRY_OF_DIFFUSION, 
	FAB_LOCATION, 
	FAB_MES_LOT_NAME, 
	FAB_START_UDT, 
	FAB_END_UDT, 
	FAB_DATE_CODE, 
	MASK_SET, 
	MASK_SET_REVISION, 
	SHELF_RACK, 
	SHELF_ROW, 
	SHELF_BIN, 
	PDPW, 
	SEAL_OPEN_UDT, 
	DISPOSITION_UDT, 
	SORT_MES_LOT_NAME, 
	SORT_START_UDT, 
	SORT_END_UDT, 
	INK_UDT, 
	SORT_PROGRAM_NAME, 
	SORT_PROGRAM_REVISION, 
	SORT_PROGRAM_CHECKSUM, 
	SORT_TESTER_ID, 
	SORT_PROBER_ID, 
	SORT_PROBE_CARD, 
	SORT_LOADBOARD_ID, 
	SORT_DUT_BOARD_ID, 
	COUNTRY_OF_BUMP, 
	BUMP_LOCATION, 
	ASSEMBLY_MES_LOT_NAME, 
	ASSEMBLY_START_UDT, 
	ASSEMBLY_END_UDT, 
	TOP_SIDE_MARK, 
	BACK_SIDE_MARK, 
	IS_MARKED, 
	DATE_CODE, 
	DATE2_CODE, 
	TRACE_CODE, 
	TRACE2_CODE, 
	FINAL_TEST_MES_LOT_NAME, 
	FINAL_TEST_START_UDT, 
	FINAL_TEST_END_UDT, 
	FINAL_TEST_TEMP, 
	FINAL_TEST_PROGRAM_NAME, 
	FINAL_TEST_PROGRAM_REVISION, 
	FINAL_TEST_PROGRAM_CHECKSUM, 
	FINAL_TEST_TESTER_ID, 
	FINAL_TEST_HANDLER_ID, 
	FINAL_TEST_LOADBOARD_ID, 
	FINAL_TEST_DUT_BOARD_ID, 
	DRY_PACK_SEAL_UDT, 
	SCHEDULED_START_UDT, 
	PROJECTED_OUT_UDT, 
	PROJECTED_OUT_WW, 
	TARGET_PART_ID, 
	ASSIGNED_TO, 
	CASE
		WHEN TRANSACTION_TYPE = 'CreateLot' 
			THEN EOH_GOOD_WAFER_QUANTITY 
		ELSE EOH_GOOD_WAFER_QUANTITY - BOH_GOOD_WAFER_QUANTITY 
	END AS GOOD_WAFER_NET_CHANGE,
	CASE 
		WHEN TRANSACTION_TYPE = 'CreateLot' 
			THEN EOH_GOOD_DIE_QUANTITY 
		ELSE  EOH_GOOD_DIE_QUANTITY - BOH_GOOD_DIE_QUANTITY 
	END AS GOOD_DIE_NET_CHANGE,
	NULL AS TO_MES_LOT_NAME,
	'N'::BOOLEAN AS IS_GENERATED,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
	{{V_BIW_BATCH_ID}} as BIW_BATCH_ID
FROM {{ ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL') }}
    {% if is_incremental() %}
		WHERE BIW_UPD_DTTM >= '{{V_LWM}}'
		AND BIW_UPD_DTTM < '{{V_HWM}}'
    {% endif %}
), 
-- MISSING RECORDS
MISSING_DATA AS
(
SELECT
	RL.LOT_TRANSACTION_ID,
	SL.SYSTEM_LOT_NUMBER,
	SL.MES_LOT_NAME,
	SL.LOT_ID,
	SL.LOCATION,
	SL.LOT_TYPE,
	SL.LOT_CATEGORY,
	SL.LOT_STATE,
	SL.STAGE_SET,
	RL.TRANSACTION_SOURCE,
	RL.TRANSACTION_PHYSICAL_SOURCE,
	RL.ROW_NUMBER,
	RL.TRANSACTION_POST_UDT,
	RL.SYSTEM_TRANSACTION_UDT,
	RL.TRANSACTION_PROCEDURE_SEGMENT,
	RL.TRANSACTION_TYPE,
	RL.TRANSACTION_REASON_CODE,
	RL.TRANSACTION_COMMENTS,
	RL.TRANSACTION_ERROR_THRESHOLD_ID,
	RL.IS_TRANSACTION_REVERSED,
	RL.MES_TRANSACTION_TYPE,
	RL.MES_TRANSACTION_UDT,
	RL.MES_TRANSACTION_TIME_WW,
	RL.MES_USER_NAME,
	NULL AS FROM_LOT_ID,
	NULL AS FROM_MES_LOT_NAME,
	SL.PREVIOUS_MES_LOT_NAME,
	SL.NEW_MES_LOT_NAME,
	SL.EXTERNAL_LOT_NAME,
	SL.IMMEDIATE_PARENT_EXTERNAL_LOT,
	SL.EOH_LOT_TYPE AS BOH_LOT_TYPE,
	SL.EOH_LOT_TYPE,
	SL.EOH_PART_ID AS BOH_PART_ID,
	SL.EOH_PART_ID,
	SL.PART_ID,
	SL.PACKAGE_TYPE,
	SL.ECAT,
	SL.EXTERNAL_PART_ID,
	SL.FROM_LOT_PART_ID,
	SL.EOH_STAGE_SET AS BOH_STAGE_SET,
	SL.EOH_STAGE_SET,
	RL.BOH_FROM_LOT_GOOD_WAFER_QUANTITY AS BOH_GOOD_WAFER_QUANTITY,
	RL.EOH_FROM_GOOD_WAFER_QUANTITY AS EOH_GOOD_WAFER_QUANTITY,
	RL.EOH_FROM_GOOD_WAFER_QUANTITY AS GOOD_WAFER_QUANTITY,
	RL.BOH_FROM_REJECT_WAFER_QUANTITY AS BOH_REJECT_WAFER_QUANTITY,
	RL.EOH_FROM_REJECT_WAFER_QUANTITY AS EOH_REJECT_WAFER_QUANTITY,
	RL.EOH_FROM_REJECT_WAFER_QUANTITY AS REJECT_WAFER_QUANTITY,
	RL.BOH_FROM_TOTAL_WAFER_QUANTITY AS BOH_TOTAL_WAFER_QUANTITY,
	RL.EOH_FROM_TOTAL_WAFER_QUANTITY AS EOH_TOTAL_WAFER_QUANTITY,
	RL.BOH_FROM_GOOD_DIE_QUANTITY AS BOH_GOOD_DIE_QUANTITY,
	RL.EOH_FROM_GOOD_DIE_QUANTITY AS EOH_GOOD_DIE_QUANTITY,
	RL.EOH_FROM_GOOD_DIE_QUANTITY AS GOOD_DIE_QUANTITY,
	RL.BOH_FROM_REJECT_DIE_QUANTITY AS BOH_REJECT_DIE_QUANTITY,
	RL.EOH_FROM_REJECT_DIE_QUANTITY AS EOH_REJECT_DIE_QUANTITY,
	RL.EOH_FROM_REJECT_DIE_QUANTITY AS REJECT_DIE_QUANTITY,
	RL.BOH_FROM_TOTAL_DIE_QUANTITY AS BOH_TOTAL_DIE_QUANTITY,
	RL.EOH_FROM_TOTAL_DIE_QUANTITY AS EOH_TOTAL_DIE_QUANTITY,
	NULL AS  BOH_FROM_LOT_GOOD_WAFER_QUANTITY,
	NULL AS  EOH_FROM_GOOD_WAFER_QUANTITY,
	NULL AS  BOH_FROM_REJECT_WAFER_QUANTITY,
	NULL AS  EOH_FROM_REJECT_WAFER_QUANTITY,
	NULL AS  BOH_FROM_TOTAL_WAFER_QUANTITY,
	NULL AS  EOH_FROM_TOTAL_WAFER_QUANTITY,
	NULL AS  BOH_FROM_GOOD_DIE_QUANTITY,
	NULL AS  EOH_FROM_GOOD_DIE_QUANTITY,
	NULL AS  BOH_FROM_REJECT_DIE_QUANTITY,
	NULL AS  EOH_FROM_REJECT_DIE_QUANTITY,
	NULL AS  BOH_FROM_TOTAL_DIE_QUANTITY,
	NULL AS  EOH_FROM_TOTAL_DIE_QUANTITY,
	SL.IS_VALUE,
	SL.RMA_NUMBER,
	SL.MRB_CASE_NUMBERS,
	SL.IS_MAVERICK_LOT,
	SL.HTS_COUNTRY,
	SL.SUPPLIER,
	SL.SUPPLIER_NAME,
	SL.SUPPLIER_LOCATION,
	SL.SUPPLIER_PO_NUMBER,
	SL.SALES_ORDER_ID,
	SL.SHIPMENT_INVOICE_NUMBER,
	SL.SHIPMENT_TRANSFER_PRICE_USED,
	SL.IS_RETURN_SHIPMENT,
	SL.SHIP_TO_CUSTOMER,
	SL.JIT_LOCATION,
	SL.WIP_START_UDT,
	SL.WIP_END_UDT,
	SL.PROCESS_PATH,
	SL.COUNTRY_OF_SUBSTRATE,
	SL.COUNTRY_OF_DIFFUSION,
	SL.FAB_LOCATION,
	SL.FAB_MES_LOT_NAME,
	SL.FAB_START_UDT,
	SL.FAB_END_UDT,
	SL.FAB_DATE_CODE,
	SL.MASK_SET,
	SL.MASK_SET_REVISION,
	SL.SHELF_RACK,
	SL.SHELF_ROW,
	SL.SHELF_BIN,
	SL.PDPW,
	SL.SEAL_OPEN_UDT,
	SL.DISPOSITION_UDT,
	SL.SORT_MES_LOT_NAME,
	SL.SORT_START_UDT,
	SL.SORT_END_UDT,
	SL.INK_UDT,
	SL.SORT_PROGRAM_NAME,
	SL.SORT_PROGRAM_REVISION,
	SL.SORT_PROGRAM_CHECKSUM,
	SL.SORT_TESTER_ID,
	SL.SORT_PROBER_ID,
	SL.SORT_PROBE_CARD,
	SL.SORT_LOADBOARD_ID,
	SL.SORT_DUT_BOARD_ID,
	SL.COUNTRY_OF_BUMP,
	SL.BUMP_LOCATION,
	SL.ASSEMBLY_MES_LOT_NAME,
	SL.ASSEMBLY_START_UDT,
	SL.ASSEMBLY_END_UDT,
	SL.TOP_SIDE_MARK,
	SL.BACK_SIDE_MARK,
	SL.IS_MARKED,
	SL.DATE_CODE,
	SL.DATE2_CODE,
	SL.TRACE_CODE,
	SL.TRACE2_CODE,
	SL.FINAL_TEST_MES_LOT_NAME,
	SL.FINAL_TEST_START_UDT,
	SL.FINAL_TEST_END_UDT,
	SL.FINAL_TEST_TEMP,
	SL.FINAL_TEST_PROGRAM_NAME,
	SL.FINAL_TEST_PROGRAM_REVISION,
	SL.FINAL_TEST_PROGRAM_CHECKSUM,
	SL.FINAL_TEST_TESTER_ID,
	SL.FINAL_TEST_HANDLER_ID,
	SL.FINAL_TEST_LOADBOARD_ID,
	SL.FINAL_TEST_DUT_BOARD_ID,
	SL.DRY_PACK_SEAL_UDT,
	SL.SCHEDULED_START_UDT,
	SL.PROJECTED_OUT_UDT,
	SL.PROJECTED_OUT_WW,
	SL.TARGET_PART_ID,
	SL.ASSIGNED_TO,
	(RL.EOH_FROM_GOOD_WAFER_QUANTITY - RL.BOH_FROM_LOT_GOOD_WAFER_QUANTITY) AS GOOD_WAFER_NET_CHANGE,
	(RL.EOH_FROM_GOOD_DIE_QUANTITY - RL.BOH_FROM_GOOD_DIE_QUANTITY) AS GOOD_DIE_NET_CHANGE,
	RL.MES_LOT_NAME AS TO_MES_LOT_NAME,
	'Y'::BOOLEAN AS IS_GENERATED,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM,
	{{V_BIW_BATCH_ID}} as BIW_BATCH_ID
		FROM {{ ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL') }} RL
	JOIN  {{ ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL') }}  SL 
		ON RL.FROM_MES_LOT_NAME=SL.MES_LOT_NAME
	WHERE  RL.TRANSACTION_TYPE IN ('SplitLot','CombineLot','ConsumeLot')
	AND RL.LOT_TRANSACTION_ID > SL.LOT_TRANSACTION_ID
	{% if is_incremental() %}
	--incremental data logic from receiving lot 
		AND RL.BIW_UPD_DTTM >= '{{V_LWM}}'
		AND RL.BIW_UPD_DTTM < '{{V_HWM}}'
	{% endif %}
	QUALIFY (ROW_NUMBER() OVER (PARTITION BY RL.LOT_TRANSACTION_ID ,RL.MES_LOT_NAME ORDER BY RL.LOT_TRANSACTION_ID DESC,SL.LOT_TRANSACTION_ID DESC))=1
)

SELECT  *,
	md5(object_construct ('col1',SYSTEM_LOT_NUMBER, 'col2',MES_LOT_NAME, 'col3',LOT_ID, 'col4',LOCATION, 'col5',LOT_TYPE, 'col6',LOT_CATEGORY, 'col7',LOT_STATE, 
	'col8',STAGE_SET, 'col9',TRANSACTION_SOURCE, 'col10',TRANSACTION_PHYSICAL_SOURCE, 'col11',ROW_NUMBER, 'col12',TRANSACTION_POST_UDT, 'col13',SYSTEM_TRANSACTION_UDT, 
	'col14',TRANSACTION_PROCEDURE_SEGMENT, 'col15',TRANSACTION_TYPE, 'col16',TRANSACTION_REASON_CODE, 'col17',TRANSACTION_COMMENTS, 'col18',TRANSACTION_ERROR_THRESHOLD_ID, 
	'col19',IS_TRANSACTION_REVERSED, 'col20',MES_TRANSACTION_TYPE, 'col21',MES_TRANSACTION_UDT, 'col22',MES_TRANSACTION_TIME_WW, 'col23',MES_USER_NAME, 'col24',FROM_LOT_ID, 
	'col25',FROM_MES_LOT_NAME, 'col26',PREVIOUS_MES_LOT_NAME, 'col27',NEW_MES_LOT_NAME, 'col28',EXTERNAL_LOT_NAME, 'col29',IMMEDIATE_PARENT_EXTERNAL_LOT, 'col30',BOH_LOT_TYPE, 
	'col31',EOH_LOT_TYPE, 'col32',BOH_PART_ID, 'col33',EOH_PART_ID, 'col34',PART_ID, 'col35',PACKAGE_TYPE, 'col36',ECAT, 'col37',EXTERNAL_PART_ID, 'col38',FROM_LOT_PART_ID, 
	'col39',BOH_STAGE_SET, 'col40',EOH_STAGE_SET, 'col41',BOH_GOOD_WAFER_QUANTITY, 'col42',EOH_GOOD_WAFER_QUANTITY, 'col43',GOOD_WAFER_QUANTITY, 'col44',BOH_REJECT_WAFER_QUANTITY, 
	'col45',EOH_REJECT_WAFER_QUANTITY, 'col46',REJECT_WAFER_QUANTITY, 'col47',BOH_TOTAL_WAFER_QUANTITY, 'col48',EOH_TOTAL_WAFER_QUANTITY, 'col49',BOH_GOOD_DIE_QUANTITY, 
	'col50',EOH_GOOD_DIE_QUANTITY, 'col51',GOOD_DIE_QUANTITY, 'col52',BOH_REJECT_DIE_QUANTITY, 'col53',EOH_REJECT_DIE_QUANTITY, 'col54',REJECT_DIE_QUANTITY, 
	'col55',BOH_TOTAL_DIE_QUANTITY, 'col56',EOH_TOTAL_DIE_QUANTITY, 'col57',BOH_FROM_LOT_GOOD_WAFER_QUANTITY, 'col58',EOH_FROM_GOOD_WAFER_QUANTITY, 
	'col59',BOH_FROM_REJECT_WAFER_QUANTITY, 'col60',EOH_FROM_REJECT_WAFER_QUANTITY, 'col61',BOH_FROM_TOTAL_WAFER_QUANTITY, 'col62',EOH_FROM_TOTAL_WAFER_QUANTITY, 
	'col63',BOH_FROM_GOOD_DIE_QUANTITY, 'col64',EOH_FROM_GOOD_DIE_QUANTITY, 'col65',BOH_FROM_REJECT_DIE_QUANTITY, 'col66',EOH_FROM_REJECT_DIE_QUANTITY, 
	'col67',BOH_FROM_TOTAL_DIE_QUANTITY, 'col68',EOH_FROM_TOTAL_DIE_QUANTITY, 'col69',IS_VALUE, 'col70',RMA_NUMBER, 'col71',MRB_CASE_NUMBERS, 'col72',IS_MAVERICK_LOT, 
	'col73',HTS_COUNTRY, 'col74',SUPPLIER, 'col75',SUPPLIER_NAME, 'col76',SUPPLIER_LOCATION, 'col77',SUPPLIER_PO_NUMBER, 'col78',SALES_ORDER_ID, 
	'col79',SHIPMENT_INVOICE_NUMBER, 'col80',SHIPMENT_TRANSFER_PRICE_USED, 'col81',IS_RETURN_SHIPMENT, 'col82',SHIP_TO_CUSTOMER, 'col83',JIT_LOCATION, 
	'col84',WIP_START_UDT, 'col85',WIP_END_UDT, 'col86',PROCESS_PATH, 'col87',COUNTRY_OF_SUBSTRATE, 'col88',COUNTRY_OF_DIFFUSION, 'col89',FAB_LOCATION, 
	'col90',FAB_MES_LOT_NAME, 'col91',FAB_START_UDT, 'col92',FAB_END_UDT, 'col93',FAB_DATE_CODE, 'col94',MASK_SET, 'col95',MASK_SET_REVISION, 
	'col96',SHELF_RACK, 'col97',SHELF_ROW, 'col98',SHELF_BIN, 'col99',PDPW, 'col100',SEAL_OPEN_UDT, 'col101',DISPOSITION_UDT, 'col102',SORT_MES_LOT_NAME, 
	'col103',SORT_START_UDT, 'col104',SORT_END_UDT, 'col105',INK_UDT, 'col106',SORT_PROGRAM_NAME, 'col107',SORT_PROGRAM_REVISION, 'col108',SORT_PROGRAM_CHECKSUM, 
	'col109',SORT_TESTER_ID, 'col110',SORT_PROBER_ID, 'col111',SORT_PROBE_CARD, 'col112',SORT_LOADBOARD_ID, 'col113',SORT_DUT_BOARD_ID, 'col114',COUNTRY_OF_BUMP, 
	'col115',BUMP_LOCATION, 'col116',ASSEMBLY_MES_LOT_NAME, 'col117',ASSEMBLY_START_UDT, 'col118',ASSEMBLY_END_UDT, 'col119',TOP_SIDE_MARK, 'col120',BACK_SIDE_MARK, 
	'col121',IS_MARKED, 'col122',DATE_CODE, 'col123',DATE2_CODE, 'col124',TRACE_CODE, 'col125',TRACE2_CODE, 'col126',FINAL_TEST_MES_LOT_NAME, 'col127',FINAL_TEST_START_UDT, 
	'col128',FINAL_TEST_END_UDT, 'col129',FINAL_TEST_TEMP, 'col130',FINAL_TEST_PROGRAM_NAME, 'col131',FINAL_TEST_PROGRAM_REVISION, 'col132',FINAL_TEST_PROGRAM_CHECKSUM, 
	'col133',FINAL_TEST_TESTER_ID, 'col134',FINAL_TEST_HANDLER_ID, 'col135',FINAL_TEST_LOADBOARD_ID, 'col136',FINAL_TEST_DUT_BOARD_ID, 'col137',DRY_PACK_SEAL_UDT, 
	'col138',SCHEDULED_START_UDT, 'col139',PROJECTED_OUT_UDT, 'col140',PROJECTED_OUT_WW, 'col141',TARGET_PART_ID, 'col142',ASSIGNED_TO, 'col143',GOOD_WAFER_NET_CHANGE, 
	'col144',GOOD_DIE_NET_CHANGE, 'col145',TO_MES_LOT_NAME)::string ) as BIW_MD5_KEY

FROM SRC_CHANGES 
UNION ALL
SELECT   *,
	md5(object_construct ('col1',SYSTEM_LOT_NUMBER, 'col2',MES_LOT_NAME, 'col3',LOT_ID, 'col4',LOCATION, 'col5',LOT_TYPE, 'col6',LOT_CATEGORY, 'col7',LOT_STATE, 
	'col8',STAGE_SET, 'col9',TRANSACTION_SOURCE, 'col10',TRANSACTION_PHYSICAL_SOURCE, 'col11',ROW_NUMBER, 'col12',TRANSACTION_POST_UDT, 'col13',SYSTEM_TRANSACTION_UDT, 
	'col14',TRANSACTION_PROCEDURE_SEGMENT, 'col15',TRANSACTION_TYPE, 'col16',TRANSACTION_REASON_CODE, 'col17',TRANSACTION_COMMENTS, 'col18',TRANSACTION_ERROR_THRESHOLD_ID, 
	'col19',IS_TRANSACTION_REVERSED, 'col20',MES_TRANSACTION_TYPE, 'col21',MES_TRANSACTION_UDT, 'col22',MES_TRANSACTION_TIME_WW, 'col23',MES_USER_NAME, 'col24',FROM_LOT_ID, 
	'col25',FROM_MES_LOT_NAME, 'col26',PREVIOUS_MES_LOT_NAME, 'col27',NEW_MES_LOT_NAME, 'col28',EXTERNAL_LOT_NAME, 'col29',IMMEDIATE_PARENT_EXTERNAL_LOT, 'col30',BOH_LOT_TYPE, 
	'col31',EOH_LOT_TYPE, 'col32',BOH_PART_ID, 'col33',EOH_PART_ID, 'col34',PART_ID, 'col35',PACKAGE_TYPE, 'col36',ECAT, 'col37',EXTERNAL_PART_ID, 'col38',FROM_LOT_PART_ID, 
	'col39',BOH_STAGE_SET, 'col40',EOH_STAGE_SET, 'col41',BOH_GOOD_WAFER_QUANTITY, 'col42',EOH_GOOD_WAFER_QUANTITY, 'col43',GOOD_WAFER_QUANTITY, 'col44',BOH_REJECT_WAFER_QUANTITY, 
	'col45',EOH_REJECT_WAFER_QUANTITY, 'col46',REJECT_WAFER_QUANTITY, 'col47',BOH_TOTAL_WAFER_QUANTITY, 'col48',EOH_TOTAL_WAFER_QUANTITY, 'col49',BOH_GOOD_DIE_QUANTITY, 
	'col50',EOH_GOOD_DIE_QUANTITY, 'col51',GOOD_DIE_QUANTITY, 'col52',BOH_REJECT_DIE_QUANTITY, 'col53',EOH_REJECT_DIE_QUANTITY, 'col54',REJECT_DIE_QUANTITY, 
	'col55',BOH_TOTAL_DIE_QUANTITY, 'col56',EOH_TOTAL_DIE_QUANTITY, 'col57',BOH_FROM_LOT_GOOD_WAFER_QUANTITY, 'col58',EOH_FROM_GOOD_WAFER_QUANTITY, 
	'col59',BOH_FROM_REJECT_WAFER_QUANTITY, 'col60',EOH_FROM_REJECT_WAFER_QUANTITY, 'col61',BOH_FROM_TOTAL_WAFER_QUANTITY, 'col62',EOH_FROM_TOTAL_WAFER_QUANTITY, 
	'col63',BOH_FROM_GOOD_DIE_QUANTITY, 'col64',EOH_FROM_GOOD_DIE_QUANTITY, 'col65',BOH_FROM_REJECT_DIE_QUANTITY, 'col66',EOH_FROM_REJECT_DIE_QUANTITY, 
	'col67',BOH_FROM_TOTAL_DIE_QUANTITY, 'col68',EOH_FROM_TOTAL_DIE_QUANTITY, 'col69',IS_VALUE, 'col70',RMA_NUMBER, 'col71',MRB_CASE_NUMBERS, 'col72',IS_MAVERICK_LOT, 
	'col73',HTS_COUNTRY, 'col74',SUPPLIER, 'col75',SUPPLIER_NAME, 'col76',SUPPLIER_LOCATION, 'col77',SUPPLIER_PO_NUMBER, 'col78',SALES_ORDER_ID, 
	'col79',SHIPMENT_INVOICE_NUMBER, 'col80',SHIPMENT_TRANSFER_PRICE_USED, 'col81',IS_RETURN_SHIPMENT, 'col82',SHIP_TO_CUSTOMER, 'col83',JIT_LOCATION, 
	'col84',WIP_START_UDT, 'col85',WIP_END_UDT, 'col86',PROCESS_PATH, 'col87',COUNTRY_OF_SUBSTRATE, 'col88',COUNTRY_OF_DIFFUSION, 'col89',FAB_LOCATION, 
	'col90',FAB_MES_LOT_NAME, 'col91',FAB_START_UDT, 'col92',FAB_END_UDT, 'col93',FAB_DATE_CODE, 'col94',MASK_SET, 'col95',MASK_SET_REVISION, 
	'col96',SHELF_RACK, 'col97',SHELF_ROW, 'col98',SHELF_BIN, 'col99',PDPW, 'col100',SEAL_OPEN_UDT, 'col101',DISPOSITION_UDT, 'col102',SORT_MES_LOT_NAME, 
	'col103',SORT_START_UDT, 'col104',SORT_END_UDT, 'col105',INK_UDT, 'col106',SORT_PROGRAM_NAME, 'col107',SORT_PROGRAM_REVISION, 'col108',SORT_PROGRAM_CHECKSUM, 
	'col109',SORT_TESTER_ID, 'col110',SORT_PROBER_ID, 'col111',SORT_PROBE_CARD, 'col112',SORT_LOADBOARD_ID, 'col113',SORT_DUT_BOARD_ID, 'col114',COUNTRY_OF_BUMP, 
	'col115',BUMP_LOCATION, 'col116',ASSEMBLY_MES_LOT_NAME, 'col117',ASSEMBLY_START_UDT, 'col118',ASSEMBLY_END_UDT, 'col119',TOP_SIDE_MARK, 'col120',BACK_SIDE_MARK, 
	'col121',IS_MARKED, 'col122',DATE_CODE, 'col123',DATE2_CODE, 'col124',TRACE_CODE, 'col125',TRACE2_CODE, 'col126',FINAL_TEST_MES_LOT_NAME, 'col127',FINAL_TEST_START_UDT, 
	'col128',FINAL_TEST_END_UDT, 'col129',FINAL_TEST_TEMP, 'col130',FINAL_TEST_PROGRAM_NAME, 'col131',FINAL_TEST_PROGRAM_REVISION, 'col132',FINAL_TEST_PROGRAM_CHECKSUM, 
	'col133',FINAL_TEST_TESTER_ID, 'col134',FINAL_TEST_HANDLER_ID, 'col135',FINAL_TEST_LOADBOARD_ID, 'col136',FINAL_TEST_DUT_BOARD_ID, 'col137',DRY_PACK_SEAL_UDT, 
	'col138',SCHEDULED_START_UDT, 'col139',PROJECTED_OUT_UDT, 'col140',PROJECTED_OUT_WW, 'col141',TARGET_PART_ID, 'col142',ASSIGNED_TO, 'col143',GOOD_WAFER_NET_CHANGE, 
	'col144',GOOD_DIE_NET_CHANGE, 'col145',TO_MES_LOT_NAME)::string ) as BIW_MD5_KEY
	FROM MISSING_DATA 
 