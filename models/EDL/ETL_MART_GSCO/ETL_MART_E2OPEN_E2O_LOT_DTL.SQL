--dbt run --full-refresh --select ETL_MART_E2OPEN_E2O_LOT_DTL
-- dbt run --select ETL_MART_E2OPEN_E2O_LOT_DTL
--"ETL_E2O_LOT_DTL"
-- depends_on: {{ ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_DRVD_UPDATE_STG') }}
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['SYSTEM_LOT_NUMBER']-%}
{% if is_incremental() %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
--SELECT {{v_md5_column_list}}
{% endif %}

{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_E2OPEN_E2O_LOT_DTL'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}

{################# Snowflake Object Configuration #################}
{{
    config(
         description = 'Building table E2O_LOT_TXN_DTL for MART_E2OPEN'
        ,transient=true
        ,materialized='incremental'
        ,schema ='ETL_MART_E2OPEN'
        ,alias='E2O_LOT_DTL'
		,unique_key= v_pk_list
        ,tags =['E2OPEN']
		,merge_update_columns = ['MES_LOT_NAME', 'LOT_TRANSACTION_ID', 'LOT_ID', 'UPDATED_ON_UDT', 'LOCATION', 'LOT_TYPE',
                                'LOT_CATEGORY', 'LOT_STATE', 'STAGE_SET', 'FROM_LOT_ID', 'FROM_MES_LOT_NAME', 'TO_MES_LOT_NAME',
                                'PREVIOUS_MES_LOT_NAME', 'NEW_MES_LOT_NAME', 'EXTERNAL_LOT_NAME', 'IMMEDIATE_PARENT_EXTERNAL_LOT', 'BOH_LOT_TYPE',
                                'EOH_LOT_TYPE', 'BOH_PART_ID', 'EOH_PART_ID', 'PART_ID', 'PACKAGE_TYPE', 'ECAT', 'IS_IN_TRANSIT', 'IS_HOLD',
                                'IS_REWORK', 'HOLD_COUNT', 'LOT_HOLD_REASON', 'LOT_HOLD_TRANSACTION_UDT', 'EXTERNAL_PART_ID',
                                'FROM_LOT_PART_ID', 'BOH_STAGE_SET', 'EOH_STAGE_SET', 'BOH_GOOD_WAFER_QUANTITY', 'EOH_GOOD_WAFER_QUANTITY',
                                'GOOD_WAFER_QUANTITY', 'BOH_REJECT_WAFER_QUANTITY', 'EOH_REJECT_WAFER_QUANTITY', 'REJECT_WAFER_QUANTITY',
                                'BOH_TOTAL_WAFER_QUANTITY', 'EOH_TOTAL_WAFER_QUANTITY', 'BOH_GOOD_DIE_QUANTITY', 'EOH_GOOD_DIE_QUANTITY', 'GOOD_DIE_QUANTITY',
                                'BOH_REJECT_DIE_QUANTITY', 'EOH_REJECT_DIE_QUANTITY', 'REJECT_DIE_QUANTITY', 'BOH_TOTAL_DIE_QUANTITY',
                                'EOH_TOTAL_DIE_QUANTITY', 'IS_VALUE', 'RMA_NUMBER', 'MRB_CASE_NUMBERS', 'IS_MAVERICK_LOT', 'HTS_COUNTRY', 'SUPPLIER',
                                'SUPPLIER_NAME', 'SUPPLIER_LOCATION', 'SUPPLIER_PO_NUMBER', 'SALES_ORDER_ID', 'SHIPMENT_INVOICE_NUMBER',
                                'SHIPMENT_TRANSFER_PRICE_USED', 'IS_RETURN_SHIPMENT', 'SHIP_TO_CUSTOMER', 'JIT_LOCATION', 'WIP_START_UDT', 'WIP_END_UDT',
                                'PROCESS_PATH', 'COUNTRY_OF_SUBSTRATE', 'COUNTRY_OF_DIFFUSION', 'COUNTRY_OF_FAB', 'FAB_LOCATION', 'FAB_AREA',
                                'FAB_MES_LOT_NAME', 'FAB_PART_ID', 'FAB_START_UDT', 'FAB_END_UDT', 'FAB_DATE_CODE', 'MASK_SET', 'MASK_SET_REVISION',
                                'SHELF_RACK', 'SHELF_ROW', 'SHELF_BIN', 'PDPW', 'SEAL_OPEN_UDT', 'DISPOSITION_UDT', 'COUNTRY_OF_SORT',
                                'SORT_LOCATION', 'SORT_AREA', 'SORT_MES_LOT_NAME', 'SORT_PART_ID', 'SORT_START_UDT', 'SORT_END_UDT', 'INK_UDT',
                                'SORT_PROGRAM_NAME', 'SORT_PROGRAM_REVISION', 'SORT_PROGRAM_CHECKSUM', 'SORT_TESTER_ID', 'SORT_PROBER_ID',
                                'SORT_PROBE_CARD', 'SORT_LOADBOARD_ID', 'SORT_DUT_BOARD_ID', 'COUNTRY_OF_BUMP', 'BUMP_LOCATION',
                                'COUNTRY_OF_ASSEMBLY', 'ASSEMBLY_LOCATION', 'ASSEMBLY_AREA', 'ASSEMBLY_MES_LOT_NAME', 'ASSEMBLY_PART_ID',
                                'ASSEMBLY_START_UDT', 'ASSEMBLY_END_UDT', 'TOP_SIDE_MARK', 'BACK_SIDE_MARK', 'IS_MARKED', 'DATE_CODE', 'DATE2_CODE',
                                'TRACE_CODE', 'TRACE2_CODE', 'COUNTRY_OF_FINAL_TEST', 'FINAL_TEST_LOCATION', 'FINAL_TEST_AREA',
                                'FINAL_TEST_MES_LOT_NAME', 'FINAL_TEST_PART_ID', 'FINAL_TEST_START_UDT', 'FINAL_TEST_END_UDT', 'FINAL_TEST_TEMP',
                                'FINAL_TEST_PROGRAM_NAME', 'FINAL_TEST_PROGRAM_REVISION', 'FINAL_TEST_PROGRAM_CHECKSUM', 'FINAL_TEST_TESTER_ID',
                                'FINAL_TEST_HANDLER_ID', 'FINAL_TEST_LOADBOARD_ID', 'FINAL_TEST_DUT_BOARD_ID', 'DRY_PACK_SEAL_UDT', 'SCHEDULED_START_UDT',
                                'PROJECTED_OUT_UDT', 'PROJECTED_OUT_WW', 'TARGET_PART_ID', 'ASSIGNED_TO', 'MOST_RECENT_MOVE_TRANSACTION_UDT',
                                'LOCATION_MOVE_IN_MES_TRANSACTION_UDT', 'IS_ACTIVE', 'LAST_LOT_TRANSACTION_ID', 'BIW_UPD_DTTM', 'BIW_BATCH_ID']   
		,post_hook= [v_sql_upd_success_batch]	
        )
}}
WITH 
LOT_NUMBER AS (
SELECT distinct
    SYSTEM_LOT_NUMBER 
FROM 
{{ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_DRVD')}}
    {% if is_incremental() %}
    WHERE BIW_UPD_DTTM >= '{{V_LWM}}'
    AND BIW_UPD_DTTM < '{{V_HWM}}'
    {% endif %}
),
SUM_LOT_DTL AS
(
SELECT 
    DRVD.LOT_ID,
    DRVD.SYSTEM_LOT_NUMBER,
    DRVD.MES_LOT_NAME,
    DRVD.MES_TRANSACTION_UDT AS UPDATED_ON_UDT,
    DRVD.LOCATION,
    LAG (DRVD.LOCATION,1) OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID) AS PREV_LOCATION,
    SCHEDULED_START_UDT,
    PROJECTED_OUT_UDT,
    PROJECTED_OUT_WW,
    TARGET_PART_ID,
    CONDITIONAL_CHANGE_EVENT( LOCATION ) OVER (partition by DRVD.SYSTEM_LOT_NUMBER ORDER BY  MES_TRANSACTION_UDT, LOT_TRANSACTION_ID ) LOCATION_CHANGE_EVENT,
    LAST_VALUE(DRVD.LOT_TYPE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOT_TYPE,
    LAST_VALUE(DRVD.LOT_CATEGORY) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOT_CATEGORY,
    LAST_VALUE(DRVD.LOT_STATE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOT_STATE,
    LAST_VALUE(DRVD.STAGE_SET) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  STAGE_SET,
    LAST_VALUE(DRVD.FROM_LOT_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FROM_LOT_ID,
    LAST_VALUE(DRVD.FROM_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FROM_MES_LOT_NAME,
    LAST_VALUE(DRVD.TO_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  TO_MES_LOT_NAME,
    LAST_VALUE(DRVD.PREVIOUS_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  PREVIOUS_MES_LOT_NAME,
    LAST_VALUE(DRVD.NEW_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  NEW_MES_LOT_NAME,
    LAST_VALUE(DRVD.EXTERNAL_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  EXTERNAL_LOT_NAME,
    LAST_VALUE(DRVD.IMMEDIATE_PARENT_EXTERNAL_LOT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IMMEDIATE_PARENT_EXTERNAL_LOT,
    LAST_VALUE(DRVD.BOH_LOT_TYPE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  BOH_LOT_TYPE,
    LAST_VALUE(DRVD.EOH_LOT_TYPE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  EOH_LOT_TYPE,
    LAST_VALUE(DRVD.BOH_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  BOH_PART_ID,
    LAST_VALUE(DRVD.EOH_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  EOH_PART_ID,
    LAST_VALUE(DRVD.PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  PART_ID,
    LAST_VALUE(DRVD.PACKAGE_TYPE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  PACKAGE_TYPE,
    LAST_VALUE(DRVD.ECAT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ECAT,
    LAST_VALUE(DRVD.IS_IN_TRANSIT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_IN_TRANSIT,
    LAST_VALUE(DRVD.IS_HOLD) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_HOLD,
    LAST_VALUE(DRVD.IS_REWORK) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_REWORK,
    LAST_VALUE(DRVD.HOLD_COUNT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  HOLD_COUNT,
    LAST_VALUE(DRVD.LOT_HOLD_REASON) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOT_HOLD_REASON,
    LAST_VALUE(DRVD.LOT_HOLD_TRANSACTION_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOT_HOLD_TRANSACTION_UDT,
    LAST_VALUE(DRVD.EXTERNAL_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  EXTERNAL_PART_ID,
    LAST_VALUE(DRVD.FROM_LOT_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FROM_LOT_PART_ID,
    LAST_VALUE(DRVD.BOH_STAGE_SET) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  BOH_STAGE_SET,
    LAST_VALUE(DRVD.EOH_STAGE_SET) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  EOH_STAGE_SET,
    DRVD.BOH_GOOD_WAFER_QUANTITY,
    DRVD.EOH_GOOD_WAFER_QUANTITY,
    DRVD.GOOD_WAFER_QUANTITY,
    DRVD.BOH_REJECT_WAFER_QUANTITY,
    DRVD.EOH_REJECT_WAFER_QUANTITY,
    DRVD.REJECT_WAFER_QUANTITY,
    DRVD.BOH_TOTAL_WAFER_QUANTITY,
    DRVD.EOH_TOTAL_WAFER_QUANTITY,
    DRVD.BOH_GOOD_DIE_QUANTITY,
    DRVD.EOH_GOOD_DIE_QUANTITY,
    DRVD.GOOD_DIE_QUANTITY,
    DRVD.BOH_REJECT_DIE_QUANTITY,
    DRVD.EOH_REJECT_DIE_QUANTITY,
    DRVD.REJECT_DIE_QUANTITY,
    DRVD.BOH_TOTAL_DIE_QUANTITY,
    DRVD.EOH_TOTAL_DIE_QUANTITY,
    LAST_VALUE(DRVD.IS_VALUE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_VALUE,
    LAST_VALUE(DRVD.RMA_NUMBER) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  RMA_NUMBER,
    LAST_VALUE(DRVD.MRB_CASE_NUMBERS) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  MRB_CASE_NUMBERS,
    LAST_VALUE(DRVD.IS_MAVERICK_LOT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_MAVERICK_LOT,
    LAST_VALUE(DRVD.HTS_COUNTRY) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  HTS_COUNTRY,
    LAST_VALUE(DRVD.SUPPLIER) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SUPPLIER,
    LAST_VALUE(DRVD.SUPPLIER_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SUPPLIER_NAME,
    LAST_VALUE(DRVD.SUPPLIER_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SUPPLIER_LOCATION,
    LAST_VALUE(DRVD.SUPPLIER_PO_NUMBER) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SUPPLIER_PO_NUMBER,
    LAST_VALUE(DRVD.SALES_ORDER_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SALES_ORDER_ID,
    LAST_VALUE(DRVD.SHIPMENT_INVOICE_NUMBER) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHIPMENT_INVOICE_NUMBER,
    LAST_VALUE(DRVD.SHIPMENT_TRANSFER_PRICE_USED) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHIPMENT_TRANSFER_PRICE_USED,
    LAST_VALUE(DRVD.IS_RETURN_SHIPMENT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_RETURN_SHIPMENT,
    LAST_VALUE(DRVD.SHIP_TO_CUSTOMER) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHIP_TO_CUSTOMER,
    LAST_VALUE(DRVD.JIT_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  JIT_LOCATION,
    LAST_VALUE(DRVD.WIP_START_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  WIP_START_UDT,
    LAST_VALUE(DRVD.WIP_END_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  WIP_END_UDT,
    LAST_VALUE(DRVD.PROCESS_PATH) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  PROCESS_PATH,
    LAST_VALUE(DRVD.COUNTRY_OF_SUBSTRATE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_SUBSTRATE,
    LAST_VALUE(DRVD.COUNTRY_OF_DIFFUSION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_DIFFUSION,
    LAST_VALUE(DRVD.COUNTRY_OF_FAB) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_FAB,
    LAST_VALUE(DRVD.FAB_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_LOCATION,
    LAST_VALUE(DRVD.FAB_AREA) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_AREA,
    LAST_VALUE(DRVD.FAB_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_MES_LOT_NAME,
    LAST_VALUE(DRVD.FAB_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_PART_ID,
    LAST_VALUE(DRVD.FAB_START_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_START_UDT,
    LAST_VALUE(DRVD.FAB_END_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_END_UDT,
    LAST_VALUE(DRVD.FAB_DATE_CODE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FAB_DATE_CODE,
    LAST_VALUE(DRVD.MASK_SET) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  MASK_SET,
    LAST_VALUE(DRVD.MASK_SET_REVISION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  MASK_SET_REVISION,
    LAST_VALUE(DRVD.SHELF_RACK) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHELF_RACK,
    LAST_VALUE(DRVD.SHELF_ROW) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHELF_ROW,
    LAST_VALUE(DRVD.SHELF_BIN) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SHELF_BIN,
    LAST_VALUE(DRVD.PDPW) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  PDPW,
    LAST_VALUE(DRVD.SEAL_OPEN_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SEAL_OPEN_UDT,
    LAST_VALUE(DRVD.DISPOSITION_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  DISPOSITION_UDT,
    LAST_VALUE(DRVD.COUNTRY_OF_SORT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_SORT,
    LAST_VALUE(DRVD.SORT_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_LOCATION,
    LAST_VALUE(DRVD.SORT_AREA) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_AREA,
    LAST_VALUE(DRVD.SORT_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_MES_LOT_NAME,
    LAST_VALUE(DRVD.SORT_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PART_ID,
    LAST_VALUE(DRVD.SORT_START_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_START_UDT,
    LAST_VALUE(DRVD.SORT_END_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_END_UDT,
    LAST_VALUE(DRVD.INK_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  INK_UDT,
    LAST_VALUE(DRVD.SORT_PROGRAM_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PROGRAM_NAME,
    LAST_VALUE(DRVD.SORT_PROGRAM_REVISION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PROGRAM_REVISION,
    LAST_VALUE(DRVD.SORT_PROGRAM_CHECKSUM) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PROGRAM_CHECKSUM,
    LAST_VALUE(DRVD.SORT_TESTER_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_TESTER_ID,
    LAST_VALUE(DRVD.SORT_PROBER_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PROBER_ID,
    LAST_VALUE(DRVD.SORT_PROBE_CARD) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_PROBE_CARD,
    LAST_VALUE(DRVD.SORT_LOADBOARD_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_LOADBOARD_ID,
    LAST_VALUE(DRVD.SORT_DUT_BOARD_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  SORT_DUT_BOARD_ID,
    LAST_VALUE(DRVD.COUNTRY_OF_BUMP) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_BUMP,
    LAST_VALUE(DRVD.BUMP_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  BUMP_LOCATION,
    LAST_VALUE(DRVD.COUNTRY_OF_ASSEMBLY) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_ASSEMBLY,
    LAST_VALUE(DRVD.ASSEMBLY_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_LOCATION,
    LAST_VALUE(DRVD.ASSEMBLY_AREA) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_AREA,
    LAST_VALUE(DRVD.ASSEMBLY_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_MES_LOT_NAME,
    LAST_VALUE(DRVD.ASSEMBLY_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_PART_ID,
    LAST_VALUE(DRVD.ASSEMBLY_START_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_START_UDT,
    LAST_VALUE(DRVD.ASSEMBLY_END_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSEMBLY_END_UDT,
    LAST_VALUE(DRVD.TOP_SIDE_MARK) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  TOP_SIDE_MARK,
    LAST_VALUE(DRVD.BACK_SIDE_MARK) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  BACK_SIDE_MARK,
    LAST_VALUE(DRVD.IS_MARKED) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  IS_MARKED,
    LAST_VALUE(DRVD.DATE_CODE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  DATE_CODE,
    LAST_VALUE(DRVD.DATE2_CODE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  DATE2_CODE,
    LAST_VALUE(DRVD.TRACE_CODE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  TRACE_CODE,
    LAST_VALUE(DRVD.TRACE2_CODE) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  TRACE2_CODE,
    LAST_VALUE(DRVD.COUNTRY_OF_FINAL_TEST) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  COUNTRY_OF_FINAL_TEST,
    LAST_VALUE(DRVD.FINAL_TEST_LOCATION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_LOCATION,
    LAST_VALUE(DRVD.FINAL_TEST_AREA) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_AREA,
    LAST_VALUE(DRVD.FINAL_TEST_MES_LOT_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_MES_LOT_NAME,
    LAST_VALUE(DRVD.FINAL_TEST_PART_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_PART_ID,
    LAST_VALUE(DRVD.FINAL_TEST_START_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_START_UDT,
    LAST_VALUE(DRVD.FINAL_TEST_END_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_END_UDT,
    LAST_VALUE(DRVD.FINAL_TEST_TEMP) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_TEMP,
    LAST_VALUE(DRVD.FINAL_TEST_PROGRAM_NAME) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_PROGRAM_NAME,
    LAST_VALUE(DRVD.FINAL_TEST_PROGRAM_REVISION) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_PROGRAM_REVISION,
    LAST_VALUE(DRVD.FINAL_TEST_PROGRAM_CHECKSUM) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_PROGRAM_CHECKSUM,
    LAST_VALUE(DRVD.FINAL_TEST_TESTER_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_TESTER_ID,
    LAST_VALUE(DRVD.FINAL_TEST_HANDLER_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_HANDLER_ID,
    LAST_VALUE(DRVD.FINAL_TEST_LOADBOARD_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_LOADBOARD_ID,
    LAST_VALUE(DRVD.FINAL_TEST_DUT_BOARD_ID) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  FINAL_TEST_DUT_BOARD_ID,
    LAST_VALUE(DRVD.DRY_PACK_SEAL_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  DRY_PACK_SEAL_UDT,
    LAST_VALUE(DRVD.ASSIGNED_TO) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  ASSIGNED_TO,
    LAST_VALUE(DRVD.MOST_RECENT_MOVE_TRANSACTION_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  MOST_RECENT_MOVE_TRANSACTION_UDT,
    LAST_VALUE(DRVD.LOCATION_MOVE_IN_MES_TRANSACTION_UDT) ignore nulls OVER (PARTITION BY DRVD.SYSTEM_LOT_NUMBER ORDER BY DRVD.MES_TRANSACTION_UDT,DRVD.LOT_TRANSACTION_ID RANGE BETWEEN  UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  LOCATION_MOVE_IN_MES_TRANSACTION_UDT,
    CASE 
    WHEN DRVD.EOH_GOOD_WAFER_QUANTITY = 0 AND  DRVD.EOH_GOOD_DIE_QUANTITY = 0 
    THEN 'N' ELSE 'Y' 
    END::BOOLEAN AS IS_ACTIVE,
    DRVD.LOT_TRANSACTION_ID as LAST_LOT_TRANSACTION_ID,
    'Grp'||(ROW_NUMBER() OVER (PARTITION BY MES_LOT_NAME ORDER BY MES_TRANSACTION_UDT,LOT_TRANSACTION_ID) -
    ROW_NUMBER() OVER (PARTITION BY MES_LOT_NAME,location ORDER BY MES_TRANSACTION_UDT,LOT_TRANSACTION_ID)) AS grp,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
	{{V_BIW_BATCH_ID}} as BIW_BATCH_ID   
FROM 
{{ref('ETL_MART_E2OPEN_E2O_LOT_TXN_DTL_DRVD')}} DRVD
JOIN LOT_NUMBER LOT 
    ON LOT.SYSTEM_LOT_NUMBER = DRVD.SYSTEM_LOT_NUMBER
)
SELECT 
    SYSTEM_LOT_NUMBER,
    MES_LOT_NAME,
    LAST_LOT_TRANSACTION_ID AS LOT_TRANSACTION_ID,
    LOT_ID,
    UPDATED_ON_UDT,
    LOCATION,
    LOT_TYPE,
    LOT_CATEGORY,
    LOT_STATE,
    STAGE_SET,
    FROM_LOT_ID,
    FROM_MES_LOT_NAME,
    TO_MES_LOT_NAME,
    PREVIOUS_MES_LOT_NAME,
    NEW_MES_LOT_NAME,
    EXTERNAL_LOT_NAME,
    IMMEDIATE_PARENT_EXTERNAL_LOT,
    BOH_LOT_TYPE,
    EOH_LOT_TYPE,
    BOH_PART_ID,
    EOH_PART_ID,
    PART_ID,
    PACKAGE_TYPE,
    ECAT,
    IS_IN_TRANSIT,
    IS_HOLD,
    IS_REWORK,
    HOLD_COUNT,
    LOT_HOLD_REASON,
    LOT_HOLD_TRANSACTION_UDT,
    EXTERNAL_PART_ID,
    FROM_LOT_PART_ID,
    BOH_STAGE_SET,
    EOH_STAGE_SET,
    BOH_GOOD_WAFER_QUANTITY,
    EOH_GOOD_WAFER_QUANTITY,
    GOOD_WAFER_QUANTITY,
    BOH_REJECT_WAFER_QUANTITY,
    EOH_REJECT_WAFER_QUANTITY,
    REJECT_WAFER_QUANTITY,
    BOH_TOTAL_WAFER_QUANTITY,
    EOH_TOTAL_WAFER_QUANTITY,
    BOH_GOOD_DIE_QUANTITY,
    EOH_GOOD_DIE_QUANTITY,
    GOOD_DIE_QUANTITY,
    BOH_REJECT_DIE_QUANTITY,
    EOH_REJECT_DIE_QUANTITY,
    REJECT_DIE_QUANTITY,
    BOH_TOTAL_DIE_QUANTITY,
    EOH_TOTAL_DIE_QUANTITY,
    IS_VALUE,
    RMA_NUMBER,
    MRB_CASE_NUMBERS,
    IS_MAVERICK_LOT,
    HTS_COUNTRY,
    SUPPLIER,
    SUPPLIER_NAME,
    SUPPLIER_LOCATION,
    SUPPLIER_PO_NUMBER,
    SALES_ORDER_ID,
    SHIPMENT_INVOICE_NUMBER,
    SHIPMENT_TRANSFER_PRICE_USED,
    IS_RETURN_SHIPMENT,
    SHIP_TO_CUSTOMER,
    JIT_LOCATION,
    WIP_START_UDT,
    WIP_END_UDT,
    PROCESS_PATH,
    COUNTRY_OF_SUBSTRATE,
    COUNTRY_OF_DIFFUSION,
    COUNTRY_OF_FAB,
    FAB_LOCATION,
    FAB_AREA,
    FAB_MES_LOT_NAME,
    FAB_PART_ID,
    FAB_START_UDT,
    FAB_END_UDT,
    FAB_DATE_CODE,
    MASK_SET,
    MASK_SET_REVISION,
    SHELF_RACK,
    SHELF_ROW,
    SHELF_BIN,
    PDPW,
    SEAL_OPEN_UDT,
    DISPOSITION_UDT,
    COUNTRY_OF_SORT,
    SORT_LOCATION,
    SORT_AREA,
    SORT_MES_LOT_NAME,
    SORT_PART_ID,
    SORT_START_UDT,
    SORT_END_UDT,
    INK_UDT,
    SORT_PROGRAM_NAME,
    SORT_PROGRAM_REVISION,
    SORT_PROGRAM_CHECKSUM,
    SORT_TESTER_ID,
    SORT_PROBER_ID,
    SORT_PROBE_CARD,
    SORT_LOADBOARD_ID,
    SORT_DUT_BOARD_ID,
    COUNTRY_OF_BUMP,
    BUMP_LOCATION,
    COUNTRY_OF_ASSEMBLY,
    ASSEMBLY_LOCATION,
    ASSEMBLY_AREA,
    ASSEMBLY_MES_LOT_NAME,
    ASSEMBLY_PART_ID,
    ASSEMBLY_START_UDT,
    ASSEMBLY_END_UDT,
    TOP_SIDE_MARK,
    BACK_SIDE_MARK,
    IS_MARKED,
    DATE_CODE,
    DATE2_CODE,
    TRACE_CODE,
    TRACE2_CODE,
    COUNTRY_OF_FINAL_TEST,
    FINAL_TEST_LOCATION,
    FINAL_TEST_AREA,
    FINAL_TEST_MES_LOT_NAME,
    FINAL_TEST_PART_ID,
    FINAL_TEST_START_UDT,
    FINAL_TEST_END_UDT,
    FINAL_TEST_TEMP,
    FINAL_TEST_PROGRAM_NAME,
    FINAL_TEST_PROGRAM_REVISION,
    FINAL_TEST_PROGRAM_CHECKSUM,
    FINAL_TEST_TESTER_ID,
    FINAL_TEST_HANDLER_ID,
    FINAL_TEST_LOADBOARD_ID,
    FINAL_TEST_DUT_BOARD_ID,
    DRY_PACK_SEAL_UDT,
    --SCHEDULED_START_UDT,
    MAX (SCHEDULED_START_UDT  ) OVER  (PARTITION by SYSTEM_LOT_NUMBER ,LOCATION_CHANGE_EVENT  ORDER BY  UPDATED_ON_UDT, LOT_TRANSACTION_ID ) SCHEDULED_START_UDT,
    MAX (PROJECTED_OUT_UDT  ) OVER  (PARTITION by SYSTEM_LOT_NUMBER ,LOCATION_CHANGE_EVENT  ORDER BY  UPDATED_ON_UDT, LOT_TRANSACTION_ID ) PROJECTED_OUT_UDT,
    --PROJECTED_OUT_UDT,
    --PROJECTED_OUT_WW,
    MAX (PROJECTED_OUT_WW  ) OVER  (PARTITION by SYSTEM_LOT_NUMBER ,LOCATION_CHANGE_EVENT  ORDER BY  UPDATED_ON_UDT, LOT_TRANSACTION_ID ) PROJECTED_OUT_WW,
    --TARGET_PART_ID,
    MAX (TARGET_PART_ID  ) OVER  (PARTITION by SYSTEM_LOT_NUMBER ,LOCATION_CHANGE_EVENT  ORDER BY  UPDATED_ON_UDT, LOT_TRANSACTION_ID ) TARGET_PART_ID,
    ASSIGNED_TO,
    MOST_RECENT_MOVE_TRANSACTION_UDT,
    LOCATION_MOVE_IN_MES_TRANSACTION_UDT,
    CASE 
    WHEN IS_ACTIVE  AND LOT_STATE in ('CLOSED','TERMINATED')
    THEN 'FALSE'
    WHEN NOT(IS_ACTIVE)  AND LOT_STATE NOT in ('CLOSED','TERMINATED') AND EOH_GOOD_WAFER_QUANTITY != 0 AND  EOH_GOOD_DIE_QUANTITY !=0
    THEN 'TRUE'
    ELSE IS_ACTIVE
    END ::BOOLEAN AS IS_ACTIVE,
    LAST_LOT_TRANSACTION_ID,
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID,
    md5(object_construct ('col1',MES_LOT_NAME, 'col2',LOT_TRANSACTION_ID, 'col3',LOT_ID, 'col4',UPDATED_ON_UDT,
    'col5',LOCATION, 'col6',LOT_TYPE, 'col7',LOT_CATEGORY, 'col8',LOT_STATE, 'col9',STAGE_SET, 'col10',FROM_LOT_ID, 'col11',FROM_MES_LOT_NAME,
    'col12',TO_MES_LOT_NAME, 'col13',PREVIOUS_MES_LOT_NAME, 'col14',NEW_MES_LOT_NAME, 'col15',EXTERNAL_LOT_NAME, 'col16',IMMEDIATE_PARENT_EXTERNAL_LOT,
    'col17',BOH_LOT_TYPE, 'col18',EOH_LOT_TYPE, 'col19',BOH_PART_ID, 'col20',EOH_PART_ID, 'col21',PART_ID, 'col22',PACKAGE_TYPE, 'col23',ECAT,
    'col24',IS_IN_TRANSIT, 'col25',IS_HOLD, 'col26',IS_REWORK, 'col27',HOLD_COUNT, 'col28',LOT_HOLD_REASON, 'col29',LOT_HOLD_TRANSACTION_UDT,
    'col30',EXTERNAL_PART_ID, 'col31',FROM_LOT_PART_ID, 'col32',BOH_STAGE_SET, 'col33',EOH_STAGE_SET, 'col34',BOH_GOOD_WAFER_QUANTITY,
    'col35',EOH_GOOD_WAFER_QUANTITY, 'col36',GOOD_WAFER_QUANTITY, 'col37',BOH_REJECT_WAFER_QUANTITY, 'col38',EOH_REJECT_WAFER_QUANTITY,
    'col39',REJECT_WAFER_QUANTITY, 'col40',BOH_TOTAL_WAFER_QUANTITY, 'col41',EOH_TOTAL_WAFER_QUANTITY, 'col42',BOH_GOOD_DIE_QUANTITY,
    'col43',EOH_GOOD_DIE_QUANTITY, 'col44',GOOD_DIE_QUANTITY, 'col45',BOH_REJECT_DIE_QUANTITY, 'col46',EOH_REJECT_DIE_QUANTITY, 'col47',REJECT_DIE_QUANTITY,
    'col48',BOH_TOTAL_DIE_QUANTITY, 'col49',EOH_TOTAL_DIE_QUANTITY, 'col50',IS_VALUE, 'col51',RMA_NUMBER, 'col52',MRB_CASE_NUMBERS, 'col53',IS_MAVERICK_LOT,
    'col54',HTS_COUNTRY, 'col55',SUPPLIER, 'col56',SUPPLIER_NAME, 'col57',SUPPLIER_LOCATION, 'col58',SUPPLIER_PO_NUMBER, 'col59',SALES_ORDER_ID,
    'col60',SHIPMENT_INVOICE_NUMBER, 'col61',SHIPMENT_TRANSFER_PRICE_USED, 'col62',IS_RETURN_SHIPMENT, 'col63',SHIP_TO_CUSTOMER, 'col64',JIT_LOCATION,
    'col65',WIP_START_UDT, 'col66',WIP_END_UDT, 'col67',PROCESS_PATH, 'col68',COUNTRY_OF_SUBSTRATE, 'col69',COUNTRY_OF_DIFFUSION,
    'col70',COUNTRY_OF_FAB, 'col71',FAB_LOCATION, 'col72',FAB_AREA, 'col73',FAB_MES_LOT_NAME, 'col74',FAB_PART_ID, 'col75',FAB_START_UDT,
    'col76',FAB_END_UDT, 'col77',FAB_DATE_CODE, 'col78',MASK_SET, 'col79',MASK_SET_REVISION, 'col80',SHELF_RACK, 'col81',SHELF_ROW,
    'col82',SHELF_BIN, 'col83',PDPW, 'col84',SEAL_OPEN_UDT, 'col85',DISPOSITION_UDT, 'col86',COUNTRY_OF_SORT, 'col87',SORT_LOCATION,
    'col88',SORT_AREA, 'col89',SORT_MES_LOT_NAME, 'col90',SORT_PART_ID, 'col91',SORT_START_UDT, 'col92',SORT_END_UDT, 'col93',INK_UDT,
    'col94',SORT_PROGRAM_NAME, 'col95',SORT_PROGRAM_REVISION, 'col96',SORT_PROGRAM_CHECKSUM, 'col97',SORT_TESTER_ID, 'col98',SORT_PROBER_ID,
    'col99',SORT_PROBE_CARD, 'col100',SORT_LOADBOARD_ID, 'col101',SORT_DUT_BOARD_ID, 'col102',COUNTRY_OF_BUMP, 'col103',BUMP_LOCATION,
    'col104',COUNTRY_OF_ASSEMBLY, 'col105',ASSEMBLY_LOCATION, 'col106',ASSEMBLY_AREA, 'col107',ASSEMBLY_MES_LOT_NAME, 'col108',ASSEMBLY_PART_ID,
    'col109',ASSEMBLY_START_UDT, 'col110',ASSEMBLY_END_UDT, 'col111',TOP_SIDE_MARK, 'col112',BACK_SIDE_MARK, 'col113',IS_MARKED, 'col114',DATE_CODE,
    'col115',DATE2_CODE, 'col116',TRACE_CODE, 'col117',TRACE2_CODE, 'col118',COUNTRY_OF_FINAL_TEST, 'col119',FINAL_TEST_LOCATION,
    'col120',FINAL_TEST_AREA, 'col121',FINAL_TEST_MES_LOT_NAME, 'col122',FINAL_TEST_PART_ID, 'col123',FINAL_TEST_START_UDT, 'col124',FINAL_TEST_END_UDT,
    'col125',FINAL_TEST_TEMP, 'col126',FINAL_TEST_PROGRAM_NAME, 'col127',FINAL_TEST_PROGRAM_REVISION, 'col128',FINAL_TEST_PROGRAM_CHECKSUM,
    'col129',FINAL_TEST_TESTER_ID, 'col130',FINAL_TEST_HANDLER_ID, 'col131',FINAL_TEST_LOADBOARD_ID, 'col132',FINAL_TEST_DUT_BOARD_ID,
    'col133',DRY_PACK_SEAL_UDT, 'col134',SCHEDULED_START_UDT, 'col135',PROJECTED_OUT_UDT, 'col136',PROJECTED_OUT_WW, 'col137',TARGET_PART_ID,
    'col138',ASSIGNED_TO, 'col139',MOST_RECENT_MOVE_TRANSACTION_UDT, 'col140',LOCATION_MOVE_IN_MES_TRANSACTION_UDT, 'col141',IS_ACTIVE,
    'col142',LAST_LOT_TRANSACTION_ID)::string ) as BIW_MD5_KEY 
FROM SUM_LOT_DTL
--WHERE RANK_COL=1
QUALIFY(  ROW_NUMBER() OVER (PARTITION BY SYSTEM_LOT_NUMBER ORDER BY UPDATED_ON_UDT DESC,LOT_TRANSACTION_ID DESC NULLS LAST) =1)
