/*---------------------------------------------------------------------------
Command to run model:
--dbt run --select ETL_MART_SALES_BILLING_CUSTOMER_BRIDGE
--dbt run --full-refresh --select ETL_MART_SALES_BILLING_CUSTOMER_BRIDGE

Version     Date            Author          Description
-------     --------        -----------     ----------------------------------
1.0         10/18/2022      Sruthi Kasbe    Updated customer columns and its order
---------------------------------------------------------------------------*/
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['BILLING_KEY']-%}
{% if is_incremental() %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
--SELECT {{v_md5_column_list}}
{% endif %}

{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_SALES_BILLING_CUSTOMER_BRIDGE'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}
{% if var('is_backfill') %}
        {%- set V_LWM =  var('refresh_start_ts')-%}
{% endif %}
{{
    config(
         description = 'Building ETL table BILLING_CUSTOMER_BRIDGE for sales mart'
        ,transient=true
        ,materialized='table'
        ,schema ='ETL_MART_SALES'
        ,alias='BILLING_CUSTOMER_BRIDGE'
        ,unique_key= v_pk_list
        ,tags ='MART_SALES'
        ,post_hook= [v_sql_upd_success_batch]
        )
}}
with 
MART_CUST AS
(
SELECT
    CUSTOMER_KEY,
    CUSTOMER_CODE,
    CORPORATION_CODE,
    BUSINESS_CLASS_CODE,
    END_CORPORATION_CODE
FROM {{ref('MART_SALES_CUSTOMER')}}
)
,MART_CORP AS
(
SELECT
    CORPORATION_KEY,
    CORPORATION_CODE
FROM {{ref('MART_SALES_CORPORATION')}}
)
,XXON_INV_CUSTITEM_XREF_V AS
(
SELECT
    CUST_CODE  AS CUSTOMER_CODE,
    CUST_PART_NUMBER AS CPN,
    PART_NUMBER AS MPN,
    CUST_OF_INTEREST_TXT AS CUSTOMER_OF_INTEREST,
    LENGTH(CUST_CODE) AS LEN_CUST_CD, -- IF 5 THEN CUSTOMER, IF 4 THEN CORPORATION
    EFFECTIVE_FROM_DATE AS EFFECTIVE_FROM_DT,
    EFFECTIVE_TO_DATE AS EFFECTIVE_END_DT,
    BIW_UPD_DTTM
FROM {{source('STG_EBS_APPS','XXON_INV_CUSTITEM_XREF_V')}}
WHERE 1=1
-- MOVING DOWN INJOIN AND CUSTOMER_OF_INTEREST <> 'COIW' -- COI NO END CUSTOMER
AND LENGTH(CUST_CODE) IN (4,5) 
QUALIFY (ROW_NUMBER() OVER (PARTITION BY CUST_PART_NUMBER,PART_NUMBER,CUST_CODE ORDER BY BIW_UPD_DTTM DESC )=1)
)
,DATAWARE_COI AS
(
SELECT 
DISTINCT
    PART_REF.CPN,
    PART_REF.MPN,
    CASE 
        WHEN PART_REF.LEN_CUST_CD=5 THEN PART_REF.CUSTOMER_CODE 
    END AS CUSTOMER_CODE,
    CASE 
        WHEN PART_REF.LEN_CUST_CD = 4 THEN PART_REF.CUSTOMER_CODE 
    END AS CORPORATION_CODE,
    CASE 
        WHEN PART_REF.LEN_CUST_CD=5 THEN PART_REF.CUSTOMER_OF_INTEREST 
    END AS CUSTOMER_OF_INTEREST,
    CASE 
        WHEN PART_REF.LEN_CUST_CD = 4 THEN PART_REF.CUSTOMER_OF_INTEREST 
        WHEN PART_REF.LEN_CUST_CD = 5 THEN CUST.CORPORATION_CODE 
    END AS CORPORATION_OF_INTEREST,
    PART_REF.EFFECTIVE_FROM_DT,
    PART_REF.EFFECTIVE_END_DT,
    PART_REF.BIW_UPD_DTTM
FROM XXON_INV_CUSTITEM_XREF_V PART_REF
LEFT JOIN  MART_CUST CUST
ON PART_REF.CUSTOMER_OF_INTEREST= CUST.CUSTOMER_CODE
)
,SDM_ADJ_END_CORP AS
(
SELECT
    NULLIF(MPN,'') as PRODUCT_ID,
    NULLIF(DIR_CUST_CD,'') as DIR_CUST_CD,
    NULLIF(IND_CUST_CD,'') as IND_CUST_CD,
    NULLIF(END_CORP_CD,'') as END_CORP_CD,
    NULLIF(ADJUSTED_END_CORP_CD,'') as ADJUSTED_END_CORP_CD,
    EFFECTIVE_START_DATE as EFFECTIVE_FROM_DATE,
    EFFECTIVE_END_DATE as EFFECTIVE_TO_DATE,
    BIW_UPD_DTTM
FROM {{source('STG_SHAREPOINT_MDL','ADJUSTED_END_CORPORATION')}}
QUALIFY (ROW_NUMBER() OVER (PARTITION BY PRODUCT_ID,DIR_CUST_CD,IND_CUST_CD,END_CORP_CD,EFFECTIVE_FROM_DATE,EFFECTIVE_TO_DATE ORDER BY BIW_UPD_DTTM DESC )=1)
)
,SDM_REF_CORP AS
(
SELECT
    NULLIF(MPN,'') as PRODUCT_ID,
    NULLIF(DIR_CUST_CD,'') as DIR_CUST_CD,
    NULLIF(IND_CUST_CD,'') as IND_CUST_CD,
    NULLIF(END_CORP_CD,'') as END_CORP_CD,
    NULLIF(REFERENCE_CORP_CD,'') as REFERENCE_CORP_CD,
    EFFECTIVE_START_DATE as EFFECTIVE_FROM_DATE,
    EFFECTIVE_END_DATE as EFFECTIVE_TO_DATE,
    BIW_UPD_DTTM
FROM {{source('STG_SHAREPOINT_MDL','REFERENCE_DESIGN_CUSTOMER')}}
QUALIFY (ROW_NUMBER() OVER (PARTITION BY MPN,DIR_CUST_CD,IND_CUST_CD,END_CORP_CD,EFFECTIVE_START_DATE,EFFECTIVE_END_DATE ORDER BY BIW_UPD_DTTM DESC )=1)
),
MART_BILL AS (
SELECT 
    BILLING_KEY,
    BILLING_DATE_KEY,
    PROCESS_DATE,
    DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,
    END_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,
    END_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    CUSTOMER_PART_NUMBER,
    MARKET_PRODUCT_NUMBER,
    END_CORPORATION_CODE,
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID
FROM
    {{ ref('MART_SALES_BILLING_FACT')}}
    WHERE SOURCE_OF_SALE = 'ON'
    AND  CASE WHEN '{{V_LWM}}'  < TRUNC(CURRENT_DATE,'YEAR')- INTERVAL '5 YEAR' 
                THEN '{{V_LWM}}'
                ELSE TRUNC(CURRENT_DATE,'YEAR')- INTERVAL '5 YEAR' 
                END  <=PROCESS_DATE
    --1 : Direct impact: Record changed in the mart
    AND CASE 
            WHEN (BIW_UPD_DTTM >= '{{V_LWM}}' AND BIW_UPD_DTTM < '{{V_HWM}}')
                THEN 1
    --2. InDirect Impact
        -- Change in COI
            WHEN (DIRECT_CUSTOMER_CODE,CUSTOMER_PART_NUMBER,MARKET_PRODUCT_NUMBER) IN (
                                                                                SELECT DISTINCT 
                                                                                    CUSTOMER_CODE,CPN,MPN
                                                                                    FROM DATAWARE_COI COI
                                                                                WHERE COI.BIW_UPD_DTTM >= '{{V_LWM}}' AND BIW_UPD_DTTM < '{{V_HWM}}'
                                                                                )
                THEN 1
        -- Change in the Sharepoint Adjusted and Reference Corp
            WHEN (DIRECT_CUSTOMER_CODE,END_CORPORATION_CODE,MARKET_PRODUCT_NUMBER) IN (
                                                                                    SELECT DISTINCT
                                                                                        DIR_CUST_CD,END_CORP_CD,PRODUCT_ID
                                                                                        FROM SDM_ADJ_END_CORP ADJ
                                                                                    WHERE ADJ.BIW_UPD_DTTM >= '{{V_LWM}}' AND BIW_UPD_DTTM < '{{V_HWM}}' 
                                                                                    )
                THEN 1
            WHEN (DIRECT_CUSTOMER_CODE,END_CORPORATION_CODE,MARKET_PRODUCT_NUMBER) IN (
                                                                        SELECT DISTINCT
                                                                            DIR_CUST_CD,END_CORP_CD,PRODUCT_ID
                                                                            FROM SDM_REF_CORP REF
                                                                        WHERE REF.BIW_UPD_DTTM >= '{{V_LWM}}' AND BIW_UPD_DTTM < '{{V_HWM}}' 
                                                                        )
                THEN 1
            END =1 
)
,SDM_ALLOWED_CORP AS
(
SELECT
    CORP_CD AS CORPORATION_CODE
FROM {{source('STG_SDM_PRESENTATION','CPNOEM_ALLOWEDCORP')}}
QUALIFY (ROW_NUMBER() OVER (PARTITION BY CORP_CD ORDER BY BIW_UPD_DTTM DESC )=1)
)
,SDM_CPNASIC AS
(
SELECT
    PRODUCT_ID
FROM {{source('STG_SDM_PRESENTATION','CPNASIC_ALLOWEDPROD')}}
QUALIFY (ROW_NUMBER() OVER (PARTITION BY PRODUCT_ID ORDER BY BIW_UPD_DTTM DESC )=1)
),
FINAL_SQL AS (
SELECT  
    BILL.BILLING_KEY,
    BILL.BILLING_DATE_KEY,
    BILL.DIRECT_CUSTOMER_KEY,
    BILL.INDIRECT_CUSTOMER_KEY,
    BILL.END_CUSTOMER_KEY,
    BILL.DIRECT_CORPORATION_KEY,
    CASE
        WHEN CUST.BUSINESS_CLASS_CODE = 'EMSI' 
                THEN COALESCE(DIR_CORP.CORPORATION_CODE, CORP_COI_CORP.CORPORATION_CODE,CUST.CORPORATION_CODE)
        WHEN CUST.BUSINESS_CLASS_CODE = 'OEM' AND OEM_CORP.CORPORATION_CODE IS NOT NULL 
                THEN COALESCE(DIR_CORP.CORPORATION_CODE, CORP_COI_CORP.CORPORATION_CODE,CUST.CORPORATION_CODE)
        WHEN CUST.BUSINESS_CLASS_CODE IN ('DIST','CIPO') AND CPNASIC.PRODUCT_ID IS NOT NULL 
                THEN COALESCE(DIR_CORP.CORPORATION_CODE, CORP_COI_CORP.CORPORATION_CODE,CUST.CORPORATION_CODE)
        ELSE COALESCE(END_CORP.CORPORATION_CODE,INDIR_CUST.CORPORATION_CODE)
    END    INDIRECT_CORPORATION_CODE,
    MD5(INDIRECT_CORPORATION_CODE) AS INDIRECT_CORPORATION_KEY,
    INDIRECT_CORPORATION_KEY AS  END_CORPORATION_KEY,

    COALESCE(ADJ_CORP.ADJUSTED_END_CORP_CD
            , ADJ_CORP_DIR_CUST.ADJUSTED_END_CORP_CD
            , ADJ_CORP_INDIR_CUST.ADJUSTED_END_CORP_CD
            , INDIRECT_CORPORATION_CODE
            ) ADJUSTED_END_CORPORATION_CODE,
    MD5(ADJUSTED_END_CORPORATION_CODE)   AS ADJUSTED_END_CORPORATION_KEY,
    COALESCE(REF_CORP.REFERENCE_CORP_CD
            , REF_CORP_DIR_CUST.REFERENCE_CORP_CD
            , REF_CORP_INDIR_CUST.REFERENCE_CORP_CD
            ,INDIRECT_CORPORATION_CODE
            ) AS REFERENCE_CORPORATION_CODE,
    MD5(REFERENCE_CORPORATION_CODE) AS REFERENCE_CORPORATION_KEY,
    BILL.PROCESS_DATE,
    BILL.DIRECT_CUSTOMER_CODE,
    BILL.INDIRECT_CUSTOMER_CODE,
    BILL.END_CUSTOMER_CODE,
    BILL.DIRECT_CORPORATION_CODE,
    BILL.END_CORPORATION_CODE,
    CASE 
    WHEN (
            (CUST.BUSINESS_CLASS_CODE = 'EMSI') OR 
            (CUST.BUSINESS_CLASS_CODE = 'OEM' AND OEM_CORP.CORPORATION_CODE IS NOT NULL) OR
            (CUST.BUSINESS_CLASS_CODE IN ('DIST','CIPO') AND CPNASIC.PRODUCT_ID IS NOT NULL)
        )
    THEN 
        CASE 
            WHEN DIR_CORP.CORPORATION_CODE IS NOT NULL THEN 'COICustomer'
            WHEN CORP_COI_CORP.CORPORATION_CODE IS NOT NULL THEN 'COICorporation'
            WHEN CUST.CORPORATION_CODE IS NOT NULL THEN 'NoCOI-Using DIRCoproration'
            ELSE 'Not Defined' 
        END
	ELSE 'SUBCorp' 
	END AS END_CORPORATION_DEFINITION,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
	'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
	{{V_BIW_BATCH_ID}} as BIW_BATCH_ID   
FROM MART_BILL BILL
--SNOWFLAKE objects are joined using md5 keys and SDM/DWH Oracle objects are joined using NK
LEFT JOIN MART_CUST CUST
    ON BILL.DIRECT_CUSTOMER_KEY=CUST.CUSTOMER_KEY

LEFT JOIN  DATAWARE_COI DIR_COI
    ON BILL.CUSTOMER_PART_NUMBER = DIR_COI.CPN
    AND BILL.MARKET_PRODUCT_NUMBER = DIR_COI.MPN 
    AND BILL.PROCESS_DATE BETWEEN DIR_COI.EFFECTIVE_FROM_DT AND DIR_COI.EFFECTIVE_END_DT
-------------CUSTOMER COI-------------
    AND CUST.CUSTOMER_CODE = DIR_COI.CUSTOMER_CODE
    AND DIR_COI.CORPORATION_OF_INTEREST <> 'COIW'
LEFT JOIN MART_CORP DIR_CORP
    ON DIR_COI.CORPORATION_OF_INTEREST = DIR_CORP.CORPORATION_CODE

LEFT JOIN  DATAWARE_COI CORP_COI
    ON BILL.CUSTOMER_PART_NUMBER = CORP_COI.CPN
    AND BILL.MARKET_PRODUCT_NUMBER = CORP_COI.MPN 
    AND BILL.PROCESS_DATE BETWEEN CORP_COI.EFFECTIVE_FROM_DT AND CORP_COI.EFFECTIVE_END_DT
-------------CORP COI-------------
    AND CUST.CORPORATION_CODE = CORP_COI.CORPORATION_CODE
    AND CORP_COI.CORPORATION_OF_INTEREST <> 'COIW'
 LEFT JOIN MART_CORP CORP_COI_CORP
    ON CORP_COI.CORPORATION_OF_INTEREST = CORP_COI_CORP.CORPORATION_CODE

------------------- OEM CORP-------------------
LEFT JOIN SDM_ALLOWED_CORP OEM_CORP
    ON CUST.CORPORATION_CODE = OEM_CORP.CORPORATION_CODE

LEFT JOIN SDM_CPNASIC CPNASIC
    ON BILL.MARKET_PRODUCT_NUMBER = CPNASIC.PRODUCT_ID

-------------INDIRECT CUSTOMER-------------
LEFT JOIN MART_CUST INDIR_CUST
    ON BILL.INDIRECT_CUSTOMER_CODE = INDIR_CUST.CUSTOMER_CODE
LEFT JOIN MART_CORP END_CORP
    ON INDIR_CUST.END_CORPORATION_CODE= END_CORP.CORPORATION_CODE

------------- ADJUSTED END CORP WITH END CORP-------------
LEFT JOIN  SDM_ADJ_END_CORP ADJ_CORP
    ON BILL.MARKET_PRODUCT_NUMBER = ADJ_CORP.PRODUCT_ID
    AND BILL.DIRECT_CUSTOMER_CODE = ADJ_CORP.DIR_CUST_CD
    AND BILL.INDIRECT_CUSTOMER_CODE = ADJ_CORP.IND_CUST_CD
    AND BILL.PROCESS_DATE BETWEEN ADJ_CORP.EFFECTIVE_FROM_DATE AND ADJ_CORP.EFFECTIVE_TO_DATE 
    AND END_CORP.CORPORATION_CODE= ADJ_CORP.END_CORP_CD
------------- ADJUSTED END CORP WITH INDIRECT CUSTOMER (WHICH IS END CORP) -------------
LEFT JOIN  SDM_ADJ_END_CORP ADJ_CORP_INDIR_CUST
    ON BILL.MARKET_PRODUCT_NUMBER = ADJ_CORP_INDIR_CUST.PRODUCT_ID
    AND BILL.DIRECT_CUSTOMER_CODE = ADJ_CORP_INDIR_CUST.DIR_CUST_CD
    AND BILL.INDIRECT_CUSTOMER_CODE = ADJ_CORP_INDIR_CUST.IND_CUST_CD
    AND BILL.PROCESS_DATE BETWEEN ADJ_CORP_INDIR_CUST.EFFECTIVE_FROM_DATE AND ADJ_CORP_INDIR_CUST.EFFECTIVE_TO_DATE 
    AND INDIR_CUST.CORPORATION_CODE= ADJ_CORP_INDIR_CUST.END_CORP_CD    
    AND INDIR_CUST.END_CORPORATION_CODE IS NULL
------------- ADJUSTED END CORP WITH DIRECT CUSTOMER -------------
LEFT JOIN  SDM_ADJ_END_CORP ADJ_CORP_DIR_CUST
    ON BILL.MARKET_PRODUCT_NUMBER = ADJ_CORP_DIR_CUST.PRODUCT_ID
    AND BILL.PROCESS_DATE BETWEEN ADJ_CORP_DIR_CUST.EFFECTIVE_FROM_DATE AND ADJ_CORP_DIR_CUST.EFFECTIVE_TO_DATE 
    AND ADJ_CORP_DIR_CUST.IND_CUST_CD IS NULL 


------------- REFERENCE CORP WITH END CORP-------------
LEFT JOIN  SDM_REF_CORP REF_CORP
    ON BILL.MARKET_PRODUCT_NUMBER = REF_CORP.PRODUCT_ID
    AND BILL.DIRECT_CUSTOMER_CODE = REF_CORP.DIR_CUST_CD
    AND BILL.INDIRECT_CUSTOMER_CODE = REF_CORP.IND_CUST_CD
    AND BILL.PROCESS_DATE BETWEEN REF_CORP.EFFECTIVE_FROM_DATE AND REF_CORP.EFFECTIVE_TO_DATE 
    AND END_CORP.CORPORATION_CODE= REF_CORP.END_CORP_CD
------------- REFERENCE END CORP WITH INDIRECT CUSTOMER (WHICH IS END CORP) -------------
LEFT JOIN  SDM_REF_CORP REF_CORP_INDIR_CUST
    ON BILL.MARKET_PRODUCT_NUMBER = REF_CORP_INDIR_CUST.PRODUCT_ID
    AND BILL.DIRECT_CUSTOMER_CODE = REF_CORP_INDIR_CUST.DIR_CUST_CD
    AND BILL.INDIRECT_CUSTOMER_CODE = REF_CORP_INDIR_CUST.IND_CUST_CD
    AND BILL.PROCESS_DATE BETWEEN REF_CORP_INDIR_CUST.EFFECTIVE_FROM_DATE AND REF_CORP_INDIR_CUST.EFFECTIVE_TO_DATE 
    AND INDIR_CUST.CORPORATION_CODE= REF_CORP_INDIR_CUST.END_CORP_CD    
    AND INDIR_CUST.END_CORPORATION_CODE IS NULL
------------- REFERENCE END CORP WITH DIRECT CUSTOMER -------------
LEFT JOIN  SDM_REF_CORP REF_CORP_DIR_CUST
    ON BILL.MARKET_PRODUCT_NUMBER = REF_CORP_DIR_CUST.PRODUCT_ID
    AND BILL.PROCESS_DATE BETWEEN REF_CORP_DIR_CUST.EFFECTIVE_FROM_DATE AND REF_CORP_DIR_CUST.EFFECTIVE_TO_DATE 
    AND REF_CORP_DIR_CUST.IND_CUST_CD IS NULL 
)
SELECT 
    BILLING_KEY,
    BILLING_DATE_KEY,
    PROCESS_DATE,
    DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,
    END_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    INDIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,
    ADJUSTED_END_CORPORATION_KEY,
    REFERENCE_CORPORATION_KEY,
    DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,
    END_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    INDIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,
    END_CORPORATION_DEFINITION,
    ADJUSTED_END_CORPORATION_CODE,
    REFERENCE_CORPORATION_CODE,
    BIW_INS_DTTM ,
	BIW_UPD_DTTM ,
	BIW_BATCH_ID  ,
    md5(object_construct ('col1',DIRECT_CUSTOMER_KEY::string,
    'col2',INDIRECT_CUSTOMER_KEY::string, 'col3',DIRECT_CORPORATION_KEY::string,
    'col4',INDIRECT_CORPORATION_KEY::string, 'col5',END_CORPORATION_KEY::string,
    'col6',ADJUSTED_END_CORPORATION_KEY::string, 'col7',REFERENCE_CORPORATION_KEY::string, 'col8',DIRECT_CUSTOMER_CODE::string,
    'col9',DIRECT_CORPORATION_CODE::string, 'col10',INDIRECT_CUSTOMER_CODE::string,
    'col11',INDIRECT_CORPORATION_CODE::string, 'col12',END_CORPORATION_CODE::string,
    'col13',ADJUSTED_END_CORPORATION_CODE::string, 'col14',REFERENCE_CORPORATION_CODE::string,
    'col15',END_CORPORATION_DEFINITION::string, 'col16',END_CUSTOMER_KEY::string)::string ) as BIW_MD5_KEY 
FROM FINAL_SQL 
