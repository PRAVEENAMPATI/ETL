/*---------------------------------------------------------------------------
Command to run model:
--dbt run --select ETL_MART_SALES_FUNNEL_FACT_HISTORY_ONE_TIME_LOAD+ --vars 'is_backfill: True'

Version     Date            Author               Description
-------     --------        -----------          ----------------------------------
1.0         11/14/2022      Vinay Subramanian    Initial Version
2.0         12/06/2022      Vinay Subramanian    Added 18 columns for Created, DIN and  DWIN
3.0         02/08/2023      Vinay Subramanian    Added added logical delete flag
---------------------------------------------------------------------------*/
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['FUNNEL_KEY']-%}
{% if is_incremental() %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_md5_column_list}}
{% endif %}

{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'ETL_MART_SALES_FUNNEL_FACT_HISTORY_ONE_TIME_LOAD'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}
{%- set V_EDW_DB = var('V_EDW_DEFAULT_DB') +env_var('DBT_DEP_ENV')+'.' -%}

{################# Snowflake Object Configuration #################}
{{
    config(
         description = 'Building table FUNNEL_FACT_HISTORY for MART_SALES'
        ,transient=true
        ,materialized='view'
        ,schema ='ETL_MART_SALES'
        ,alias='FUNNEL_FACT_HISTORY'
		,unique_key= v_pk_list
        ,tags =['MART_SALES']
		,post_hook= [v_sql_upd_success_batch]	
        )
}}

WITH FUNNEL_SNAPSHOT_FACT AS
(
    SELECT
    MD5(OBJECT_CONSTRUCT ('COL1',NVL(DESIGN_PART_MAPPING_AK,-1)::STRING
                         ,'COL2',SNAPSHOTDATE::STRING)::STRING) AS FUNNEL_KEY,
    SNAPSHOTDATE AS SNAPSHOT_DATE_KEY,
    KEY_DIRCUSTOMER,
    KEY_INDCUSTOMER,
    KEY_ENDCORPORATION,
    KEY_PRODUCT,
    KEY_ACTIONCALENDARDAY,
    DESIGN_REG_AK AS DESIGN_REGISTRATION_KEY,
    DESIGN_PART_MAPPING_AK AS DESIGN_PART_MAPPING_KEY,
    PRODUCTIONDATE AS PRODUCTION_DATE,
    DECISIONDATE AS DECISION_DATE,
    DESIGNIN_DATE AS DESIGN_IN_DATE,
    QTYPERSYSTEM AS QUANTITY_PER_SYSTEM,
    EXCHANGERATE	AS	EXCHANGE_RATE,
    TARGETPRICEUSD	AS	TARGET_PRICE_USD,
    NREUSD	AS	NRE_USD,
    DESIGNREVENUE	AS	DESIGN_REVENUE,
    DESIGNREVENUEWITHSHARE	AS	DESIGN_REVENUE_SHARE,
    CONFIDENCE,
    ONSHARE,
    COMMISSIONABLENREUSD	AS	COMMISSIONABLE_NRE_USD,
    COMMISSIONABLE3YREVUSD	AS	COMMISSIONABLE_THREE_YEAR_REVENUE_USD,
    THREE_YEAR_REV	AS	THREE_YEAR_REVENUE,
    LIFETIME_REV	AS	LIFETIME_REVENUE,
    NEWBUSINESSCOMMITPCT	AS	NEW_BUSINESS_COMMIT_PCT,
    COSTTODEVUSD	AS	COST_TO_DEV_USD,
    ITEMNUMBER	AS	ITEM_NUMBER,
    OPERATIONALASP	AS	OPERATIONAL_ASP,
    REFPRICE	AS	REF_PRICE,
    SIPMULTIPLIER	AS	SIP_MULTIPLIER,
    REGCOSTESTIMATE	AS	REGISTRATION_COST_ESTIMATE,
    BUPRICE	AS	BU_PRICE,
    CURRENCY_ISO_CD	AS	TRANSACTION_CURRENCY_ISO_CODE,
    PROJECTVALUEOVERLIFETIME AS	PROJECT_VALUE_OVER_LIFETIME,
    ONMARGINPERCENTATCUSTPRICEORREGPRICE	AS	ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE,
    CREATEDATE	AS	CREATED_DATE,
    MODIFIEDDATE	AS	MODIFIED_DATE,
    PROTOTYPEDATE	AS	PROTOTYPE_DATE,
    SOCKETSTATUSCHANGEDATE	AS	SOCKET_STATUS_CHANGE_DATE,
    REGITEMREQUESTDATE	AS	REGISTRATION_ITEM_REQUEST_DATE,
    REGITEMREVIEWDATE	AS	REGISTRATION_ITEM_REVIEW_DATE,
    REGITEMEXPIRE	AS	REGISTRATION_ITEM_EXPIRE,
    VALIDATEDDATE	AS	VALIDATED_DATE,
    COMMISSIONWINDATE	AS	COMMISSION_WIN_DATE,
    BLUESHEETFIRSTADDDATE	AS	BLUESHEET_FIRST_ADD_DATE,
    BLUESHEETUPDATEDDATE	AS	BLUESHEET_UPDATED_DATE,
    SAMPLES_REQD_DATE	AS	SAMPLES_REQUIRED_DATE,
    SEGMENTMUSTWINSETDATE	AS	SEGMENT_MUSTWIN_SET_DATE,
    EXECMUSTWINSETDATE	AS	EXEC_MUSTWIN_SET_DATE,
    VPMUSTWINSETDATE	AS	VP_MUSTWIN_SET_DATE,
    CLAIMWINDATE	AS	CLAIM_WIN_DATE,
    CASE WHEN NEXTMILESTONEDATE LIKE '%AM' 
         THEN NEXTMILESTONEDATE
         ELSE SUBSTR(NEXTMILESTONEDATE,5,2)||'/'||SUBSTR(NEXTMILESTONEDATE,7,2)||'/'||SUBSTR(NEXTMILESTONEDATE,1,4)||' '||
              SUBSTR(NEXTMILESTONEDATE,10,2)||':'||SUBSTR(NEXTMILESTONEDATE,12,2)||':'||SUBSTR(NEXTMILESTONEDATE,14,2)||' AM' END AS NEXT_MILESTONE_DATE,
    OPPORTUNITYDECISIONDATE	AS	OPPORTUNITY_DECISION_DATE,
    BUSTARTDATE	AS	BU_START_DATE,
    BUENDDATE	AS	BU_END_DATE,
    ORIGINALAPPROVALDATE	AS	ORIGINAL_APPROVAL_DATE,
    ORIGINALDISPOSITIONDATE	AS	ORIGINAL_DISPOSITION_DATE,
    PROJECTMODIFIEDDATE	AS	PROJECT_MODIFIED_DATE,
    BU_DESIGNIN_REQUEST_DATE	AS	BU_DESIGN_IN_REQUEST_DATE,
    ISPARTACTIVE_FLAG	AS	IS_PART_ACTIVE,
    PRIMARYOPN_FLAG	AS IS_PRIMARY_OPN,
    ISOPPORTUNITY_FLAG	AS	IS_OPPORTUNITY,
    REFERENCEDESIGN_FLAG	AS	IS_REFERENCE_DESIGN,
    MUSTWIN_FLAG	AS	IS_MUSTWIN,
    SEGMENTMUSTWIN_FLAG	AS	IS_SEGMENT_MUSTWIN,
    EXECMUSTWIN_FLAG	AS	IS_EXECMUSTWIN,
    VPMUSTWIN_FLAG	AS	IS_VPNMUSTWIN,
    DSMREVIEW_FLAG	AS	IS_DSM_REVIEW,
    BOMEXPANSION_FLAG	AS	IS_BOM_EXPANSION,
    SUNSETINDICATOR	AS	IS_SUNSET,
    NPIFLAG	AS	IS_NPI,
    CREATEDBY	AS	CREATED_BY,
    MODIFIEDBY	AS	MODIFIED_BY,
    OPPORTUNITYNUMBER	AS	OPPORTUNITY_NUMBER,
    OPPORTUNITYLIFECYCLESTATUS	AS	OPPORTUNITY_LIFECYCLE_STATUS,
    DESIGNTYPE	AS	DESIGN_TYPE,
    CHANNELTYPE	AS	CHANNEL_TYPE,
    CHANNEL,
    FSE,
    FAE,
    PRODUCTMARKETER	AS	PRODUCT_MARKETER,
    SECINVOLVEMENT	AS	SEC_INVOLVEMENT,
    PROGRAMSTATUS	AS	PROGRAM_STATUS,
    PROGRAMNAME	AS	PROGRAM_NAME,
    BOARDNAME	AS	BOARD_NAME,
    ESTANNUALBOARDS	AS	ESTIMATED_ANNUAL_BOARDS,
    PARTTYPE	AS	PART_TYPE,
    LINEDESCRIPTION	AS	LINE_DESCRIPTION,
    SALESSOCKETSTATUS	AS	SALES_SOCKET_STATUS,
    CORPSOCKETSTATUS	AS	CORPORATION_SOCKET_STATUS,
    SEGMENT,
    APPLICATION,
    REGISTRATIONNUMBER	AS	REGISTRATION_NUMBER,
    ACTIONNOTES	AS	ACTION_NOTES,
    OPPORTUNITYCOMMENTS	AS	OPPORTUNITY_COMMENTS,
    DISTRIBUTORNAME	AS	DISTRIBUTOR_NAME,
    DISTRIBUTORBRANCHNAME	AS	DISTRIBUTOR_BRANCH_NAME,
    REGITEMREVIEWBY	AS	REGISTRATION_ITEM_REVIEWBY,
    REGITEMSTATUS	AS	REGISTRATION_ITEM_STATUS,
    REGITEMCANCELREJECTREASON	AS	REGISTRATION_ITEM_CANCEL_REJECT_REASON,
    DISTRIBUTORFSE	AS	DISTRIBUTOR_FSE,
    DISTRIBUTORFAE	AS	DISTRIBUTOR_FAE,
    COMMISSIONUPDATEDBY	AS	COMMISSION_UPDATED_BY,
    COMMISSIONNOTES	AS	COMMISSION_NOTES,
    BLUESHEETREQUIRED	AS	BLUE_SHEET_REQUIRED,
    BLUESHEETURL	AS	BLUE_SHEET_URL,
    BUSTATUS	AS	BU_STATUS,
    BUCOMMENT	AS	BU_COMMENT,
    CROSSSELLTYPE	AS	CROSS_SELL_TYPE,
    COMPETITION	AS	COMPETITION,
    RYGSTATUS	AS	RYG_STATUS,
    SWATTEAM	AS	SWAT_TEAM,
    REGISTRATIONITEMNUMBER	AS	REGISTRATION_ITEM_NUMBER,
    DESIGNSTATUS	AS	DESIGN_STATUS,
    BUACTIONNOTES	AS	BU_ACTION_NOTES,
    BU_DESIGNIN_REQUEST	AS	BU_DESIGN_IN_REQUEST,
    POS50K_2M_REGOWNER	AS	POS50K_2M_REGOWNER,
    POS2MPLUS_REGOWNER	AS	POS2MPLUS_REGOWNER,
    POS50K_2M_NON_REGOWNER	AS	POS50K_2M_NON_REGOWNER,
    POS2MPLUS_NON_REGOWNER	AS	POS2MPLUS_NON_REGOWNER,
    REBATENOTES	AS	REBATE_NOTES,
    REFERENCEOPPNUMBER	AS	REFERENCE_OPPORTUNITY_NUMBER,
    DESIGNINAPPROVER	AS	DESIGN_IN_APPROVER,
    BUMARKETERAPPROVAL	AS	BU_MARKETER_APPROVAL,
    BUMARKETERAPPROVERID	AS	BU_MARKETER_APPROVER_ID,
    BUMARKETERAPPROVERNAME	AS	BU_MARKETER_APPROVER_NAME,
    DISTRIBUTORPROJECTREF	AS	DISTRIBUTOR_PROJECT_REF,
    DISTRIBUTORDEVICEREF	AS	DISTRIBUTOR_DEVICE_REF,
    BLOCKDIAGRAMCOMPLETE	AS	BLOCK_DIAGRAM_COMPLETE,
    OPP_REGTYPE	AS	OPPORTUNITY_REGISTRATION_TYPE,
    TRANSFERSTATUS	AS	TRANSFER_STATUS,
    DISTRIBUTORNOTES	AS	DISTRIBUTOR_NOTES,
    SPLITREVIEWSTATUS	AS	SPLIT_REVIEW_STATUS,
    LOWMARGINEXCEPTION	AS	LOW_MARGIN_EXCEPTION,
    MARGINBUCKET	AS	MARGIN_BUCKET,
    NPISTATUS	AS	NPI_STATUS,
    NPINUMBER	AS	NPI_NUMBER,
    NPDPROJECTNUMBER	AS	NPD_PROJECT_NUMBER,
    OPPORTUNITYLINECONTACT AS OPPORTUNITY_LINE_CONTACT,
    SIPREASON AS SIP_REASON,
    DESIGNWINREQUESTSTATUS AS DESIGNWIN_REQUEST_STATUS,
    CATCHUPREG AS CATCHUP_REG,
    EFFORTTIER AS EFFORT_TIER,
    PRODUCTTIER AS PRODUCT_TIER,
    DESIGNINDESIGNWINAPPROVER AS DESIGNIN_DESIGNWIN_APPROVER
    FROM 
    {{ source('STG_DWH_SALES', 'FUNNEL_SNAPSHOT_FACT') }}
    QUALIFY(ROW_NUMBER() OVER (PARTITION BY DESIGN_PART_MAPPING_AK,SNAPSHOTDATE ORDER BY BIW_UPD_DTTM DESC) =1)
),

DIM_CUSTOMERS AS (
  SELECT 
    KEY_CUSTOMER,
    CUST_CD,
    CORP_CD
  FROM 
  {{ source('STG_SDM_CORE', 'DIM_CUSTOMERS') }} 
  QUALIFY(ROW_NUMBER() OVER (PARTITION BY CUST_CD ORDER BY BIW_UPD_DTTM DESC) =1)
),

DIM_CORP AS (
  SELECT 
    KEY_CORPORATION,
    CORP_CD
  FROM 
    {{ source('STG_SDM_CORE', 'LKP_CORPORATIONS') }}
    QUALIFY(ROW_NUMBER() OVER (PARTITION BY CORP_CD ORDER BY BIW_UPD_DTTM DESC) =1)
),

VW_PRODUCTS AS (
    SELECT 
      KEY_PRODUCT ,
      PRODUCT_ID
    FROM   {{ source('STG_SDM_PRESENTATION', 'VW_PRODUCTS') }}
),

LKP_CALENDARDAY AS (
    SELECT 
      KEY_CALENDARDAY ,
      PROCESSDATE
    FROM   {{ source('STG_SDM_CORE', 'LKP_CALENDARDAY') }}
),

MPN_IPN_XREF AS
(
	SELECT 
		MPN,
        IPN,
        CUST5_CODE,
        END_CORP_CODE,
        CORP_NAME,
        START_DATE,
        END_DATE,
		CURRENT_DEFAULT_IPN,
        BIW_UPD_DTTM
	    FROM 
        (SELECT 		
            MPN,
            IPN,
            CUST5_CODE,
            END_CORP_CODE,
            CORP_NAME,
            START_DATE,
            END_DATE,
            CURRENT_DEFAULT_IPN,
            BIW_UPD_DTTM
        FROM {{source('STG_PCN_PUBLIC','TRANSPARENT_FLOW_XREF')}}
        QUALIFY( ROW_NUMBER() OVER (PARTITION BY ID ORDER BY BIW_UPD_DTTM DESC)=1)
        ) ACTIVE_REC
	QUALIFY( ROW_NUMBER() OVER (PARTITION BY MPN,CUST5_CODE,END_CORP_CODE,CORP_NAME,START_DATE ORDER BY BIW_UPD_DTTM DESC)=1)
),

DESIGN_TYPE_OPPORTUNITY AS (
  SELECT   
    DESIGN_PART_MAPPING_KEY, 
    SNAPSHOT_DATE_KEY,
    DESIGN_TYPE,
    CREATED_DATE,
    ESTIMATED_ANNUAL_BOARDS,
    QUANTITY_PER_SYSTEM,
    TARGET_PRICE_USD,
    DESIGN_REVENUE_SHARE,
    ONSHARE,
    PROJECT_VALUE_OVER_LIFETIME,
    EXCHANGE_RATE
    FROM FUNNEL_SNAPSHOT_FACT 
    WHERE DESIGN_TYPE='Opportunity' 
    AND TO_NUMBER(TO_CHAR(CREATED_DATE,'YYYYMMDD')) = SNAPSHOT_DATE_KEY-1
),

DESIGN_TYPE_REGISTRATION AS (
  SELECT   
    DESIGN_PART_MAPPING_KEY, 
    SNAPSHOT_DATE_KEY,
    DESIGN_TYPE,
    REGISTRATION_ITEM_REVIEW_DATE,
    REGISTRATION_ITEM_STATUS,
    ESTIMATED_ANNUAL_BOARDS,
    QUANTITY_PER_SYSTEM,
    TARGET_PRICE_USD,
    DESIGN_REVENUE_SHARE,
    ONSHARE,
    PROJECT_VALUE_OVER_LIFETIME,
    EXCHANGE_RATE
    FROM FUNNEL_SNAPSHOT_FACT 
    WHERE DESIGN_TYPE='Registration' 
    AND TO_NUMBER(TO_CHAR(REGISTRATION_ITEM_REVIEW_DATE,'YYYYMMDD')) = SNAPSHOT_DATE_KEY-1
    AND REGISTRATION_ITEM_STATUS IN ('Approved','Expired')
),

FINAL_SQL AS (
SELECT 
    FACT.FUNNEL_KEY,
    FACT.SNAPSHOT_DATE_KEY,
    MD5(COALESCE(DIRCUST.CUST_CD,'-1')) AS DIRECT_CUSTOMER_KEY,
    MD5(COALESCE(INDCUST.CUST_CD,'-1')) AS INDIRECT_CUSTOMER_KEY,
    MD5(COALESCE(DIRCUST.CUST_CD,'-1')) AS END_CUSTOMER_KEY,
    MD5(COALESCE(DIRCUST.CORP_CD,'-1')) AS DIRECT_CORPORATION_KEY,
    MD5(COALESCE(DIRCUST.CORP_CD,'-1')) AS INDIRECT_CORPORATION_KEY,
    MD5(COALESCE(CORP.CORP_CD,'-1')) AS END_CORPORATION_KEY,
    MD5(COALESCE(PROD.PRODUCT_ID,'-1')) AS MARKET_PRODUCT_NUMBER_KEY,
    MD5(COALESCE(IPN_REF_DIR_CUST.IPN,IPN_REF_END_CORP.IPN, IPN_REF_DIR_MPN.IPN,PROD.PRODUCT_ID,'-1')) AS INTERNAL_PART_NUMBER_KEY,
    TO_CHAR(FACT.PRODUCTION_DATE, 'YYYYMMDD')::INT AS PRODUCTION_DATE_KEY,
    FACT.DESIGN_REGISTRATION_KEY,
    FACT.DESIGN_PART_MAPPING_KEY,
    TO_CHAR(FACT.DECISION_DATE, 'YYYYMMDD')::INT AS DECISION_DAY_KEY,
    TO_CHAR(FACT.DESIGN_IN_DATE, 'YYYYMMDD')::INT AS DESIGN_IN_DAY_KEY,
    TO_CHAR(ACTION_DT.PROCESSDATE, 'YYYYMMDD')::INT AS ACTION_DAY_KEY,
    DIRCUST.CUST_CD AS DIRECT_CUSTOMER_CODE,
    INDCUST.CUST_CD AS INDIRECT_CUSTOMER_CODE,
    DIRCUST.CUST_CD AS END_CUSTOMER_CODE,
    DIRCUST.CORP_CD AS DIRECT_CORPORATION_CODE,
    DIRCUST.CORP_CD AS INDIRECT_CORPORATION_CODE,
    CORP.CORP_CD AS END_CORPORATION_CODE,
    PROD.PRODUCT_ID AS MARKET_PRODUCT_NUMBER,
    COALESCE(IPN_REF_DIR_CUST.IPN,IPN_REF_END_CORP.IPN, IPN_REF_DIR_MPN.IPN,PROD.PRODUCT_ID) AS INTERNAL_PART_NUMBER,
    FACT.PRODUCTION_DATE AS TRANSACTION_DATE,
    FACT.DECISION_DATE AS DECISION_DATE,
    ACTION_DT.PROCESSDATE AS ACTION_DATE,
    FACT.DESIGN_IN_DATE AS DESIGN_IN_DATE,
    FACT.QUANTITY_PER_SYSTEM,
    FACT.EXCHANGE_RATE,
    FACT.TARGET_PRICE_USD,
    FACT.NRE_USD,
    FACT.DESIGN_REVENUE,
    FACT.DESIGN_REVENUE_SHARE,
    FACT.CONFIDENCE,
    FACT.ONSHARE,
    FACT.COMMISSIONABLE_NRE_USD,
    FACT.COMMISSIONABLE_THREE_YEAR_REVENUE_USD,
    FACT.THREE_YEAR_REVENUE,
    FACT.LIFETIME_REVENUE,
    FACT.NEW_BUSINESS_COMMIT_PCT,
    FACT.COST_TO_DEV_USD,
    FACT.ITEM_NUMBER,
    FACT.OPERATIONAL_ASP,
    FACT.REF_PRICE,
    FACT.SIP_MULTIPLIER,
    FACT.REGISTRATION_COST_ESTIMATE,
    FACT.BU_PRICE,
    FACT.TRANSACTION_CURRENCY_ISO_CODE,
    FACT.PROJECT_VALUE_OVER_LIFETIME,
    FACT.ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE,
    FACT.CREATED_DATE,
    FACT.MODIFIED_DATE,
    FACT.PROTOTYPE_DATE,
    FACT.SOCKET_STATUS_CHANGE_DATE,
    FACT.REGISTRATION_ITEM_REQUEST_DATE,
    FACT.REGISTRATION_ITEM_REVIEW_DATE,
    FACT.REGISTRATION_ITEM_EXPIRE,
    FACT.VALIDATED_DATE,
    FACT.COMMISSION_WIN_DATE,
    FACT.BLUESHEET_FIRST_ADD_DATE,
    FACT.BLUESHEET_UPDATED_DATE,
    FACT.SAMPLES_REQUIRED_DATE,
    FACT.SEGMENT_MUSTWIN_SET_DATE,
    FACT.EXEC_MUSTWIN_SET_DATE,
    FACT.VP_MUSTWIN_SET_DATE,
    FACT.CLAIM_WIN_DATE,
    TO_TIMESTAMP(FACT.NEXT_MILESTONE_DATE,'MM/DD/YYYY HH12:MI:SS AM')::TIMESTAMP_NTZ AS NEXT_MILESTONE_DATE,
    FACT.OPPORTUNITY_DECISION_DATE,
    FACT.BU_START_DATE,
    FACT.BU_END_DATE,
    FACT.ORIGINAL_APPROVAL_DATE,
    FACT.ORIGINAL_DISPOSITION_DATE,
    FACT.PROJECT_MODIFIED_DATE,
    FACT.BU_DESIGN_IN_REQUEST_DATE,
    (CASE WHEN FACT.IS_PART_ACTIVE in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_PART_ACTIVE,
    (CASE WHEN FACT.IS_PRIMARY_OPN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_PRIMARY_OPN,
    (CASE WHEN FACT.IS_OPPORTUNITY in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_OPPORTUNITY, 
    (CASE WHEN FACT.IS_REFERENCE_DESIGN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_REFERENCE_DESIGN, 
    (CASE WHEN FACT.IS_MUSTWIN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_MUSTWIN,
    (CASE WHEN FACT.IS_SEGMENT_MUSTWIN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_SEGMENT_MUSTWIN, 
    (CASE WHEN FACT.IS_EXECMUSTWIN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_EXECMUSTWIN,  
    (CASE WHEN FACT.IS_VPNMUSTWIN in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_VPNMUSTWIN, 
    (CASE WHEN FACT.IS_DSM_REVIEW in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_DSM_REVIEW, 
    (CASE WHEN FACT.IS_BOM_EXPANSION in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_BOM_EXPANSION,
    (CASE WHEN FACT.IS_SUNSET in (1,-1) 
        THEN 'TRUE'
        ELSE 'FALSE'
    END)::BOOLEAN AS IS_SUNSET,                          
    COALESCE(TRY_TO_BOOLEAN(FACT.IS_NPI),'FALSE')::BOOLEAN AS IS_NPI,
    FACT.CREATED_BY,
    FACT.MODIFIED_BY,
    FACT.OPPORTUNITY_NUMBER,
    FACT.OPPORTUNITY_LIFECYCLE_STATUS,
    FACT.DESIGN_TYPE,
    FACT.CHANNEL_TYPE,
    FACT.CHANNEL,
    FACT.FSE,
    FACT.FAE,
    FACT.PRODUCT_MARKETER,
    FACT.SEC_INVOLVEMENT,
    FACT.PROGRAM_STATUS,
    FACT.PROGRAM_NAME,
    FACT.BOARD_NAME,
    FACT.ESTIMATED_ANNUAL_BOARDS,
    FACT.PART_TYPE,
    FACT.LINE_DESCRIPTION,
    FACT.SALES_SOCKET_STATUS,
    FACT.CORPORATION_SOCKET_STATUS,
    FACT.SEGMENT,
    FACT.APPLICATION,
    FACT.REGISTRATION_NUMBER,
    FACT.ACTION_NOTES,
    FACT.OPPORTUNITY_COMMENTS,
    FACT.DISTRIBUTOR_NAME,
    FACT.DISTRIBUTOR_BRANCH_NAME,
    FACT.REGISTRATION_ITEM_REVIEWBY,
    FACT.REGISTRATION_ITEM_STATUS,
    FACT.REGISTRATION_ITEM_CANCEL_REJECT_REASON,
    FACT.DISTRIBUTOR_FSE,
    FACT.DISTRIBUTOR_FAE,
    FACT.COMMISSION_UPDATED_BY,
    FACT.COMMISSION_NOTES,
    FACT.BLUE_SHEET_REQUIRED,
    FACT.BLUE_SHEET_URL,
    FACT.BU_STATUS,
    FACT.BU_COMMENT,
    FACT.CROSS_SELL_TYPE,
    FACT.COMPETITION,
    FACT.RYG_STATUS,
    FACT.SWAT_TEAM,
    FACT.REGISTRATION_ITEM_NUMBER,
    FACT.DESIGN_STATUS,
    FACT.BU_ACTION_NOTES,
    FACT.BU_DESIGN_IN_REQUEST,
    FACT.POS50K_2M_REGOWNER,
    FACT.POS2MPLUS_REGOWNER,
    FACT.POS50K_2M_NON_REGOWNER,
    FACT.POS2MPLUS_NON_REGOWNER,
    FACT.REBATE_NOTES,
    FACT.REFERENCE_OPPORTUNITY_NUMBER,
    FACT.DESIGN_IN_APPROVER,
    FACT.BU_MARKETER_APPROVAL,
    FACT.BU_MARKETER_APPROVER_ID,
    FACT.BU_MARKETER_APPROVER_NAME,
    FACT.DISTRIBUTOR_PROJECT_REF,
    FACT.DISTRIBUTOR_DEVICE_REF,
    FACT.BLOCK_DIAGRAM_COMPLETE,
    FACT.OPPORTUNITY_REGISTRATION_TYPE,
    FACT.TRANSFER_STATUS,
    FACT.DISTRIBUTOR_NOTES,
    FACT.SPLIT_REVIEW_STATUS,
    FACT.LOW_MARGIN_EXCEPTION,
    FACT.MARGIN_BUCKET,
    FACT.NPI_STATUS,
    FACT.NPI_NUMBER,
    FACT.NPD_PROJECT_NUMBER,
    FACT.OPPORTUNITY_LINE_CONTACT,
    FACT.SIP_REASON,
    FACT.DESIGNWIN_REQUEST_STATUS,
    FACT.CATCHUP_REG,
    FACT.EFFORT_TIER,
    FACT.PRODUCT_TIER,
    FACT.DESIGNIN_DESIGNWIN_APPROVER,
    'MODELN'::VARCHAR(30) AS SOURCE_SYSTEM,
    ------------------Created_XXXX---------------------------
    COALESCE(REG.ESTIMATED_ANNUAL_BOARDS,OPP.ESTIMATED_ANNUAL_BOARDS) AS CREATED_ESTIMATED_ANNUAL_BOARDS,
    COALESCE(REG.QUANTITY_PER_SYSTEM,OPP.QUANTITY_PER_SYSTEM) AS CREATED_QUANTITY_PER_SYSTEM, 
    COALESCE(REG.TARGET_PRICE_USD,OPP.TARGET_PRICE_USD) AS CREATED_TARGET_PRICE_USD, 
    COALESCE(REG.DESIGN_REVENUE_SHARE,OPP.DESIGN_REVENUE_SHARE) AS CREATED_DESIGN_REVENUE_SHARE, 
    COALESCE(REG.ONSHARE,OPP.ONSHARE) AS CREATED_ONSHARE, 
    COALESCE(REG.PROJECT_VALUE_OVER_LIFETIME/REG.EXCHANGE_RATE,OPP.PROJECT_VALUE_OVER_LIFETIME/OPP.EXCHANGE_RATE) AS CREATED_PROJECT_VALUE_OVER_LIFETIME, 
    ------------------DIN_XXXX---------------------------
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1 
        THEN FACT.ESTIMATED_ANNUAL_BOARDS 
    END AS DIN_ESTIMATED_ANNUAL_BOARDS,
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1
        THEN FACT.QUANTITY_PER_SYSTEM 
    END AS DIN_QUANTITY_PER_SYSTEM, 
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1 
        THEN FACT.TARGET_PRICE_USD 
    END AS DIN_TARGET_PRICE_USD, 
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1
        THEN FACT.DESIGN_REVENUE_SHARE 
    END AS DIN_DESIGN_REVENUE_SHARE,
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1 
        THEN FACT.ONSHARE
    END AS DIN_ONSHARE,
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.DESIGN_IN_DATE,'YYYYMMDD')) = FACT.SNAPSHOT_DATE_KEY - 1 
        THEN FACT.PROJECT_VALUE_OVER_LIFETIME/FACT.EXCHANGE_RATE 
    END AS DIN_PROJECT_VALUE_OVER_LIFETIME,
    ------------------DWIN_XXXX---------------------------
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1   
        THEN FACT.ESTIMATED_ANNUAL_BOARDS
    END AS DWIN_ESTIMATED_ANNUAL_BOARDS, 
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1  
        THEN FACT.QUANTITY_PER_SYSTEM 
    END AS DWIN_QUANTITY_PER_SYSTEM, 
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1  
        THEN FACT.TARGET_PRICE_USD
    END AS DWIN_TARGET_PRICE_USD, 
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1  
        THEN FACT.DESIGN_REVENUE_SHARE 
    END AS DWIN_DESIGN_REVENUE_SHARE,
    CASE 
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1
        THEN FACT.ONSHARE 
    END AS DWIN_ONSHARE,
    CASE
        WHEN TO_NUMBER(TO_CHAR(FACT.CLAIM_WIN_DATE,'YYYYMMDD'))  = FACT.SNAPSHOT_DATE_KEY - 1
        THEN FACT.PROJECT_VALUE_OVER_LIFETIME/FACT.EXCHANGE_RATE
    END AS DWIN_PROJECT_VALUE_OVER_LIFETIME,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
    {{V_BIW_BATCH_ID}} AS BIW_BATCH_ID, 
    'N'::BOOLEAN BIW_LOGICAL_DELETE_FLAG 
  FROM FUNNEL_SNAPSHOT_FACT FACT
  LEFT OUTER JOIN DIM_CUSTOMERS DIRCUST 
      ON FACT.KEY_DIRCUSTOMER = DIRCUST.KEY_CUSTOMER
  LEFT OUTER JOIN DIM_CUSTOMERS INDCUST 
      ON FACT.KEY_INDCUSTOMER = INDCUST.KEY_CUSTOMER
  LEFT OUTER JOIN DIM_CORP CORP 
      ON FACT.KEY_ENDCORPORATION = CORP.KEY_CORPORATION  
  LEFT OUTER JOIN VW_PRODUCTS PROD 
      ON FACT.KEY_PRODUCT = PROD.KEY_PRODUCT
  LEFT OUTER JOIN LKP_CALENDARDAY ACTION_DT 
      ON FACT.KEY_ACTIONCALENDARDAY = ACTION_DT.KEY_CALENDARDAY        
  ---------- CROSS REFERENCE CHECK ON MPN AND IPN-------------------
 --- FINDING USING DIRECT CUSTOMER
  LEFT OUTER JOIN MPN_IPN_XREF AS IPN_REF_DIR_CUST
      ON PROD.PRODUCT_ID = IPN_REF_DIR_CUST.MPN
      AND  DIRCUST.CUST_CD = IPN_REF_DIR_CUST.CUST5_CODE
      AND  FACT.CREATED_DATE BETWEEN IPN_REF_DIR_CUST.START_DATE AND IPN_REF_DIR_CUST.END_DATE
      AND IPN_REF_DIR_CUST.END_CORP_CODE IS NULL
      --- FINDING USING END CORP CUSTOMER
  LEFT OUTER JOIN MPN_IPN_XREF AS IPN_REF_END_CORP
      ON PROD.PRODUCT_ID = IPN_REF_END_CORP.MPN
      AND CORP.CORP_CD = IPN_REF_END_CORP.END_CORP_CODE
      AND FACT.CREATED_DATE BETWEEN IPN_REF_END_CORP.START_DATE AND IPN_REF_END_CORP.END_DATE
      AND IPN_REF_END_CORP.CUST5_CODE IS NULL
      --- FINDING USING DIRECT LOOKUP
  LEFT OUTER JOIN MPN_IPN_XREF AS IPN_REF_DIR_MPN
      ON PROD.PRODUCT_ID = IPN_REF_DIR_MPN.MPN
      AND FACT.CREATED_DATE BETWEEN IPN_REF_DIR_MPN.START_DATE AND IPN_REF_DIR_MPN.END_DATE
      AND IPN_REF_DIR_MPN.CUST5_CODE IS NULL
      AND IPN_REF_DIR_MPN.END_CORP_CODE IS NULL
      AND IPN_REF_DIR_MPN.CURRENT_DEFAULT_IPN::BOOLEAN = 'TRUE'  
  LEFT OUTER JOIN  DESIGN_TYPE_OPPORTUNITY OPP 
      ON FACT.DESIGN_PART_MAPPING_KEY = OPP.DESIGN_PART_MAPPING_KEY
      AND FACT.SNAPSHOT_DATE_KEY = OPP.SNAPSHOT_DATE_KEY
  LEFT OUTER JOIN  DESIGN_TYPE_REGISTRATION REG 
      ON FACT.DESIGN_PART_MAPPING_KEY = REG.DESIGN_PART_MAPPING_KEY
      AND FACT.SNAPSHOT_DATE_KEY = REG.SNAPSHOT_DATE_KEY
)

SELECT 
    FINAL_SQL.*,
    md5(object_construct ('col1',SNAPSHOT_DATE_KEY::string, 'col2',DIRECT_CUSTOMER_KEY::string,
    'col3',INDIRECT_CUSTOMER_KEY::string, 'col4',END_CUSTOMER_KEY::string, 'col5',DIRECT_CORPORATION_KEY::string,
    'col6',INDIRECT_CORPORATION_KEY::string, 'col7',END_CORPORATION_KEY::string, 'col8',MARKET_PRODUCT_NUMBER_KEY::string,
    'col9',INTERNAL_PART_NUMBER_KEY::string, 'col10',PRODUCTION_DATE_KEY::string, 'col11',DESIGN_REGISTRATION_KEY::string,
    'col12',DESIGN_PART_MAPPING_KEY::string, 'col13',DECISION_DAY_KEY::string, 'col14',DESIGN_IN_DAY_KEY::string,
    'col15',ACTION_DAY_KEY::string, 'col16',DIRECT_CUSTOMER_CODE::string, 'col17',INDIRECT_CUSTOMER_CODE::string,
    'col18',END_CUSTOMER_CODE::string, 'col19',DIRECT_CORPORATION_CODE::string, 'col20',INDIRECT_CORPORATION_CODE::string,
    'col21',END_CORPORATION_CODE::string, 'col22',MARKET_PRODUCT_NUMBER::string, 'col23',INTERNAL_PART_NUMBER::string,
    'col24',TRANSACTION_DATE::string, 'col25',DECISION_DATE::string, 'col26',ACTION_DATE::string, 'col27',DESIGN_IN_DATE::string,
    'col28',QUANTITY_PER_SYSTEM::string, 'col29',EXCHANGE_RATE::string, 'col30',TARGET_PRICE_USD::string, 'col31',NRE_USD::string,
    'col32',DESIGN_REVENUE::string, 'col33',DESIGN_REVENUE_SHARE::string, 'col34',CONFIDENCE::string, 'col35',ONSHARE::string,
    'col36',COMMISSIONABLE_NRE_USD::string, 'col37',COMMISSIONABLE_THREE_YEAR_REVENUE_USD::string, 'col38',THREE_YEAR_REVENUE::string,
    'col39',LIFETIME_REVENUE::string, 'col40',NEW_BUSINESS_COMMIT_PCT::string, 'col41',COST_TO_DEV_USD::string,
    'col42',ITEM_NUMBER::string, 'col43',OPERATIONAL_ASP::string, 'col44',REF_PRICE::string, 'col45',SIP_MULTIPLIER::string,
    'col46',REGISTRATION_COST_ESTIMATE::string, 'col47',BU_PRICE::string, 'col48',TRANSACTION_CURRENCY_ISO_CODE::string,
    'col49',PROJECT_VALUE_OVER_LIFETIME::string, 'col50',ONMARGIN_PERCENT_CUSTOMER_PRICE_REGULAR_PRICE::string, 'col51',CREATED_DATE::string,
    'col52',MODIFIED_DATE::string, 'col53',PROTOTYPE_DATE::string, 'col54',SOCKET_STATUS_CHANGE_DATE::string,
    'col55',REGISTRATION_ITEM_REQUEST_DATE::string, 'col56',REGISTRATION_ITEM_REVIEW_DATE::string, 'col57',REGISTRATION_ITEM_EXPIRE::string,
    'col58',VALIDATED_DATE::string, 'col59',COMMISSION_WIN_DATE::string, 'col60',BLUESHEET_FIRST_ADD_DATE::string,
    'col61',BLUESHEET_UPDATED_DATE::string, 'col62',SAMPLES_REQUIRED_DATE::string, 'col63',SEGMENT_MUSTWIN_SET_DATE::string,
    'col64',EXEC_MUSTWIN_SET_DATE::string, 'col65',VP_MUSTWIN_SET_DATE::string, 'col66',CLAIM_WIN_DATE::string,
    'col67',NEXT_MILESTONE_DATE::string, 'col68',OPPORTUNITY_DECISION_DATE::string, 'col69',BU_START_DATE::string,
    'col70',BU_END_DATE::string, 'col71',ORIGINAL_APPROVAL_DATE::string, 'col72',ORIGINAL_DISPOSITION_DATE::string,
    'col73',PROJECT_MODIFIED_DATE::string, 'col74',BU_DESIGN_IN_REQUEST_DATE::string, 'col75',IS_PART_ACTIVE::string,
    'col76',IS_PRIMARY_OPN::string, 'col77',IS_OPPORTUNITY::string, 'col78',IS_REFERENCE_DESIGN::string, 'col79',IS_MUSTWIN::string,
    'col80',IS_SEGMENT_MUSTWIN::string, 'col81',IS_EXECMUSTWIN::string, 'col82',IS_VPNMUSTWIN::string, 'col83',IS_DSM_REVIEW::string,
    'col84',IS_BOM_EXPANSION::string, 'col85',IS_SUNSET::string, 'col86',IS_NPI::string, 'col87',CREATED_BY::string,
    'col88',MODIFIED_BY::string, 'col89',OPPORTUNITY_NUMBER::string, 'col90',OPPORTUNITY_LIFECYCLE_STATUS::string,
    'col91',DESIGN_TYPE::string, 'col92',CHANNEL_TYPE::string, 'col93',CHANNEL::string, 'col94',FSE::string, 'col95',FAE::string,
    'col96',PRODUCT_MARKETER::string, 'col97',SEC_INVOLVEMENT::string, 'col98',PROGRAM_STATUS::string, 'col99',PROGRAM_NAME::string,
    'col100',BOARD_NAME::string, 'col101',ESTIMATED_ANNUAL_BOARDS::string, 'col102',PART_TYPE::string,
    'col103',LINE_DESCRIPTION::string, 'col104',SALES_SOCKET_STATUS::string, 'col105',CORPORATION_SOCKET_STATUS::string,
    'col106',SEGMENT::string, 'col107',APPLICATION::string, 'col108',REGISTRATION_NUMBER::string, 'col109',ACTION_NOTES::string,
    'col110',OPPORTUNITY_COMMENTS::string, 'col111',DISTRIBUTOR_NAME::string, 'col112',DISTRIBUTOR_BRANCH_NAME::string,
    'col113',REGISTRATION_ITEM_REVIEWBY::string, 'col114',REGISTRATION_ITEM_STATUS::string,
    'col115',REGISTRATION_ITEM_CANCEL_REJECT_REASON::string, 'col116',DISTRIBUTOR_FSE::string, 'col117',DISTRIBUTOR_FAE::string,
    'col118',COMMISSION_UPDATED_BY::string, 'col119',COMMISSION_NOTES::string, 'col120',BLUE_SHEET_REQUIRED::string,
    'col121',BLUE_SHEET_URL::string, 'col122',BU_STATUS::string, 'col123',BU_COMMENT::string, 'col124',CROSS_SELL_TYPE::string,
    'col125',COMPETITION::string, 'col126',RYG_STATUS::string, 'col127',SWAT_TEAM::string,
    'col128',REGISTRATION_ITEM_NUMBER::string, 'col129',DESIGN_STATUS::string, 'col130',BU_ACTION_NOTES::string,
    'col131',BU_DESIGN_IN_REQUEST::string, 'col132',POS50K_2M_REGOWNER::string, 'col133',POS2MPLUS_REGOWNER::string,
    'col134',POS50K_2M_NON_REGOWNER::string, 'col135',POS2MPLUS_NON_REGOWNER::string, 'col136',REBATE_NOTES::string,
    'col137',REFERENCE_OPPORTUNITY_NUMBER::string, 'col138',DESIGN_IN_APPROVER::string, 'col139',BU_MARKETER_APPROVAL::string,
    'col140',BU_MARKETER_APPROVER_ID::string, 'col141',BU_MARKETER_APPROVER_NAME::string, 'col142',DISTRIBUTOR_PROJECT_REF::string,
    'col143',DISTRIBUTOR_DEVICE_REF::string, 'col144',BLOCK_DIAGRAM_COMPLETE::string, 'col145',OPPORTUNITY_REGISTRATION_TYPE::string,
    'col146',TRANSFER_STATUS::string, 'col147',DISTRIBUTOR_NOTES::string, 'col148',SPLIT_REVIEW_STATUS::string,
    'col149',LOW_MARGIN_EXCEPTION::string, 'col150',MARGIN_BUCKET::string, 'col151',NPI_STATUS::string, 'col152',NPI_NUMBER::string,
    'col153',NPD_PROJECT_NUMBER::string, 'col154',OPPORTUNITY_LINE_CONTACT::string, 'col155',SIP_REASON::string,
    'col156',DESIGNWIN_REQUEST_STATUS::string, 'col157',CATCHUP_REG::string, 'col158',EFFORT_TIER::string, 'col159',PRODUCT_TIER::string,
    'col160',DESIGNIN_DESIGNWIN_APPROVER::string, 'col161',SOURCE_SYSTEM::string, 'col162',CREATED_ESTIMATED_ANNUAL_BOARDS::string,
    'col163',CREATED_QUANTITY_PER_SYSTEM::string, 'col164',CREATED_TARGET_PRICE_USD::string, 'col165',CREATED_DESIGN_REVENUE_SHARE::string,
    'col166',CREATED_ONSHARE::string, 'col167',CREATED_PROJECT_VALUE_OVER_LIFETIME::string,
    'col168',DIN_ESTIMATED_ANNUAL_BOARDS::string, 'col169',DIN_QUANTITY_PER_SYSTEM::string, 'col170',DIN_TARGET_PRICE_USD::string,
    'col171',DIN_DESIGN_REVENUE_SHARE::string, 'col172',DIN_ONSHARE::string, 'col173',DIN_PROJECT_VALUE_OVER_LIFETIME::string,
    'col174',DWIN_ESTIMATED_ANNUAL_BOARDS::string, 'col175',DWIN_QUANTITY_PER_SYSTEM::string, 'col176',DWIN_TARGET_PRICE_USD::string,
    'col177',DWIN_DESIGN_REVENUE_SHARE::string, 'col178',DWIN_ONSHARE::string, 'col179',DWIN_PROJECT_VALUE_OVER_LIFETIME::string,
    'col180',BIW_INS_DTTM::string, 'col181',BIW_UPD_DTTM::string, 'col182',BIW_BATCH_ID::string,
    'col183',BIW_LOGICAL_DELETE_FLAG::string)::string )::BINARY as BIW_MD5_KEY
FROM FINAL_SQL
