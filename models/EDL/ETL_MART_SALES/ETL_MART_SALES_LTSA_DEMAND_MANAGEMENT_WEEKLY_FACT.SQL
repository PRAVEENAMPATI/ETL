/*---------------------------------------------------------------------------
Command to run model:
--dbt build --select ETL_MART_SALES_LTSA_DEMAND_MANAGEMENT_WEEKLY_FACT

Version     Date            Author               Description
-------     --------        -----------          ----------------------------------
1.0         03/20/2023      Vinay Subramanian    Initial Version
---------------------------------------------------------------------------*/
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['LTSA_DEMAND_MANAGEMENT_WEEKLY_KEY']-%}
{% if is_incremental() %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
--SELECT {{v_md5_column_list}}
{% endif %}

{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_SALES_LTSA_DEMAND_MANAGEMENT_WEEKLY_FACT'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}

{{
    config(
         description = 'Building ETL table FUNNEL_FACT for sales mart'
        ,transient=true
        ,materialized='table'
        ,schema ='ETL_MART_SALES'
        ,alias='LTSA_DEMAND_MANAGEMENT_WEEKLY_FACT'
        ,unique_key= v_pk_list
        ,tags ='MART_SALES_LTSA'
        ,post_hook= [v_sql_upd_success_batch]
        )
}}

WITH 
NEW_LTSA_CALC AS (
SELECT 
    YR AS YEAR_KEY,
    MTH AS MONTH_KEY,
    PART_ID,
    CORP_CD AS CORPORATION_CODE,
    CUR_MTH AS CURRENT_MONTH_KEY,
    FRZ_MTH AS FRZ_MONTH_KEY,
    CRSD_QTY AS CRSD_QUANTITY,
    BILL_QTY AS BILL_QUANTITY,
    MRSD_QTY AS MRSD_QUANTITY,
    BB_QTY AS BB_QUANTITY,
    MRSD_BB_QTY AS MRSD_BB_QUANTITY,
    WORKING_SALES_FCST_QTY AS WORKING_SALES_FCST_QUANTITY,
    CONSENSUS_FCST_QTY AS CONSENSUS_FCST_QUANTITY,
    CUR_LTSA_LIA_QTY AS CUR_LTSA_LIA_QUANTITY,
    LTSA_POR_QTY AS LTSA_POR_QUANTITY,
    LTSA_ORIG_QTY AS LTSA_ORIG_QUANTITY,
    LTSA_STRETCH_QTY AS LTSA_STRETCH_QUANTITY,
    CRSD_AMT AS CRSD_AMOUNT,
    BILL_AMT AS BILL_AMOUNT,
    MRSD_AMT AS MRSD_AMOUNT,
    BB_AMT AS BB_AMOUNT,
    MRSD_BB_AMT AS MRSD_BB_AMOUNT,
    WORKING_SALES_FCST_AMT AS WORKING_SALES_FCST_AMOUNT,
    CONSENSUS_FCST_AMT AS CONSENSUS_FCST_AMOUNT,
    CUR_LTSA_LIA_AMT AS CUR_LTSA_LIA_AMOUNT,
    LTSA_POR_AMT AS LTSA_POR_AMOUNT,
    LTSA_ORIG_AMT AS LTSA_ORIG_AMOUNT,
    LTSA_STRETCH_AMT AS LTSA_STRETCH_AMOUNT,
    NEW_LTSA_LIA_QTY AS NEW_LTSA_LIA_QUANTITY,
    NEW_LTSA_LIA_AMT AS NEW_LTSA_LIA_AMOUNT,
    PART_CORP_ASP,
    PART_CORP_GROSS_ASP,
    PART_CORP_CONTRACT_ASP,
    CUME_BB_QTY AS CUME_BB_QUANTITY,
    CUME_LTSA_POR_QTY AS CUME_LTSA_POR_QUANTITY,
    CUME_LTSA_ORIG_QTY AS CUME_LTSA_ORIG_QUANTITY,
    CUME_LTSA_STRETCH_QTY AS CUME_LTSA_STRETCH_QUANTITY,
    CUME_NEW_LTSA_QTY AS CUME_NEW_LTSA_QUANTITY,
    CUME_MRSD_BB_QTY AS CUME_MRSD_BB_QUANTITY,
    CUME_CUR_LTSA_QTY AS CUME_CUR_LTSA_QUANTITY,
    CUME_BB_AMT AS CUME_BB_AMOUNT,
    CUME_LTSA_POR_AMT AS CUME_LTSA_POR_AMOUNT,
    CUME_LTSA_ORIG_AMT AS CUME_LTSA_ORIG_AMOUNT,
    CUME_LTSA_STRETCH_AMT AS CUME_LTSA_STRETCH_AMOUNT,
    CUME_NEW_LTSA_AMT AS CUME_NEW_LTSA_AMOUNT,
    CUME_MRSD_BB_AMT AS CUME_MRSD_BB_AMOUNT,
    CUME_CUR_LTSA_AMT AS CUME_CUR_LTSA_AMOUNT,
    AGREEMENT_ID,
    GROUP_ID,
    REVIEW_STATUS AS IS_REVIEW_STATUS,
    GRP_CUME_BB_QTY AS GRP_CUME_BB_QUANTITY,
    GRP_CUME_LTSA_POR_QTY AS GRP_CUME_LTSA_POR_QUANTITY,
    GRP_CUME_LTSA_ORIG_QTY AS GRP_CUME_LTSA_ORIG_QUANTITY,
    GRP_CUME_LTSA_STRETCH_QTY AS GRP_CUME_LTSA_STRETCH_QUANTITY,
    GRP_CUME_NEW_LTSA_QTY AS GRP_CUME_NEW_LTSA_QUANTITY,
    GRP_CUME_MRSD_BB_QTY AS GRP_CUME_MRSD_BB_QUANTITY,
    GRP_CUME_CUR_LTSA_QTY AS GRP_CUME_CUR_LTSA_QUANTITY,
    GRP_CUME_BB_AMT AS GRP_CUME_BB_AMOUNT,
    GRP_CUME_LTSA_POR_AMT AS GRP_CUME_LTSA_POR_AMOUNT,
    GRP_CUME_LTSA_ORIG_AMT AS GRP_CUME_LTSA_ORIG_AMOUNT,
    GRP_CUME_LTSA_STRETCH_AMT AS GRP_CUME_LTSA_STRETCH_AMOUNT,
    GRP_CUME_NEW_LTSA_AMT AS GRP_CUME_NEW_LTSA_AMOUNT,
    GRP_CUME_MRSD_BB_AMT AS GRP_CUME_MRSD_BB_AMOUNT,
    GRP_CUME_CUR_LTSA_AMT AS GRP_CUME_CUR_LTSA_AMOUNT,
    BACKLOG_COMPLIANCE_QTY_PCT AS BACKLOG_COMPLIANCE_QUANTITY_PCT,
    BACKLOG_COMPLIANCE_QTY_GAP AS BACKLOG_COMPLIANCE_QUANTITY_GAP,
    SUPPLY_COMPLIANCE_QTY_PCT AS SUPPLY_COMPLIANCE_QUANTITY_PCT,
    SUPPLY_COMPLIANCE_QTY_GAP AS SUPPLY_COMPLIANCE_QUANTITY_GAP,
    BACKLOG_COMPLIANCE_AMT_PCT AS BACKLOG_COMPLIANCE_AMOUNT_PCT,
    BACKLOG_COMPLIANCE_AMT_GAP AS BACKLOG_COMPLIANCE_AMOUNT_GAP,
    SUPPLY_COMPLIANCE_AMT_PCT AS SUPPLY_COMPLIANCE_AMOUNT_PCT,
    SUPPLY_COMPLIANCE_AMT_GAP AS SUPPLY_COMPLIANCE_AMOUNT_GAP,
    GRP_BACKLOG_COMPLIANCE_QTY_PCT AS GRP_BACKLOG_COMPLIANCE_QUANTITY_PCT,
    GRP_BACKLOG_COMPLIANCE_QTY_GAP AS GRP_BACKLOG_COMPLIANCE_QUANTITY_GAP,
    GRP_SUPPLY_COMPLIANCE_QTY_PCT AS GRP_SUPPLY_COMPLIANCE_QUANTITY_PCT,
    GRP_SUPPLY_COMPLIANCE_QTY_GAP AS GRP_SUPPLY_COMPLIANCE_QUANTITY_GAP,
    GRP_BACKLOG_COMPLIANCE_AMT_PCT AS GRP_BACKLOG_COMPLIANCE_AMOUNT_PCT,
    GRP_BACKLOG_COMPLIANCE_AMT_GAP AS GRP_BACKLOG_COMPLIANCE_AMOUNT_GAP,
    GRP_SUPPLY_COMPLIANCE_AMT_PCT AS GRP_SUPPLY_COMPLIANCE_AMOUNT_PCT,
    GRP_SUPPLY_COMPLIANCE_AMT_GAP AS GRP_SUPPLY_COMPLIANCE_AMOUNT_GAP,
    KPI_QTY AS KPI_QUANTITY,
    KPI_AMT AS KPI_AMOUNT,
    GRP_KPI_QTY AS GRP_KPI_QUANTITY,
    GRP_KPI_AMT AS GRP_KPI_AMOUNT,
    SUPPLY_ENTITLEMENT_QTY AS SUPPLY_ENTITLEMENT_QUANTITY,
    SUPPLY_ENTITLEMENT_AMT AS SUPPLY_ENTITLEMENT_AMOUNT,
    GRP_SUPPLY_ENTITLEMENT_QTY AS GRP_SUPPLY_ENTITLEMENT_QUANTITY,
    GRP_SUPPLY_ENTITLEMENT_AMT AS GRP_SUPPLY_ENTITLEMENT_AMOUNT
FROM {{source('STG_PLAN_DM_RFORECASTING','NEW_LTSA_CALC')}}
WHERE 
   BIW_UPD_DTTM = (SELECT MAX(BIW_UPD_DTTM) from {{source('STG_PLAN_DM_RFORECASTING','NEW_LTSA_CALC')}})
   QUALIFY( ROW_NUMBER() OVER (PARTITION BY PART_ID  ,CORP_CD, MTH  ORDER BY BIW_UPD_DTTM DESC) =1)

)
,FISCAL_WEEK AS 
(
    SELECT 
        DISTINCT FISCAL_WEEK_KEY
    FROM 
    {{ref('MART_DATE') }}
    WHERE 
        CALENDAR_DATE = (CURRENT_TIMESTAMP() - INTERVAL '7 HOUR')::DATE
        or CALENDAR_DATE = (CURRENT_TIMESTAMP() -  INTERVAL '30 MINUTE')::DATE
)

SELECT 
    MD5(OBJECT_CONSTRUCT ('COL1',FSC_WK.FISCAL_WEEK_KEY::STRING
                        , 'COL2',STG.PART_ID::STRING
                        , 'COL3',STG.CORPORATION_CODE::STRING
                        , 'COL4',STG.MONTH_KEY::STRING
                        )::STRING) AS LTSA_DEMAND_MANAGEMENT_WEEKLY_KEY,
    FSC_WK.FISCAL_WEEK_KEY AS SNAPSHOT_WEEK_KEY,
    MD5(STG.PART_ID) AS PART_KEY,
    MD5(STG.CORPORATION_CODE) AS CORPORATION_KEY,
    STG.YEAR_KEY,
    STG.MONTH_KEY,
    STG.PART_ID,
    STG.CORPORATION_CODE,
    STG.CURRENT_MONTH_KEY,
    STG.FRZ_MONTH_KEY,
    STG.CRSD_QUANTITY,
    STG.BILL_QUANTITY,
    STG.MRSD_QUANTITY,
    STG.BB_QUANTITY,
    STG.MRSD_BB_QUANTITY,
    STG.WORKING_SALES_FCST_QUANTITY,
    STG.CONSENSUS_FCST_QUANTITY,
    STG.CUR_LTSA_LIA_QUANTITY,
    STG.LTSA_POR_QUANTITY,
    STG.LTSA_ORIG_QUANTITY,
    STG.LTSA_STRETCH_QUANTITY,
    STG.CRSD_AMOUNT,
    STG.BILL_AMOUNT,
    STG.MRSD_AMOUNT,
    STG.BB_AMOUNT,
    STG.MRSD_BB_AMOUNT,
    STG.WORKING_SALES_FCST_AMOUNT,
    STG.CONSENSUS_FCST_AMOUNT,
    STG.CUR_LTSA_LIA_AMOUNT,
    STG.LTSA_POR_AMOUNT,
    STG.LTSA_ORIG_AMOUNT,
    STG.LTSA_STRETCH_AMOUNT,
    STG.NEW_LTSA_LIA_QUANTITY,
    STG.NEW_LTSA_LIA_AMOUNT,
    STG.PART_CORP_ASP,
    STG.PART_CORP_GROSS_ASP,
    STG.PART_CORP_CONTRACT_ASP,
    STG.CUME_BB_QUANTITY,
    STG.CUME_LTSA_POR_QUANTITY,
    STG.CUME_LTSA_ORIG_QUANTITY,
    STG.CUME_LTSA_STRETCH_QUANTITY,
    STG.CUME_NEW_LTSA_QUANTITY,
    STG.CUME_MRSD_BB_QUANTITY,
    STG.CUME_CUR_LTSA_QUANTITY,
    STG.CUME_BB_AMOUNT,
    STG.CUME_LTSA_POR_AMOUNT,
    STG.CUME_LTSA_ORIG_AMOUNT,
    STG.CUME_LTSA_STRETCH_AMOUNT,
    STG.CUME_NEW_LTSA_AMOUNT,
    STG.CUME_MRSD_BB_AMOUNT,
    STG.CUME_CUR_LTSA_AMOUNT,
    STG.AGREEMENT_ID,
    STG.GROUP_ID,
    STG.IS_REVIEW_STATUS,
    STG.GRP_CUME_BB_QUANTITY,
    STG.GRP_CUME_LTSA_POR_QUANTITY,
    STG.GRP_CUME_LTSA_ORIG_QUANTITY,
    STG.GRP_CUME_LTSA_STRETCH_QUANTITY,
    STG.GRP_CUME_NEW_LTSA_QUANTITY,
    STG.GRP_CUME_MRSD_BB_QUANTITY,
    STG.GRP_CUME_CUR_LTSA_QUANTITY,
    STG.GRP_CUME_BB_AMOUNT,
    STG.GRP_CUME_LTSA_POR_AMOUNT,
    STG.GRP_CUME_LTSA_ORIG_AMOUNT,
    STG.GRP_CUME_LTSA_STRETCH_AMOUNT,
    STG.GRP_CUME_NEW_LTSA_AMOUNT,
    STG.GRP_CUME_MRSD_BB_AMOUNT,
    STG.GRP_CUME_CUR_LTSA_AMOUNT,
    STG.BACKLOG_COMPLIANCE_QUANTITY_PCT,
    STG.BACKLOG_COMPLIANCE_QUANTITY_GAP,
    STG.SUPPLY_COMPLIANCE_QUANTITY_PCT,
    STG.SUPPLY_COMPLIANCE_QUANTITY_GAP,
    STG.BACKLOG_COMPLIANCE_AMOUNT_PCT,
    STG.BACKLOG_COMPLIANCE_AMOUNT_GAP,
    STG.SUPPLY_COMPLIANCE_AMOUNT_PCT,
    STG.SUPPLY_COMPLIANCE_AMOUNT_GAP,
    STG.GRP_BACKLOG_COMPLIANCE_QUANTITY_PCT,
    STG.GRP_BACKLOG_COMPLIANCE_QUANTITY_GAP,
    STG.GRP_SUPPLY_COMPLIANCE_QUANTITY_PCT,
    STG.GRP_SUPPLY_COMPLIANCE_QUANTITY_GAP,
    STG.GRP_BACKLOG_COMPLIANCE_AMOUNT_PCT,
    STG.GRP_BACKLOG_COMPLIANCE_AMOUNT_GAP,
    STG.GRP_SUPPLY_COMPLIANCE_AMOUNT_PCT,
    STG.GRP_SUPPLY_COMPLIANCE_AMOUNT_GAP,
    STG.KPI_QUANTITY,
    STG.KPI_AMOUNT,
    STG.GRP_KPI_QUANTITY,
    STG.GRP_KPI_AMOUNT,
    STG.SUPPLY_ENTITLEMENT_QUANTITY,
    STG.SUPPLY_ENTITLEMENT_AMOUNT,
    STG.GRP_SUPPLY_ENTITLEMENT_QUANTITY,
    STG.GRP_SUPPLY_ENTITLEMENT_AMOUNT,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ AS BIW_INS_DTTM,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ AS BIW_UPD_DTTM,
    {{V_BIW_BATCH_ID}}::NUMBER AS BIW_BATCH_ID,
    md5(object_construct ('col1',SNAPSHOT_WEEK_KEY::string, 'col2',PART_KEY::string,
    'col3',CORPORATION_KEY::string, 'col4',YEAR_KEY::string, 'col5',MONTH_KEY::string, 'col6',PART_ID::string,
    'col7',CORPORATION_CODE::string, 'col8',CURRENT_MONTH_KEY::string, 'col9',FRZ_MONTH_KEY::string, 'col10',CRSD_QUANTITY::string,
    'col11',BILL_QUANTITY::string, 'col12',MRSD_QUANTITY::string, 'col13',BB_QUANTITY::string, 'col14',MRSD_BB_QUANTITY::string,
    'col15',WORKING_SALES_FCST_QUANTITY::string, 'col16',CONSENSUS_FCST_QUANTITY::string, 'col17',CUR_LTSA_LIA_QUANTITY::string,
    'col18',LTSA_POR_QUANTITY::string, 'col19',LTSA_ORIG_QUANTITY::string, 'col20',LTSA_STRETCH_QUANTITY::string,
    'col21',CRSD_AMOUNT::string, 'col22',BILL_AMOUNT::string, 'col23',MRSD_AMOUNT::string, 'col24',BB_AMOUNT::string,
    'col25',MRSD_BB_AMOUNT::string, 'col26',WORKING_SALES_FCST_AMOUNT::string, 'col27',CONSENSUS_FCST_AMOUNT::string,
    'col28',CUR_LTSA_LIA_AMOUNT::string, 'col29',LTSA_POR_AMOUNT::string, 'col30',LTSA_ORIG_AMOUNT::string,
    'col31',LTSA_STRETCH_AMOUNT::string, 'col32',NEW_LTSA_LIA_QUANTITY::string, 'col33',NEW_LTSA_LIA_AMOUNT::string,
    'col34',PART_CORP_ASP::string, 'col35',PART_CORP_GROSS_ASP::string, 'col36',PART_CORP_CONTRACT_ASP::string,
    'col37',CUME_BB_QUANTITY::string, 'col38',CUME_LTSA_POR_QUANTITY::string, 'col39',CUME_LTSA_ORIG_QUANTITY::string,
    'col40',CUME_LTSA_STRETCH_QUANTITY::string, 'col41',CUME_NEW_LTSA_QUANTITY::string, 'col42',CUME_MRSD_BB_QUANTITY::string,
    'col43',CUME_CUR_LTSA_QUANTITY::string, 'col44',CUME_BB_AMOUNT::string, 'col45',CUME_LTSA_POR_AMOUNT::string,
    'col46',CUME_LTSA_ORIG_AMOUNT::string, 'col47',CUME_LTSA_STRETCH_AMOUNT::string, 'col48',CUME_NEW_LTSA_AMOUNT::string,
    'col49',CUME_MRSD_BB_AMOUNT::string, 'col50',CUME_CUR_LTSA_AMOUNT::string, 'col51',AGREEMENT_ID::string, 'col52',GROUP_ID::string,
    'col53',IS_REVIEW_STATUS::string, 'col54',GRP_CUME_BB_QUANTITY::string, 'col55',GRP_CUME_LTSA_POR_QUANTITY::string,
    'col56',GRP_CUME_LTSA_ORIG_QUANTITY::string, 'col57',GRP_CUME_LTSA_STRETCH_QUANTITY::string, 'col58',GRP_CUME_NEW_LTSA_QUANTITY::string,
    'col59',GRP_CUME_MRSD_BB_QUANTITY::string, 'col60',GRP_CUME_CUR_LTSA_QUANTITY::string, 'col61',GRP_CUME_BB_AMOUNT::string,
    'col62',GRP_CUME_LTSA_POR_AMOUNT::string, 'col63',GRP_CUME_LTSA_ORIG_AMOUNT::string, 'col64',GRP_CUME_LTSA_STRETCH_AMOUNT::string,
    'col65',GRP_CUME_NEW_LTSA_AMOUNT::string, 'col66',GRP_CUME_MRSD_BB_AMOUNT::string, 'col67',GRP_CUME_CUR_LTSA_AMOUNT::string,
    'col68',BACKLOG_COMPLIANCE_QUANTITY_PCT::string, 'col69',BACKLOG_COMPLIANCE_QUANTITY_GAP::string, 'col70',SUPPLY_COMPLIANCE_QUANTITY_PCT::string,
    'col71',SUPPLY_COMPLIANCE_QUANTITY_GAP::string, 'col72',BACKLOG_COMPLIANCE_AMOUNT_PCT::string, 'col73',BACKLOG_COMPLIANCE_AMOUNT_GAP::string,
    'col74',SUPPLY_COMPLIANCE_AMOUNT_PCT::string, 'col75',SUPPLY_COMPLIANCE_AMOUNT_GAP::string, 'col76',GRP_BACKLOG_COMPLIANCE_QUANTITY_PCT::string,
    'col77',GRP_BACKLOG_COMPLIANCE_QUANTITY_GAP::string, 'col78',GRP_SUPPLY_COMPLIANCE_QUANTITY_PCT::string,
    'col79',GRP_SUPPLY_COMPLIANCE_QUANTITY_GAP::string, 'col80',GRP_BACKLOG_COMPLIANCE_AMOUNT_PCT::string,
    'col81',GRP_BACKLOG_COMPLIANCE_AMOUNT_GAP::string, 'col82',GRP_SUPPLY_COMPLIANCE_AMOUNT_PCT::string,
    'col83',GRP_SUPPLY_COMPLIANCE_AMOUNT_GAP::string, 'col84',KPI_QUANTITY::string, 'col85',KPI_AMOUNT::string, 'col86',GRP_KPI_QUANTITY::string,
    'col87',GRP_KPI_AMOUNT::string, 'col88',SUPPLY_ENTITLEMENT_QUANTITY::string, 'col89',SUPPLY_ENTITLEMENT_AMOUNT::string,
    'col90',GRP_SUPPLY_ENTITLEMENT_QUANTITY::string, 'col91',GRP_SUPPLY_ENTITLEMENT_AMOUNT::string)::string )::BINARY as BIW_MD5_KEY 
FROM     
NEW_LTSA_CALC STG 

CROSS JOIN FISCAL_WEEK FSC_WK


